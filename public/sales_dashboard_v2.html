<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/customer_map.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    table,
    tbody,
    tr {
      background-color: white !important;
      transition: background-color 0.3s;
    }

    body {
      font-family: "PingFang SC", "Helvetica Neue", Helvetica, "Segoe UI", Roboto, Arial, sans-serif;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: auto;
      overflow-y: scroll;
    }

    #inquiryForm {
      font-size: 1rem;
      line-height: 1.5rem;
    }

    #inquiryForm input,
    #inquiryForm select,
    #inquiryForm textarea {
      font-size: 1rem;
      line-height: 1.5rem;
      padding: 0.5rem 0.75rem;

    }

    /* ğŸ¯ é¼ æ ‡æ‚¬åœæ—¶è¾“å…¥æ¡†èƒŒæ™¯å˜åŒ– */
    #inquiryForm input:hover,
    #inquiryForm select:hover,
    #inquiryForm textarea:hover {
      background-color: #f0f9ff;
      transition: background-color 0.2s ease;
    }

    /* ğŸ¯ é¼ æ ‡ç‚¹å‡»æ—¶è¾¹æ¡†æµ®ç°åŠ¨æ„Ÿ */
    #inquiryForm input:focus,
    #inquiryForm select:focus,
    #inquiryForm textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px #bfdbfe;
      background-color: #fff;
    }

    /* ğŸ¯ æ‰€æœ‰æ ¼å­æœ‰å¹³æ»‘åŠ¨ç”» */
    #inquiryForm input,
    #inquiryForm select,
    #inquiryForm textarea {
      transition: all 0.2s ease-in-out;
    }

    /* ğŸ¯ Submit æŒ‰é’®åŠ¨æ•ˆ */
    #inquiryForm button[type="submit"] {
      transition: all 0.2s ease-in-out;
      transform: scale(1);
    }

    #inquiryForm button[type="submit"]:hover {
      background-color: #2563eb;
      transform: scale(1.03);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }


    .row-basic-head td,
    .row-truck-head td,
    .row-wh-head td {
      font-size: 11px;
      letter-spacing: 0.2px;
    }


    /* BASIC åˆå¹¶ NOTE å…è®¸æ¢è¡Œï¼ˆå·²åœç”¨ï¼šæ”¹æˆä¸€è¡Œé¢„è§ˆ + ç‚¹å‡»å¼¹çª—ï¼‰
.row-basic-val td[colspan="8"] {
  white-space: normal !important;
  word-break: break-word;
  line-height: 1.4;
}
*/

    /* è¡¨å¤´è¡Œï¼ˆæ¯ç¥¨é‡å¤çš„é‚£ä¸‰æ¡ headerï¼‰ */
    .row-basic-head td,
    .row-truck-head td,
    .row-wh-head td {
      font-weight: 700;
      white-space: nowrap;
      background: #f3f4f6;
      /* æµ…ç° */
      border-top: 2px solid #9ca3af;
      /* æ¯ä¸ªåŒºå—ä¸Šæ–¹ç²—çº¿ */
    }

    .saved-row .saved-row .action-button,
    .saved-row .checkbox-wrapper {
      opacity: 0.5;
      pointer-events: none;
    }

    .action-button-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0.25rem;
    }

    .action-button {
      height: 1.5rem;
      width: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      background-color: #f1f5f9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.15s ease-in-out;
      transform: scale(1);
      font-size: 1rem;
    }

    .action-button:hover {
      transform: none;
      background-color: #e2e8f0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 0.8rem;
      width: 0.8rem;
    }

    .nowrap-limit {
      white-space: nowrap;
      max-width: 25ch;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* âœ… saved-input åªæ§åˆ¶â€œé”å®š/ç°å­—â€ï¼Œä¸å†æ§åˆ¶èƒŒæ™¯è‰² */
    .saved-input {
      background-color: transparent !important;
      color: #6b7280 !important;
    }


    .low-gp {
      color: red !important;
    }

    #scroll-inner {
      width: fit-content;
      min-width: 100%;
      overflow-x: auto;
      overflow-y: visible;
    }

    #main-content {
      padding: 0.125rem;
      position: relative;
      z-index: 1000;
    }

    .header-section {
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 0.25rem;
    }

    select,
    input,
    textarea,
    button {
      margin-right: 0.5rem;
      padding: 0.25rem;
    }

    .main-button {
      color: white;
      background: linear-gradient(to bottom right, #3b82f6, #2563eb);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      font-weight: 700;
      min-width: 6rem;
      text-align: center;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .main-button:hover {
      background: linear-gradient(to bottom right, #2563eb, #1d4ed8);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .price-input {
      width: 3rem;
      height: 1rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.4rem;
      text-align: right;
    }

    .form-group {
      max-height: 75vh;
      overflow-y: auto;
      overflow-x: hidden;
      transition: max-height 0.4s ease;
    }


    .toggle-inquiry {
      position: fixed;
      top: 80px;
      right: 20px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 0.4rem 1rem;
      font-size: 0.75rem;
      cursor: pointer;
      z-index: 100;
    }

    tr.highlighted {
      background-color: #dbeafe !important;
    }

    tr.highlighted-sourcing {
      background-color: #fef9c3 !important;
    }

    tr.highlighted td {
      border: 1px solid #d1d5db;
    }

    tr.highlighted td {
      background-color: #dbeafe !important;
    }


    #inquiryForm input:not([type='checkbox']),
    #inquiryForm select,
    #inquiryForm textarea {
      text-align: left !important;
    }

    input[type='text'],
    input[type='number'] {
      padding-right: 0.4rem;
    }

    input.price-input {
      text-align: right !important;
    }

    td[data-field='GP'],
    td[data-field='Adjusted GP'] {
      font-size: 0.875rem;
      height: 2.25rem;
      vertical-align: middle;
      padding: 0.25rem 0.5rem;
      text-align: right;
    }

    tr.bg-blue-100 td {
      border: 1px solid #d1d5db;
    }

    td[data-field="Note"] {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 30ch;
      text-align: left !important;
      padding: 0.25rem;
    }

    #noteModalInput {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
      line-height: 1.5;
      width: 100%;
      max-width: 100%;
    }


    tr {
      transition: background-color 0.3s;
    }

    table {
      background-color: white;
    }

    th {
      background-color: lightgray;
    }

    body.no-body-scroll {
      overflow: hidden;
    }

    /* V2 Warehouse Requirement block */
    .section-title {
      font-weight: 700;
      color: #111827;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .tiny-note {
      font-size: 0.75rem;
      color: #6b7280;
    }

    /* å›ºå®šæ¯ä¸€è¡Œçš„åŸºç¤é«˜åº¦ï¼ˆä½ å¯æ”¹ 44/48ï¼‰ */
    #summaryBody tr {
      height: 26px;
    }


    /* ===== FINAL: Auto width by content + adjustable NOTE ===== */
    :root {
      --noteWidth: 520px;
    }


    /* å¼ºåˆ¶ Note Modal æ°¸è¿œå±…ä¸­ä¸”è¦†ç›–å…¨å± */
    #noteModal {
      position: fixed !important;
      inset: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 99999 !important;
    }

    /* éšè—çŠ¶æ€ä»ç„¶ hidden */
    #noteModal.hidden {
      display: none !important;
    }

    /* å¼¹çª—ç›’å­é™åˆ¶å¤§å°å¹¶å±…ä¸­ */
    #noteModal>div {
      max-width: min(720px, 92vw) !important;
      max-height: 80vh !important;
      overflow: auto !important;
    }

    .header-section {
      position: relative;
      z-index: 9999;
    }

    /* ç»Ÿä¸€è¡¨æ ¼è¡Œé«˜åº¦ */
    #summaryTable td,
    #summaryTable th {
      padding-top: 6px !important;
      padding-bottom: 6px !important;
      line-height: 1.2 !important;
    }



    /* ä»…ç”¨äº Commodity / From / Toï¼šæ ¹æ®å†…å®¹è‡ªåŠ¨å˜å®½ï¼ˆä¼šæ’‘åˆ—ï¼‰ */
    #summaryTable input.auto-grow {
      width: auto !important;
      /* å…³é”®ï¼šä¸è¦ 100% */
      min-width: 6ch !important;
      /* èµ·æ­¥å®½åº¦ */
      box-sizing: content-box !important;
    }

    /* input è´´æ»¡æ ¼å­ï¼Œä½†ä¸æŠŠåˆ—æ’‘å®½ */
    #summaryTable input {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    /* Commodity / From / To å…è®¸è‡ªåŠ¨æ’‘åˆ— */
    #summaryTable input.auto-grow {
      width: auto !important;
      max-width: none !important;
      min-width: 6ch !important;
      box-sizing: content-box !important;
    }

    /* ===== Alignment Reset (final override) ===== */

    /* 1) æ‰€æœ‰è¡¨å¤´å†…å®¹å±…ä¸­ */
    #summaryTable th,
    #summaryTable .row-basic-head td,
    #summaryTable .row-truck-head td,
    #summaryTable .row-wh-head td {
      text-align: center !important;
    }

    /* 2) æ‰€æœ‰å¡«å†™å†…å®¹é»˜è®¤å±…ä¸­ï¼ˆæ–‡å­—ä¸è¾“å…¥æ¡†ï¼‰ */
    #summaryTable td {
      text-align: center !important;
    }

    #summaryTable input,
    #summaryTable textarea,
    #summaryTable select {
      text-align: center !important;
    }

    /* 3) FROM & TO å¡«å†™å†…å®¹é å³ï¼ˆä»… BASIC ç¬¬äºŒè¡Œçš„ inq-fieldï¼‰ */
    #summaryTable input.inq-field[data-key="From"],
    #summaryTable input.inq-field[data-key="To"] {
      text-align: right !important;
    }

    /* 4) NOTE å†…å®¹å±…å·¦ï¼ˆå« GENERAL NOTE / WAREHOUSE NOTE å±•ç¤ºæ ¼ï¼‰ */
    #summaryTable td.note-preview,
    #summaryTable td.note-block {
      text-align: left !important;
    }

    /* 5) æ‰€æœ‰ COST & PRICE åŠ GP é å³ */
    /* 5.1 æ‰€æœ‰å¸¦ data-field çš„è¾“å…¥æ¡†ï¼šCost/Price/GP ç»Ÿä¸€é å³ */
    #summaryTable input[data-field*="Cost"],
    #summaryTable input[data-field*="Price"],
    #summaryTable input[data-field*="GP"] {
      text-align: right !important;
    }

    /* 5.2 TRUCK/WH æ•°å­—å±•ç¤ºå•å…ƒæ ¼ï¼ˆé input çš„çº¯æ•°å­—ï¼‰ä¹Ÿé å³ */
    #summaryTable tr.row-truck-val td,
    #summaryTable tr.row-wh-val td {
      text-align: right !important;
    }

    /* ä½†ï¼šTRUCK/WH é‡Œ NOTE ä»è¦é å·¦ã€Action ä»å±…ä¸­ã€Carrier/Vendor ä»å±…ä¸­ */
    #summaryTable tr.row-truck-val td.note-preview,
    #summaryTable tr.row-wh-val td.note-preview,
    #summaryTable tr.row-truck-val td.note-block,
    #summaryTable tr.row-wh-val td.note-block {
      text-align: left !important;
    }

    #summaryTable tr.row-truck-val td:last-child,
    #summaryTable tr.row-wh-val td:last-child {
      text-align: center !important;
    }

    #summaryTable input[data-field="Carrier"],
    #summaryTable input[data-field="Vendor"] {
      text-align: center !important;
    }

    /* BASIC ç¬¬äºŒè¡Œ input é»˜è®¤å®Œå…¨é€æ˜ */
    #summaryTable tr.row-basic-val input.inq-field {
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }

    /* è®©æ–‡å­—å¯¹é½ä¸€è‡´ */
    #summaryTable tr.row-basic-val input.inq-field:disabled {
      color: inherit !important;
      cursor: default;
    }

    /* ===== BASIC ç¬¬äºŒè¡Œå¯¹é½è§„åˆ™ ===== */

    /* é»˜è®¤ï¼šå…¨éƒ¨å±…ä¸­ */
    #summaryTable tr.row-basic-val td {
      text-align: center !important;
    }

    /* Commodityï¼šå†…å®¹å±…ä¸­ */
    #summaryTable tr.row-basic-val td[data-field="Commodity"] {
      text-align: center !important;
    }

    #summaryTable tr.row-basic-val td[data-field="Commodity"] input {
      text-align: center !important;
    }

    /* From / Toï¼šå†…å®¹é å³ */
    #summaryTable tr.row-basic-val td[data-field="From"],
    #summaryTable tr.row-basic-val td[data-field="To"] {
      text-align: right !important;
    }

    #summaryTable tr.row-basic-val td[data-field="From"] input,
    #summaryTable tr.row-basic-val td[data-field="To"] input {
      text-align: right !important;
    }

    /* é¡µé¢æ•´ä½“é“ºæ»¡ */
    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    /* Summary å®¹å™¨é“ºæ»¡ */
    .container,
    .main-container,
    .wrapper,
    .page-container {
      width: 100% !important;
      max-width: 100% !important;
    }

    #summaryTable {
      width: 100% !important;
    }

    #summaryTable-wrapper,
    .summary-wrapper,
    .table-wrapper {
      width: 100% !important;
    }

    /* âœ… è®© Summary çœŸæ­£å æ»¡å‰©ä½™é«˜åº¦ï¼ˆæ¶ˆç­åº•éƒ¨ç©ºç™½ï¼‰ */
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      overflow: auto;
      /* âœ… é¡µé¢æ»šåŠ¨æ¡å›æ¥ */
      /* æˆ–è€…ï¼šoverflow-y: auto; overflow-x: auto; */
    }


    /* é¡¶éƒ¨åŒºåŸŸï¼ˆæ ‡é¢˜+æŒ‰é’®+è¡¨å•ï¼‰å å†…å®¹é«˜åº¦ */
    #main-content {
      flex: 0 0 auto;
    }

    /* è¡¨æ ¼åŒºåŸŸå æ»¡å‰©ä½™é«˜åº¦ */
    #fixed-scroll-wrapper {
      flex: 1 1 auto;
      min-height: 0;
      /* å…³é”®ï¼šå…è®¸å†…éƒ¨æ»šåŠ¨ */
      height: auto !important;
      max-height: none !important;

      margin: 0 !important;
      /* å»æ‰ 1remï¼Œé¿å…ç•™ç™½ */
      border-left: 0 !important;
      border-right: 0 !important;
      border-bottom: 0 !important;
      border-top: 1px solid #d1d5db !important;

      overflow: auto !important;
    }

    #formGroup #submitInquiryBtn {
      position: relative;
      /* æˆ– static */
      bottom: auto;
    }

    .main-button {
      min-width: 180px !important;
      /* å¼ºåˆ¶æœ€å°å®½åº¦ï¼Œé˜²æ­¢å˜å¤ªå° */
      white-space: nowrap;
    }

    #formGroup {
      padding: 1rem;
      /* ç»™ formGroup åŠ å†…è¾¹è·ï¼Œé¿å…è´´è¾¹ */
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      /* å¯é€‰ï¼šåŠ ç‚¹é˜´å½±åŒºåˆ† */
    }

    /* Summary åŒºåŸŸå›ºå®šé“ºæ»¡å±å¹•å‰©ä½™ç©ºé—´ï¼Œåº•éƒ¨æ»šåŠ¨æ¡åœ¨è§†çª—åº•éƒ¨ */
    :root {
      --topBarH: 78px;
    }

    /* é¡¶éƒ¨æŒ‰é’®æ é«˜åº¦ï¼Œå¿…è¦æ—¶å¾®è°ƒ */

    /* ===== Mode: INQUIRY (default) ===== */
    body.mode-inquiry {
      display: block !important;
      overflow: auto !important;
      background: #f9fafb !important;
    }

    body.mode-inquiry #formGroup {
      display: block !important;
    }

    body.mode-inquiry #fixed-scroll-wrapper {
      display: none !important;
    }

    /* ===== Mode: SUMMARY ===== */
    body.mode-summary {
      overflow: hidden !important;
      /* é¡µé¢ä¸æ»šï¼Œæ»šåŠ¨äº¤ç»™è¡¨æ ¼å®¹å™¨ */
    }

    body.mode-summary #formGroup {
      display: none !important;
    }

    body.mode-summary #fixed-scroll-wrapper {
      display: block !important;
      position: fixed !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      top: var(--topBarH) !important;
      margin: 0 !important;
      max-height: none !important;
      overflow: auto !important;
      /* âœ… æ¨ªå‘æ»šåŠ¨æ¡å›ºå®šåœ¨å±å¹•åº•éƒ¨ */
      border-top: 1px solid #d1d5db !important;
    }

    /* ===== Inquiry æ¨¡å¼ï¼šå½»åº•å–æ¶ˆæ—§çš„ flex/å ä½è§„åˆ™ ===== */
    body.mode-inquiry {
      display: block !important;
      /* å–æ¶ˆ body:flex */
      overflow: auto !important;
      /* é¡µé¢è‡ªå·±æ»šåŠ¨ */
      background: #ffffff !important;
      /* é¿å…ç°åº• */
    }

    /* Summary wrapper åœ¨ Inquiry æ¨¡å¼å½»åº•ä¸å ä½ */
    body.mode-inquiry #fixed-scroll-wrapper {
      display: none !important;
      position: static !important;
      height: 0 !important;
      max-height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
      border: 0 !important;
    }

    /* è®© Inquiry åŒºåŸŸâ€œè‡³å°‘â€æ’‘æ»¡ä¸€å±ï¼ˆä¸ä¼šå‡ºç°åº•éƒ¨ç©ºæ´ï¼‰ */
    body.mode-inquiry #main-content {
      min-height: calc(100vh - var(--topBarH, 78px)) !important;
      background: #ffffff !important;
    }

    /* è®©è¡¨å•å—è‡ªå·±æŠŠå‰©ä½™ç©ºé—´åƒæ‰ï¼ˆåº•éƒ¨ä¸ç•™ç°ï¼‰ */
    body.mode-inquiry #formGroup {
      min-height: calc(100vh - var(--topBarH, 78px) - 24px) !important;
    }

    /* =========================
   FINAL COLORS (INPUT-ONLY until CONFIRMED)
   ========================= */

    /* è¡¨å¤´ç»Ÿä¸€æµ…ç° */
    #summaryTable tr.row-basic-head td,
    #summaryTable tr.row-truck-head td,
    #summaryTable tr.row-wh-head td {
      background: #f3f4f6 !important;
      font-weight: 700;
    }

    /* é»˜è®¤ï¼švalues è¡ŒèƒŒæ™¯ä¿æŒç™½/å¾ˆæ·¡ç°ï¼ˆä¸åšåŒºå—æŸ“è‰²ï¼‰ */
    #summaryTable tr.row-truck-val td,
    #summaryTable tr.row-wh-val td {
      background: #ffffff !important;
    }

    /* é»˜è®¤ input ç™½è‰² */
    #summaryTable tr.row-truck-val input,
    #summaryTable tr.row-wh-val input {
      background: #ffffff !important;
      border-color: #e5e7eb !important;
    }

    /* âœ… æ”¶åˆ° COSTï¼šåªæŸ“ input æé»„ï¼ˆæé†’ Salesï¼‰ï¼Œtd èƒŒæ™¯ä¸å˜ */
    #summaryTable tr.cost-received.row-truck-val input,
    #summaryTable tr.cost-received.row-wh-val input {
      background: #fcf7eb !important;
      border-color: #f1d6a8 !important;
    }

    /* SAVE çŠ¶æ€ï¼šæ•´è¡Œææ·¡ç°è“ */

    #summaryTable tr.saved-price td {
      background: #f3f6fb !important;
    }

    /* input ä¿æŒé€æ˜ï¼Œé¿å…â€œæ ¼å­æ„Ÿâ€ */
    #summaryTable tr.saved-price input {
      background: transparent !important;
      border-color: #e5e7eb !important;
    }

    /* âœ… CHECK åï¼šæ•´è¡Œé”å®šè“ï¼ˆè¿™æ—¶æ‰æŸ“ td èƒŒæ™¯ï¼‰ */
    #summaryTable tr.row-confirmed td {
      background: #cfe8ff !important;
    }

    #summaryTable tr.row-confirmed td input {
      background: #cfe8ff !important;
      border-color: #b6dcff !important;
    }


    /* =========================
   MANAGER THEME OVERRIDE for SALES
   Paste at VERY END of Sales <style>
   ========================= */

    /* Base */
    #summaryTable {
      width: 100% !important;
      background: #fff !important;
    }

    #summaryTable td,
    #summaryTable th {
      padding: 4px 6px !important;
      line-height: 1.1 !important;
      border-right: 1px solid #f3f4f6 !important;
    }

    /* Header rows (Row 1/3/5) taller */
    #summaryTable tr.row-basic-head td,
    #summaryTable tr.row-truck-head td,
    #summaryTable tr.row-wh-head td {
      background: #f3f4f6 !important;
      font-weight: 700 !important;
      white-space: nowrap !important;
      text-align: center !important;
      padding-top: 7px !important;
      padding-bottom: 7px !important;
      line-height: 1.25 !important;
    }

    #summaryTable tr.row-basic-head td {
      padding-top: 9px !important;
      padding-bottom: 9px !important;
    }

    /* Inputs */
    #summaryTable input {
      width: 100% !important;
      box-sizing: border-box !important;
      border: 1px solid #e5e7eb !important;
      padding: 2px 4px !important;
      font-size: 12px !important;
      height: 20px !important;
      background: #fff !important;
      text-align: right !important;
    }

    #summaryTable input[data-field="Carrier"],
    #summaryTable input[data-field="Vendor"] {
      text-align: center !important;
    }

    /* States (same as Manager) */
    #summaryTable tr.cost-received.row-truck-val input,
    #summaryTable tr.cost-received.row-wh-val input {
      background: #fcf7eb !important;
      border-color: #f1d6a8 !important;
    }

    /* SAVE = whole row light gray-blue (NOT per cell) */
    #summaryTable tr.saved-price td {
      background: #f3f6fb !important;
    }

    #summaryTable tr.saved-price input {
      background: transparent !important;
      border-color: #e5e7eb !important;
    }

    /* CONFIRMED = whole row blue */
    #summaryTable tr.row-confirmed td {
      background: #cfe8ff !important;
    }

    #summaryTable tr.row-confirmed td input {
      background: #cfe8ff !important;
      border-color: #b6dcff !important;
    }

    /* Sub rows: same font as main (no italic, no gray) */
    .sub-row {
      background: transparent !important;
      font-style: normal !important;
      color: inherit !important;
    }

    .sub-row td:first-child {
      padding-left: 0 !important;
      text-align: center !important;
    }

    /* Action buttons: Manager sizing */
    .action-button-row {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px !important;
      white-space: nowrap !important;
    }

    .action-button {
      width: 26px !important;
      height: 26px !important;
      font-size: 16px !important;
      line-height: 1 !important;
      border-radius: 6px !important;
      background: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;
    }

    .action-button:hover {
      background: #e2e8f0 !important;
    }

    /* Sticky # / ACTION columns locked to same gray */
    :root {
      --sticky-gray: #e5e7eb;
      --sticky-divider: #d1d5db;
    }


    /* Hover: light, but keep confirmed color */
    #summaryTable tr:hover td {
      background-color: #f9fafb !important;
    }

    #summaryTable tr.row-confirmed:hover td {
      background: #cfe8ff !important;
    }


    #fixed-scroll-wrapper {
      margin: 0 !important;
      border-top: 1px solid #d1d5db !important;
      border-left: 0 !important;
      border-right: 0 !important;
      border-bottom: 0 !important;
      overflow: auto !important;
    }

    /* =========================
   SALES: 3D BLOCK BORDER (NO SHADOW, NO CLIP)
   Paste at VERY END of <style>
   ========================= */

    /* è®©è¡¨æ ¼æ›´é€‚åˆåšâ€œå—çŠ¶è¾¹â€ */
    #summaryTable {
      border-collapse: separate !important;
      border-spacing: 0 !important;
    }

    /* é¡¶éƒ¨ï¼šæ¯ç¥¨å¼€å§‹çš„ header åšâ€œ3D å‹è¾¹â€ï¼ˆç”¨æ¸å˜+é«˜å…‰çº¿ï¼Œä¸é é˜´å½±ï¼‰ */
    #summaryTable tr.row-basic-head td {
      border-top: 4px solid #cfd6dd !important;

      /* å…³é”®ï¼šç”¨ä¸¤æ¡çº¿åšç«‹ä½“æ„Ÿï¼ˆä¸æ€• overflow è£åˆ‡ï¼‰ */
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9), inset 0 -1px 0 rgba(0, 0, 0, 0.06) !important;
    }

    /* =========================
   FINAL: Quotation 3D Border (KEEP ONLY THIS)
   ========================= */

    /* è®©å—è¾¹æ›´å¹²å‡€ */
    #summaryTable {
      border-collapse: separate !important;
      border-spacing: 0 !important;
    }

    /* â‘  æ¯ç¥¨é¡¶éƒ¨ï¼šç”¨ border + å†…é«˜å…‰/å†…é˜´å½± åšâ€œå‹è¾¹â€ */
    #summaryTable tr.row-basic-head td {
      border-top: 5px solid #cfd6dd !important;
      background: #f3f4f6 !important;

      /* ç«‹ä½“æ„Ÿ = ä¸Šé«˜å…‰ + ä¸‹é˜´å½±ï¼ˆinset ä¸ä¼šè¢« overflow è£åˆ‡ï¼‰ */
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.95),
        inset 0 -1px 0 rgba(0, 0, 0, 0.10) !important;
    }

    /* sticky ä¸¤ä¾§ä¹Ÿå¿…é¡»åŒä¸€æ¡é¡¶è¾¹ï¼Œå¦åˆ™ä¼šæ–­ */
    #summaryTable tr.row-basic-head td:first-child,
    #summaryTable tr.row-basic-head td:last-child {
      border-top: 5px solid #cfd6dd !important;
    }

    /* ===== Fix ugly top edge above table ===== */

    /* 1) å–æ¶ˆè¡¨æ ¼å®¹å™¨çš„ä¸Šè¾¹çº¿ï¼ˆé¿å…å’Œ header-section å çº¿ï¼‰ */
    #fixed-scroll-wrapper {
      border-top: 0 !important;
    }

    /* 2) é¡¶éƒ¨æ åªä¿ç•™ä¸€æ¡å¾ˆç»†çš„åº•çº¿ */
    .header-section {
      border-bottom: 1px solid #e5e7eb !important;
    }

    /* 3) è¡¨å¤´åŒºåŸŸåšæˆâ€œå¹²å‡€çš„æ¡â€ï¼Œå¹¶ç”¨é˜´å½±ä»£æ›¿ç²—è¾¹æ¡† */
    #summaryTable thead {
      background: #f3f4f6 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08) !important;
      /* ç«‹ä½“ä½†ä¸è„ */
    }

    /* 4) æ¸…æ‰ thead é‡Œæ¯æ ¼è‡ªå·±çš„ top borderï¼ˆå¦åˆ™ä¼šå‡ºç°åˆ†æ®µæ„Ÿï¼‰ */
    #summaryTable thead th,
    #summaryTable thead td {
      border-top: 0 !important;
    }

    /* ===== SALES: Sticky # + ACTION always same clean gray ===== */
    :root {
      --sticky-gray: #e5e7eb;
      --sticky-divider: #d1d5db;
    }

    #summaryTable th:first-child,
    #summaryTable td:first-child,
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      background: var(--sticky-gray) !important;
      background-image: none !important;
      border: 0 !important;
      /* æ¸…æ‰ Tailwind .border åˆ‡å‰²æ„Ÿ */
      box-shadow: none !important;
    }

    /* left */
    #summaryTable th:first-child,
    #summaryTable td:first-child {
      position: sticky !important;
      left: 0 !important;
      z-index: 9999 !important;
      width: 10ch !important;
      min-width: 10ch !important;
      max-width: 10ch !important;
      text-align: center !important;
      box-shadow: inset -1px 0 0 var(--sticky-divider), 6px 0 10px -10px rgba(0, 0, 0, .25) !important;
    }

    /* right */
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      position: sticky !important;
      right: 0 !important;
      z-index: 9999 !important;
      width: 110px !important;
      min-width: 110px !important;
      max-width: 110px !important;
      text-align: center !important;
      padding-left: 6px !important;
      padding-right: 6px !important;
      box-shadow: inset 1px 0 0 var(--sticky-divider), -6px 0 10px -10px rgba(0, 0, 0, .25) !important;
    }


    /* ===== SALES: smaller action buttons ===== */
    .action-button {
      width: 24px !important;
      height: 24px !important;
      font-size: 14px !important;
      border-radius: 6px !important;
      box-shadow: none !important;
      /* å»æ‰é‡é˜´å½±ä¼šæ›´ç²¾è‡´ */
    }

    .action-button-row {
      gap: 5px !important;
    }

    /* ===== SALES: EDITING row should look like COST received (apricot) ===== */
    #summaryTable tr.editing-row td {
      background: #fcf7eb !important;
    }

    #summaryTable tr.editing-row td input {
      background: #fcf7eb !important;
      border-color: #f1d6a8 !important;
    }

    /* ä¸¤ä¾§ sticky ä»ä¿æŒç°è‰²ï¼Œä¸è·Ÿç€å˜æè‰² */
    #summaryTable tr.editing-row td:first-child,
    #summaryTable tr.editing-row td:last-child {
      background: var(--sticky-gray) !important;
    }

    /* =========================
   FORCE ACTION COLUMN ONE SOLID COLOR
   ========================= */

    :root {
      --action-gray: #e5e7eb;
      --action-divider: #d1d5db;
    }

    /* æ— è®ºä»»ä½•çŠ¶æ€ï¼ŒACTION æ°¸è¿œåŒä¸€ç°è‰² */
    #summaryTable td:last-child,
    #summaryTable th:last-child {
      background: var(--action-gray) !important;
      background-image: none !important;
      border: 0 !important;
      box-shadow: inset 1px 0 0 var(--action-divider) !important;
    }

    /* å»æ‰ ACTION é‡Œé¢çš„å°é˜´å½±å— */
    #summaryTable td:last-child .action-button {
      box-shadow: none !important;
    }

    /* ===== Make header rows darker (match sticky tone) ===== */

    #summaryTable tr.row-basic-head td,
    #summaryTable tr.row-truck-head td,
    #summaryTable tr.row-wh-head td {
      background: #e5e7eb !important;
      /* åŸæ¥ #f3f4f6 å¤ªæµ… */
      border-top: 3px solid #cfd6dd !important;
    }

    /* ===== FINAL: force SAVE row color (must be LAST) ===== */
    #summaryTable tr.saved-price.row-truck-val td,
    #summaryTable tr.saved-price.row-wh-val td {
      background: #f3f6fb !important;
    }

    /* SAVE çŠ¶æ€ä¸‹ input é€æ˜ï¼Œé¿å…æ ¼å­æ„Ÿ */
    #summaryTable tr.saved-price.row-truck-val td input,
    #summaryTable tr.saved-price.row-wh-val td input {
      background: transparent !important;
      border-color: #e5e7eb !important;
    }

    /* ç¡®ä¿ SAVE åä¸å†ä¿æŒ editing æè‰² */
    #summaryTable tr.saved-price.editing-row td,
    #summaryTable tr.saved-price.editing-row td input {
      background: #f3f6fb !important;
    }

    /* ===== SALES: match MANAGER compact density ===== */

    /* è¡¨å•å­—ä½“æ›´ç´§å‡‘ */
    #inquiryForm {
      font-size: 0.90rem !important;
      line-height: 1.20rem !important;
    }

    /* è¾“å…¥æ¡†å‹ç¼© */
    #inquiryForm input,
    #inquiryForm select,
    #inquiryForm textarea {
      padding: 0.35rem 0.6rem !important;
      font-size: 0.9rem !important;
      line-height: 1.2rem !important;
    }

    /* è¡¨å•å—ä¹‹é—´å‡å°‘é—´è· */
    .form-group {
      margin-bottom: 0.15rem !important;
    }

    /* Warehouse Services è¡Œæ›´ç´§å‡‘ */
    #inquiryForm .grid>div {
      margin-bottom: 0.2rem !important;
    }

    /* Section æ ‡é¢˜æ›´è´´è¿‘ */
    .section-title {
      margin-top: 0.35rem !important;
      margin-bottom: 0.15rem !important;
    }

    /* ===== SALES: make topbar compact like MANAGER ===== */

    /* é¡¶éƒ¨æ•´ä½“æ›´ç´§å‡‘ */
    .header-section {
      padding-top: 6px !important;
      padding-bottom: 6px !important;
    }

    /* è®©æŒ‰é’®ä¸è¦é‚£ä¹ˆâ€œèƒ–â€ */
    .header-section .main-button {
      min-width: 6rem !important;
      /* å…³é”®ï¼šå¹²æ‰ä½ ä¹‹å‰å¼ºåˆ¶çš„ 180px */
      padding: 0.42rem 0.9rem !important;
      /* å˜ç´§å‡‘ */
      font-size: 0.82rem !important;
    }

    /* Search input ç´§å‡‘ä¸€ç‚¹ */
    #searchBox {
      height: 38px !important;
      padding-top: 0.35rem !important;
      padding-bottom: 0.35rem !important;
      font-size: 0.85rem !important;
    }

    /* é¡¶éƒ¨è¿™æ’å…ƒç´ åˆ«æ¢è¡Œï¼ˆä¿æŒä¸€æ¡çº¿å¥½çœ‹ï¼‰ */
    .header-section>div {
      flex-wrap: nowrap !important;
      gap: 8px !important;
    }

    /* ===== Compact Warehouse Services block ===== */

    /* æ•´ä¸ª Warehouse Requirement åŒºåŸŸæ›´ç´§å‡‘ */
    #inquiryForm .section-title {
      margin-top: 6px !important;
      margin-bottom: 4px !important;
    }

    /* ä¸‰åˆ—ä¹‹é—´é—´è·ç¼©å° */
    #inquiryForm .grid {
      column-gap: 20px !important;
      /* åŸæ¥é€šå¸¸ 32~40 */
      row-gap: 6px !important;
    }

    /* æ¯ä¸ª checkbox è¡Œæ›´ç´§å‡‘ */
    #inquiryForm .grid>div {
      margin-bottom: 6px !important;
    }

    /* checkbox å’Œæ–‡å­—ä¹‹é—´é—´è· */
    #inquiryForm .grid label {
      margin-right: 6px !important;
      font-size: 0.9rem !important;
    }

    /* Qty / Unit è¾“å…¥æ¡†ç¼©å° */
    #inquiryForm .grid input {
      height: 26px !important;
      padding: 2px 6px !important;
      font-size: 0.85rem !important;
    }

    /* å° checkbox ç¨å¾®å¯¹é½ */
    #inquiryForm input[type="checkbox"] {
      transform: scale(0.9);
      margin-right: 6px;
    }

    /* ===== Top bar horizontal breathing space ===== */

    .header-section {
      padding-left: 24px !important;
      /* â‰ˆ ä¸¤ä¸ªä¸­æ–‡å­—å®½åº¦ */
      padding-right: 24px !important;
    }

    #summaryTable td.note-preview .note-line {
      display: block;
      max-width: 360px;
      /* âœ… 520 -> 360 (æ›´çŸ­) */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #summaryTable td.spacer-col,
    #summaryTable th.spacer-col {
      width: 6px !important;
      /* âœ… 14 -> 6 */
      min-width: 6px !important;
      max-width: 6px !important;
      padding: 0 !important;
      /* âœ… æ›´å½»åº• */
      overflow: hidden !important;
      white-space: nowrap !important;
    }

    /* =========================
   QUOTATION BLOCK BORDER (Sales)
   Like Manager: each quotation framed
   Paste at VERY END of <style>
   ========================= */

    :root {
      --quote-border: #cfd6dd;
    }


    /* 1) å¼ºåˆ¶ä¸¤ä¾§åº•è‰²ä¸€è‡´ï¼ˆä»»ä½•çŠ¶æ€éƒ½ä¸èƒ½æ”¹ï¼‰ */
    #summaryTable th:first-child,
    #summaryTable td:first-child,
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      background: var(--sticky-gray) !important;
      background-image: none !important;
    }

    /* 2) å·¦ä¾§ # æ ï¼šæ›´ç«‹ä½“çš„åˆ†éš”ï¼ˆå³ä¾§å†…çº¿ + å¤–ä¾§é˜´å½±ï¼‰ */
    #summaryTable th:first-child,
    #summaryTable td:first-child {
      box-shadow:
        inset -2px 0 0 var(--sticky-divider),
        8px 0 14px -12px var(--sticky-shadow) !important;
    }

    /* 3) å³ä¾§ ACTION æ ï¼šæ›´ç«‹ä½“çš„åˆ†éš”ï¼ˆå·¦ä¾§å†…çº¿ + å¤–ä¾§é˜´å½±ï¼‰ */
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      box-shadow:
        inset 2px 0 0 var(--sticky-divider),
        -8px 0 14px -12px var(--sticky-shadow) !important;
    }

    /* 4) æ— è®º hover / confirmed / saved / cost-received / editingï¼Œéƒ½ä¸èƒ½æ±¡æŸ“ä¸¤ä¾§ */
    #summaryTable tr:hover td:first-child,
    #summaryTable tr:hover td:last-child,
    #summaryTable tr.row-confirmed td:first-child,
    #summaryTable tr.row-confirmed td:last-child,
    #summaryTable tr.saved-price td:first-child,
    #summaryTable tr.saved-price td:last-child,
    #summaryTable tr.cost-received td:first-child,
    #summaryTable tr.cost-received td:last-child,
    #summaryTable tr.editing-row td:first-child,
    #summaryTable tr.editing-row td:last-child,
    #summaryTable tr.sub-row td:first-child,
    #summaryTable tr.sub-row td:last-child {
      background: var(--sticky-gray) !important;
      background-image: none !important;
    }

    /* 5) ACTION é‡Œé¢æŒ‰é’®åŒºåŸŸä¹Ÿç»Ÿä¸€ï¼ˆé¿å…æ¯æ ¼åƒä¸€å—å—ï¼‰ */
    #summaryTable td:last-child {
      padding-left: 6px !important;
      padding-right: 6px !important;
    }

    #summaryTable td:last-child .action-button {
      background: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;
      box-shadow: none !important;
    }

    /* =========================
   CLEAN BORDER SYSTEM (Final)
   ========================= */

    /* è¡¨æ ¼ç”¨ collapseï¼Œç»Ÿä¸€çº¿æ¡ */
    #summaryTable {
      border-collapse: collapse !important;
    }

    /* æ‰€æœ‰å•å…ƒæ ¼ç»Ÿä¸€ 1px ç»†çº¿ */
    #summaryTable td,
    #summaryTable th {
      border: 1px solid #d1d5db !important;
    }

    /* æ¯ä¸ª quotation é¡¶éƒ¨ 3px è¾¹ç•Œ */
    #summaryTable tr.row-basic-head td {
      border-top: 3px solid #cfd6dd !important;
    }

    /* æ¯ä¸ª quotation åº•éƒ¨ 3px è¾¹ç•Œ */
    #summaryTable tr.row-sep td {
      border-bottom: 3px solid #cfd6dd !important;
      background: #f3f4f6 !important;
      height: 8px !important;
    }

    /* sticky å·¦å³åˆ—ä¸å†é¢å¤–ç”»é˜´å½± */
    #summaryTable td:first-child,
    #summaryTable th:first-child,
    #summaryTable td:last-child,
    #summaryTable th:last-child {
      box-shadow: none !important;
    }

    /* ===== FIX: ACTION icons in the SAME cell must align perfectly ===== */

    /* å®¹å™¨ç»Ÿä¸€ç”¨ inline-flexï¼Œå‚ç›´å±…ä¸­ */
    .action-button-row {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px !important;
      white-space: nowrap !important;
    }

    /* æ— è®ºæ˜¯ button / a / span éƒ½å¼ºåˆ¶åŒä¸€ç›’æ¨¡å‹ */
    .action-button-row button,
    .action-button-row a,
    .action-button-row span {
      width: 26px !important;
      height: 26px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;

      padding: 0 !important;
      line-height: 1 !important;
      /* å…³é”®ï¼šå»æ‰å­—ä½“åŸºçº¿å·®å¼‚ */
      vertical-align: middle !important;
      /* å…³é”®ï¼šå¼ºåˆ¶å¯¹é½ */
      font-size: 16px !important;
      /* ç»Ÿä¸€å¤§å°ï¼ˆä½ å¯æ”¹ 14/16ï¼‰ */
      border-radius: 6px !important;
    }

    /* å¦‚æœä½ å·²æœ‰ .action-button ç±»ï¼Œä¹Ÿå¼ºåˆ¶ä¸€è‡´ */
    .action-button {
      width: 26px !important;
      height: 26px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 !important;
      line-height: 1 !important;
      font-size: 16px !important;
    }

    /* ===== BASIC ACTION (Submit/Edit/Save) polish ===== */

    /* è®©æŒ‰é’®ä¹‹é—´æœ‰å‘¼å¸æ„Ÿ */
    .basic-action-row {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 10px !important;
      /* âœ… é—´è·æ›´å¤§ */
      white-space: nowrap !important;
    }

    /* ä¸‰ä¸ªæŒ‰é’®ç»Ÿä¸€å°ºå¯¸ + çµåŠ¨ hover/active */
    .basic-action-row .action-button {
      width: 28px !important;
      height: 28px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;

      padding: 0 !important;
      line-height: 1 !important;
      font-size: 16px !important;

      border-radius: 8px !important;
      background: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;

      transition: transform .12s ease, background-color .12s ease, box-shadow .12s ease, opacity .12s ease;
    }

    .basic-action-row .action-button:hover {
      background: #e2e8f0 !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .12) !important;
    }

    .basic-action-row .action-button:active {
      transform: translateY(0px) scale(.96) !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .10) !important;
    }

    /* ç‚¹å‡»åâ€œå·¥ä½œä¸­â€çŠ¶æ€ï¼šå˜æ·¡ + ç¦ç”¨é¼ æ ‡ */
    .basic-action-row .action-button.working {
      opacity: .55 !important;
      pointer-events: none !important;
    }

    /* æˆåŠŸä¸€ä¸‹ï¼šç»¿è‰²è¾¹æ¡†é—ªä¸€ä¸‹ */
    .basic-action-row .action-button.done {
      border-color: #22c55e !important;
    }

    /* ===== FORCE ALL NOTE CELLS LEFT ALIGNED ===== */

    #summaryTable td.note-preview,
    #summaryTable td[data-field="Note"] {
      text-align: left !important;
    }

    #summaryTable td.note-preview .note-line {
      text-align: left !important;
    }

    /* Vendor Note preview only (does NOT affect other notes) */
    #summaryTable td.note-preview.vendor-note-preview {
      width: 180px !important;
      min-width: 180px !important;
      max-width: 180px !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      text-align: left !important;
    }
  </style>
</head>

<body class="bg-gray-50 text-sm">
  <div id="main-content">
    <div class="header-section flex justify-between items-center w-full px-4 mt-2">
      <h1 class="text-2xl font-bold text-gray-800">Welcome, <span id="usernameDisplay">Sales</span></h1>
      <div class="flex items-center gap-2">
        <button id="toggleInquiry" class="main-button">ğŸ”½</button>
        <button id="prevPage" class="main-button">Previous</button>
        <span id="pageInfo" class="text-gray-800 text-sm font-semibold">Page 1</span>
        <button id="nextPage" class="main-button">Next</button>
        <button id="exitBtn" class="main-button">Exit</button>
        <input id="searchBox" class="border px-3 py-2 rounded-full text-sm w-64"
          placeholder="Search Quotation # or ZIP..." />
        <button id="searchBtn" class="main-button">Search</button>
        <button id="clearSearchBtn" class="main-button">Clear</button>

      </div>
    </div>



    <!-- Inquiry Form -->
    <div class="form-group" id="formGroup">
      <form class="grid grid-cols-2 gap-2 bg-white p-4 rounded shadow" id="inquiryForm">
        <!-- Basic -->
        <input class="border p-2" name="customerId" placeholder="Customer ID" required />
        <input class="border p-2 bg-gray-100" name="requestedByDisplay" placeholder="Requested By" disabled />
        <input type="hidden" name="requestedBy" />

        <select class="border p-2" name="inquiryType" required>
          <option value="">Select Type</option>
          <option>Drayage</option>
          <option>Dry Van</option>
          <option>Flat Bed</option>
          <option>Drayage + Warehouse</option>
          <option>Warehouse Only</option>
        </select>

        <select class="border p-2" name="containerSize">
          <option value="">Container Size</option>
          <option>20'</option>
          <option>40'</option>
          <option>40HQ</option>
          <option>53'</option>
        </select>

        <select class="border p-2" name="dryVanType" id="dryVanTypeSelect">
          <option value="">Dry Van Type</option>
          <option>HOTSHOT</option>
          <option>28'</option>
          <option>53'</option>
          <option>LTL</option>
          <option>SMALL PARCEL</option>
        </select>

        <select class="border p-2" name="legalOverWeight">
          <option value="">Legal or Over Weight</option>
          <option value="Legal">Legal</option>
          <option value="Over Weight">Over Weight</option>
        </select>

        <input class="border p-2" name="grossWeight" placeholder="Gross Weight" />
        <select class="border p-2" name="liveOrDrop">
          <option value="">Live or Drop</option>
          <option value="Live">Live</option>
          <option value="Drop">Drop</option>
        </select>

        <!-- Location -->
        <input class="border p-2" name="from" placeholder="From (Port / Rail / Address)" required />

        <div class="grid grid-cols-3 gap-2 col-span-1">
          <input class="border p-2" name="toCity" placeholder="To City" required />
          <input class="border p-2" name="toState" placeholder="To State" required />
          <input class="border p-2" name="toZip" placeholder="To ZIP" required />
        </div>

        <input class="border p-2" name="qty" placeholder="QTY" />
        <input class="border p-2" name="quotationId" placeholder="Quotation #" required />

        <!-- Cargo Info -->
        <div class="col-span-2">
          <div class="section-title">Cargo Information</div>
          <div class="grid grid-cols-2 gap-2">
            <input class="border p-2" name="commodity" placeholder="Commodity" />
            <select class="border p-2" name="packageType">
              <option value="">Package Type</option>
              <option>Pallet</option>
              <option>Carton</option>
              <option>Unit</option>
              <option>Bundle</option>
              <option>Sack</option>
            </select>
            <input class="border p-2" name="packagesPerContainer" placeholder="Packages Per Container" />
            <div class="flex items-center gap-4 px-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="hazmat" /> Hazmat</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="reefer" /> Reefer</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="bonded" /> Bonded</label>
            </div>
          </div>
        </div>

        <!-- Warehouse Requirement -->
        <div class="col-span-2">
          <div class="section-title">Warehouse Requirement</div>
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="needWarehouseService" name="needWarehouseService" />
              Need Warehouse Service
            </label>
            <span class="tiny-note">Check to show warehouse service request details.</span>
          </div>

          <div id="warehouseBlock" class="mt-4 hidden">

            <!-- ===== Warehouse Services ===== -->
            <div class="tiny-note font-semibold text-gray-700 mb-2">
              Warehouse Services (multi-select)
            </div>

            <div class="grid grid-cols-3 gap-x-10 gap-y-3 text-sm">

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Order Processing" />
                  <span>Order Processing</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Order Processing" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Order Processing" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Inbound" />
                  <span>Inbound</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Inbound" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Inbound" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Outbound" />
                  <span>Outbound</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Outbound" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Outbound" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Sorting" />
                  <span>Sorting</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Sorting" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Sorting" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Palletizing" />
                  <span>Palletizing</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Palletizing" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Palletizing" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Pallet Fee" />
                  <span>Pallet Fee</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Pallet Fee" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Pallet Fee" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Storage" />
                  <span>Storage</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Storage" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Storage" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Label" />
                  <span>Label</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Label" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Label" placeholder="Unit" disabled />
              </div>

              <div class="grid grid-cols-[160px_70px_80px] items-center gap-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" name="whService" value="Cross Dock" />
                  <span>Cross Dock</span>
                </label>
                <input class="border wh-mini w-full" name="whQty_Cross Dock" placeholder="Qty" disabled />
                <input class="border wh-mini w-full" name="whUnit_Cross Dock" placeholder="Unit" disabled />
              </div>

            </div>


            <!-- ===== Estimated ===== -->
            <div class="grid grid-cols-3 gap-3 mt-4">
              <input class="border p-2" name="estimatedPallets" placeholder="Estimated Pallets" />
              <input class="border p-2" name="estimatedBoxes" placeholder="Estimated Boxes / Cartons" />
              <input class="border p-2" name="estimatedSkuCount" placeholder="Estimated SKU Count" />
            </div>

            <!-- ===== Storage Duration ===== -->
            <div class="grid grid-cols-2 gap-3 mt-3">
              <input class="border p-2" name="storageDuration" placeholder="Storage Duration (number)" />
              <input class="border p-2" name="storageDurationUnit" placeholder="Duration Unit (Days/Weeks/Months)" />
            </div>

            <!-- ===== Notes ===== -->
            <textarea class="border p-2 mt-3 w-full" name="warehouseNote" placeholder="Warehouse Note"></textarea>
            <textarea class="border p-2 mt-3 w-full" name="note" placeholder="General Note"></textarea>

          </div>

          <div class="col-span-2 mt-6 mb-4 flex justify-center items-center">
            <button type="submit" id="submitInquiryBtn" class="w-full py-3 text-base font-semibold text-white rounded-full
                   bg-gradient-to-r from-blue-500 to-blue-600
                   shadow-md transition-all duration-200
                   hover:from-blue-600 hover:to-blue-700 hover:shadow-lg">
              Submit Inquiry
            </button>
          </div>

      </form>
    </div> <!-- / #formGroup -->
  </div> <!-- / #main-content -->


  <div id="fixed-scroll-wrapper" class="scroll-container">
    <div style="width: 100%;">
      <table class="bg-white border text-xs" id="summaryTable">
        <thead class="bg-gray-200" style="background-color:#e0f2fe; position: sticky; top: 0; z-index: 10;">
          <tr>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
          </tr>
        </thead>

        <tbody id="summaryBody">
        </tbody>
      </table>


      <div id="noteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-96 p-4">
          <h2 class="text-lg font-semibold mb-2">Edit Note</h2>
          <textarea id="noteModalInput" wrap="soft" class="w-full border p-2 h-40 resize-none"></textarea>
          <div class="mt-4 overflow-x-auto">
            <button id="noteModalSave" class="bg-blue-500 text-white px-4 py-1 rounded">Save</button>
          </div>
        </div>
      </div>


      <script>

        // âœ… ä¿è¯å…¨å±€å¯ç”¨ï¼ˆç»™ onchange è°ƒç”¨ï¼‰
        window.refreshWarehouseBlock = function () {
          const chk = document.getElementById('needWarehouseService');
          const block = document.getElementById('warehouseBlock');
          if (!chk || !block) return;
          block.classList.toggle('hidden', !chk.checked);
        };

        /* ===========================
           Excel-style 6-row Summary (Sales)
           - For each Quotation: 6 rows
             1) BASIC header
             2) BASIC values
             3) TRUCK header
             4) TRUCK values + ACTION
             5) WAREHOUSE header
             6) WAREHOUSE values + ACTION
           - Keeps existing pricing logic (simulateQuoteFull) and GP logic (calculateGPValue)
           =========================== */

        (function () {
          const TOTAL_COLS = 27;

          function ensureColgroup() {
            const table = document.getElementById('summaryTable');
            if (!table) return;

            // å·²ç»æœ‰ colgroup å°±ä¸é‡å¤å»º
            if (table.querySelector('colgroup')) return;

            const colgroup = document.createElement('colgroup');

            // === 27 åˆ—çš„â€œè¡¨å¤´æ–‡æœ¬åŸºå‡†â€ï¼ˆä¸æ¢è¡Œï¼ŒæŒ‰å­—æ•°ä¼°ç®—å®½åº¦ï¼‰ ===
            // BASICï¼š1-17 æ˜¯çœŸå®å­—æ®µï¼›18-26 æ˜¯ NOTEï¼›27 ACTION
            const BASIC_COLS = [
              '#', 'Date', 'Customer ID', 'Requested By', 'Inquiry Type', 'Container Size',
              'Commodity', 'Packages', 'Flags', 'Dry Van Type', 'Legal/Over Weight', 'Gross Weight', 'Live/Drop',
              'From', 'To', 'QTY', 'Quotation #'
            ];

            const notePerColPx = Math.ceil(520 / 9); // ä½  NOTE æ€»å®½ 520ï¼Œåˆ†æ‘Šåˆ° 9 åˆ—

            // TRUCK è¿™ä¸€è¡Œä½ å·²æœ‰ TRUCK_HEADERSï¼ˆ27ï¼‰
            // WH è¿™ä¸€è¡Œï¼š1-17 æ˜¯ WH_LEFT_HEADERSï¼›18-25 NOTEï¼›26 ç©ºï¼›27 Action
            const WH_COLS = [
              ...WH_LEFT_HEADERS, // 17
              'NOTE', 'NOTE', 'NOTE', 'NOTE', 'NOTE', 'NOTE', 'NOTE', 'NOTE', 'NOTE', // 9
              '', 'Action'
            ];

            // TRUCK_HEADERS ä½ æ–‡ä»¶é‡Œå·²å­˜åœ¨ï¼ˆ27ï¼‰
            const TRUCK_COLS = TRUCK_HEADERS;

            // è¿™ä¸‰åˆ—å…è®¸å†…å®¹æ’‘åˆ—ï¼ˆä¸è®¾å›ºå®šå®½ï¼‰
            const AUTO_COL_INDEX = new Set([7, 14, 15]); // Commodity(7), From(14), To(15) â€”â€” 1-based

            for (let i = 1; i <= TOTAL_COLS; i++) {
              const col = document.createElement('col');

              // NOTE 9 åˆ—ï¼ˆ18-26ï¼‰å›ºå®šåˆ†æ‘Šå®½åº¦ï¼ˆä¸å½±å“ä½  note-preview çš„æ•´ä½“å®½åº¦ï¼‰
              if (i >= 18 && i <= 26) {
                col.style.width = `${notePerColPx}px`;
                colgroup.appendChild(col);
                continue;
              }

              // ACTION åˆ—å›ºå®š
              if (i === 27) {
                col.style.width = `120px`;
                colgroup.appendChild(col);
                continue;
              }

              // Commodity / From / Toï¼šä¸è®¾å®½åº¦ï¼Œè®©å®ƒéšå†…å®¹æ’‘åˆ—
              if (AUTO_COL_INDEX.has(i)) {
                colgroup.appendChild(col);
                continue;
              }

              // å…¶å®ƒåˆ—ï¼šå– BASIC/TRUCK/WH åœ¨è¯¥åˆ—ä½ç½®çš„â€œæœ€é•¿è¡¨å¤´å­—æ•°â€æ¥ä¼°ç®—å®½åº¦
              const basicLabel = BASIC_COLS[i - 1] || '';
              const truckLabel = TRUCK_COLS[i - 1] || '';
              const whLabel = WH_COLS[i - 1] || '';

              const maxLen = Math.max(basicLabel.length, truckLabel.length, whLabel.length);

              // ç»™ä¸€ç‚¹ paddingï¼ˆ+2chï¼‰ï¼Œå¹¶é™åˆ¶æœ€å¤§å®½åº¦é¿å…å¤ªå¤¸å¼ 
              const ch = Math.min(maxLen + 2, 18);
              col.style.width = `${ch}ch`;

              colgroup.appendChild(col);
            }

            table.insertBefore(colgroup, table.firstChild);
          }



          function isTruthy(v) {
            if (v === true) return true;
            const s = String(v || '').toLowerCase().trim();
            return s === 'true' || s === '1' || s === 'yes' || s === 'y';
          }

          function roleIsViewOnly(role) {
            const r = String(role || '').toLowerCase();
            return r === 'ops_view' || r === 'viewer';
          }

          function isTruthyFlag(v) {
            const s = String(v ?? '').trim().toLowerCase();
            return s === 'true' || s === 'y' || s === '1' || s === 'yes';
          }

          // âœ… åªè¦ Sourcing å¡«è¿‡ä»»ä½• cost / æˆ–å‹¾è¿‡ cost sent/selectedï¼Œå°±é” Inquiry info
          // âŒ ä¸è¦æŠŠ Sales çš„ Warehouse Requirement ç®—è¿›å»
          function hasSourcingInput(it) {
            const numFields = [
              'Base Rate', 'Chassis', 'Pre-Pull', 'Yard Storage', 'Driver Waiting',
              'Over Weight', 'Chassis Split', 'Toll', 'Reefer Fee', 'Bond Fee'
            ];

            const anyCost = numFields.some(k => {
              const v = Number(((it[k] ?? '') + '').replace(/,/g, '').trim() || 0);
              return v > 0;
            });

            const anyConfirm =
              isTruthyFlag(it['truckingCostSent']) ||
              isTruthyFlag(it['truckingCostSaved']) ||
              isTruthyFlag(it['Selected']) ||
              isTruthyFlag(it['Cost Sent']);
            return anyCost || anyConfirm;
          }

          // âœ… For WH: detect whether Sourcing has provided any WH cost or marked cost sent
          function hasSourcingWHInput(it) {
            const numFields = [
              'Order Processing', 'Inbound', 'Sorting', 'Palletizing', 'Pallet Fee', 'Storage', 'Outbound'
            ];
            const anyCost = numFields.some(k => {
              const v = Number(((it[k] ?? '') + '').replace(/,/g, '').trim() || 0);
              return v > 0;
            });

            const anyConfirm =
              isTruthyFlag(it['warehouseCostSent']) ||
              isTruthyFlag(it['warehouseCostSaved']) ||
              isTruthyFlag(it['Selected']) ||
              isTruthyFlag(it['Cost Sent']);

            return anyCost || anyConfirm;
          }

          // âœ… Detect whether Sales/Manager has actually filled any PRICE fields
          // Used to distinguish: Cost received (yellow) vs Saved (blue)
          function hasAnyPriceFilled(data, scope) {
            const fields = scope === 'WH'
              ? [
                'Order Processing Price', 'Inbound Price', 'Sorting Price', 'Palletizing Price',
                'Pallet Fee Price', 'Storage Price', 'Outbound Price', 'Vendor'
              ]
              : [
                'Adjusted Price', 'Chassis Price', 'Pre-Pull Price', 'Yard Storage Price', 'Driver Waiting Price',
                'Over Weight Price', 'Chassis Split Price', 'Toll Price', 'Reefer Fee Price', 'Bond Fee Price', 'Carrier'
              ];
            return fields.some(k => String((data && data[k]) ?? '').trim() !== '');
          }

          function num(v) {
            const n = parseFloat(String(v ?? '').replace(/,/g, '').trim());
            return Number.isFinite(n) ? n : null;
          }
          function fmt2(v) {
            const n = num(v);
            return n === null ? '' : n.toFixed(2);
          }
          function fmtGPpct(gpFloat) {
            if (!Number.isFinite(gpFloat)) return '';
            return (gpFloat * 100).toFixed(2) + '%';
          }

          function composeTo2(item) {
            const t = (item['To'] || '').trim();
            if (t) return t;
            const city = (item['To City'] || '').trim();
            const state = (item['To State'] || '').trim();
            const zip = (item['To ZIP'] || '').trim();
            return [city, [state, zip].filter(Boolean).join(' ')].filter(Boolean).join(', ');
          }

          function tdCell(text = '', cls = '') {
            const td = document.createElement('td');
            td.className = `border px-2 text-xs ${cls}`;
            td.textContent = text ?? '';
            return td;
          }
          function tdHeader(text = '', cls = '') {
            return tdCell(text, `font-bold bg-gray-100 text-center ${cls}`);
          }

          function makeInput(value, field, quote, locked, scope, alignLeft = false) {
            const input = document.createElement('input');
            input.value = value ?? '';
            input.className = `w-full border text-xs px-1 py-0.5 ${alignLeft ? 'text-left' : 'text-right'}`;
            input.setAttribute('data-quote', quote);
            input.setAttribute('data-field', field);
            input.setAttribute('data-scope', scope);
            input.disabled = !!locked;
            if (locked) input.classList.add('saved-input');
            return input;
          }

          // âœ… Frontend copy of server's simulateQuoteFull â€” used as fallback when Price/GP not yet persisted
          function simulateQuoteFull(baseRate, type) {
            baseRate = parseFloat(baseRate) || 0;
            const result = { finalPrice: 0, gp: 0 };
            const config = {
              drayage: { minGP: 0.10, maxGP: 0.25, ranges: { '50-200': { add: 50, minPrice: 250 }, '200-500': { add: 80, minPrice: 298 }, '500-1500': { divide: 0.84, forceAddIfLt: 100 }, '1500-2500': { slope: 0.2, baseAdd: 300 }, '2500-5000': { slope: 0.2, baseAdd: 500 }, '5000-INF': { slope: 0.25, baseAdd: 1000 } } },
              dryvan: { minGP: 0.18, maxGP: 0.30, ranges: { '50-200': { add: 80, minPrice: 250 }, '200-500': { add: 100, minPrice: 298 }, '500-1500': { divide: 0.80, forceAddIfLt: 100 }, '1500-2500': { slope: 0.2, baseAdd: 400 }, '2500-5000': { slope: 0.24, baseAdd: 600 }, '5000-INF': { slope: 0.325, baseAdd: 1200 } } },
              flatbed: { minGP: 0.18, maxGP: 0.30, ranges: { '50-200': { add: 80, minPrice: 250 }, '200-500': { add: 100, minPrice: 298 }, '500-1500': { divide: 0.80, forceAddIfLt: 100 }, '1500-2500': { slope: 0.2, baseAdd: 400 }, '2500-5000': { slope: 0.24, baseAdd: 600 }, '5000-INF': { slope: 0.325, baseAdd: 1200 } } }
            };
            const normalizedType = (type || '').toLowerCase().replace(/[^a-z]/g, '').replace('drayagewarehouse', 'drayage').replace('drayage+warehouse', 'drayage');
            const { minGP, maxGP, ranges } = config[normalizedType] || config.drayage;

            function beautify(price) {
              const endings = [96, 95, 90, 88, 85];
              const thousandPart = Math.floor(price / 1000) * 1000;
              const hundredPart = Math.floor(price / 100) * 100;
              const deltaToThousand = price - thousandPart;
              const deltaToHundred = price - hundredPart;
              const allowBeautify = ((price >= 1000 && deltaToThousand <= 150) || (price < 1000 && price >= 490 && price <= 510) || (deltaToHundred <= 10));
              if (!allowBeautify) return price;
              for (let end of endings) {
                const candidate = (Math.floor(price / 100) - 1) * 100 + end;
                const gp = (candidate - baseRate) / candidate;
                if (candidate < price && gp >= minGP) return candidate;
              }
              return price;
            }
            function enforceMinGP(price) { const gp = (price - baseRate) / price; if (gp < minGP) return Math.ceil(baseRate / (1 - minGP)); return price; }
            function enforceMaxGP(price) { const gp = (price - baseRate) / price; if (gp > maxGP) return Math.ceil(baseRate / (1 - maxGP)); return price; }

            let price = baseRate;
            for (let key in ranges) {
              const [minStr, maxStr] = key.split('-');
              const min = parseFloat(minStr);
              const max = maxStr === 'INF' ? Infinity : parseFloat(maxStr);
              const logic = ranges[key];
              if (baseRate >= min && baseRate < max) {
                if (logic.add !== undefined) { price = baseRate + logic.add; if (price < logic.minPrice) price = logic.minPrice; }
                else if (logic.divide !== undefined) { price = baseRate / logic.divide; if ((price - baseRate) < logic.forceAddIfLt && price > 1000) price += logic.forceAddIfLt; }
                else if (logic.slope !== undefined) { const add = logic.baseAdd + (baseRate - min) * logic.slope; price = baseRate + add; price = enforceMinGP(price); if (normalizedType !== 'drayage') price = enforceMaxGP(price); }
                break;
              }
            }
            let beautified = beautify(Math.ceil(price));
            let finalGP = (beautified - baseRate) / beautified;
            if ((normalizedType === 'dryvan' || normalizedType === 'flatbed') && finalGP < minGP) beautified = Math.ceil(price);
            result.finalPrice = Math.ceil(beautified);
            result.gp = parseFloat(((result.finalPrice - baseRate) / result.finalPrice).toFixed(4));
            return result;
          }

          // Helper: get Price/GP with frontend fallback when server hasn't persisted
          function getTruckPriceGP(item) {
            const serverPrice = Number(item['Price']) || 0;
            const serverGP = Number(item['GP']);
            const baseRate = Number(String(item['Base Rate'] || '').replace(/,/g, '')) || 0;
            const inquiryType = String(item['Inquiry Type'] || '').trim();

            if (serverPrice > 0 && Number.isFinite(serverGP) && serverGP !== 0) {
              return { price: serverPrice, gp: serverGP };
            }
            // Fallback: calculate on frontend
            if (baseRate > 0) {
              const sim = simulateQuoteFull(baseRate, inquiryType);
              return { price: sim.finalPrice, gp: sim.gp };
            }
            return { price: 0, gp: null };
          }

          async function postUpdate(payload) {
            // âœ… FIX: Suppress socket-triggered reloads for 2s after self-initiated save.
            //    This prevents loadInquiries() from wiping unsaved sub-line inputs.
            window._selfUpdateUntil = Date.now() + 2000;

            const res = await fetch('/inquiries/update', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              const t = await res.text();
              console.error('Update failed:', t);
              return { ok: false, text: t };
            }
            return { ok: true };
          }

          async function saveFields(quote, fields, scope) {
            const payload = {
              'Quotation #': quote,
              'Saved': 'true',
              'Requested By': (window.currentUser || ''),
              'username': (window.currentUser || '')
            };

            // âœ… Scope-specific saved flags (to distinguish from Sourcing cost updates)
            if (scope === 'TRUCK') payload['truckingPriceSaved'] = 'true';
            if (scope === 'WH') payload['warehousePriceSaved'] = 'true';




            // âœ… å…ˆæŠŠå½“å‰ quote + scope ä¸‹æ‰€æœ‰ input å…¨æ‹¿å‡ºæ¥
            const inputs = Array.from(document.querySelectorAll(`input[data-scope="${scope}"]`))
              .filter(el => el.getAttribute('data-quote') === quote);

            // âœ… å»ºä¸€ä¸ª mapï¼šfieldName -> value
            const map = new Map();
            inputs.forEach(el => {
              const f = el.getAttribute('data-field');
              if (f) map.set(f, el.value);
            });

            // âœ… æŒ‰ fields ç™½åå•è£… payload
            fields.forEach(f => {
              if (map.has(f)) payload[f] = map.get(f);
            });

            console.log('[DEBUG saveFields]', { scope, quote, payload }); // ğŸ”¥ ä¸´æ—¶ä¿ç•™ï¼Œä¾¿äºç¡®è®¤ payload æœ‰å­—æ®µ

            const r = await postUpdate(payload);
            if (!r.ok) alert('âŒ Save failed: ' + (r.text || ''));
            return r.ok;
          }

          async function setConfirm(quote, field, checked) {
            const payload = { 'Quotation #': quote, 'Saved': 'true' };
            payload[field] = checked ? 'true' : 'false';
            // keep manager confirmed as-is (server merges)
            const r = await postUpdate(payload);
            if (!r.ok) alert('âŒ Confirm update failed.');
            return r.ok;
          }


          function unlockRow(quote, scope) {
            document
              .querySelectorAll(`input[data-scope="${scope}"][data-quote="${quote}"]`)
              .forEach(el => {
                el.disabled = false;
                el.classList.remove('saved-input');
              });
          }

          function lockRow(quote, scope) {
            document
              .querySelectorAll(`input[data-scope="${scope}"][data-quote="${quote}"]`)
              .forEach(el => {
                el.disabled = true;
                el.classList.add('saved-input');
              });
          }

          function actionCellTruck(item, quote, role) {
            const td = document.createElement('td');
            td.className = 'border px-2 text-center';

            if (roleIsViewOnly(role)) return td;

            const lockedByMgr = isTruthy(item['truckingManagerConfirmed']);
            const locked = lockedByMgr || isTruthy(item['truckingSalesConfirmed']);

            const wrap = document.createElement('div');
            wrap.className = 'action-button-row';

            const editBtn = document.createElement('button');
            editBtn.className = 'action-button';
            editBtn.textContent = 'âœï¸';
            editBtn.title = 'Price Edit (Truck)';
            editBtn.disabled = lockedByMgr;   // âœ… åªæœ‰ Manager Confirm æ‰ç¦ç”¨ Edit
            editBtn.onclick = () => {
              if (chk.checked) {
                alert("Row is confirmed. Please UNCHECK first.");
                return;
              }

              // âœ… ç‚¹å‡» EDITï¼šæ•´è¡Œå˜æˆæè‰²ï¼ˆediting-rowï¼‰
              document.querySelectorAll(`tr.row-truck-val[data-quote="${quote}"]`).forEach(tr => {
                tr.classList.remove('saved-price', 'row-confirmed', 'cost-received');
                tr.classList.add('editing-row');
              });

              unlockRow(quote, 'TRUCK');
            };


            const saveBtn = document.createElement('button');
            saveBtn.className = 'action-button';
            saveBtn.textContent = 'ğŸ’¾';
            saveBtn.title = 'Price Save (Truck)';
            saveBtn.onclick = async () => {
              const fields = [
                'Adjusted Price', 'Carrier', 'Note',
                'Chassis Price', 'Pre-Pull Price', 'Yard Storage Price',
                'Driver Waiting Price', 'Over Weight Price', 'Chassis Split Price',
                'Toll Price', 'Reefer Fee Price', 'Bond Fee Price'
              ];

              const ok = await saveFields(quote, fields, 'TRUCK');

              if (ok) {
                lockRow(quote, 'TRUCK');

                // âœ… ä¿å­˜æˆåŠŸï¼šé€€å‡º editingï¼ˆé»„ï¼‰ï¼Œè¿›å…¥ savedï¼ˆæ·¡ç°è“ï¼‰
                document.querySelectorAll(`tr.row-truck-val[data-quote="${quote}"]`).forEach(tr => {
                  tr.classList.remove('editing-row', 'row-confirmed', 'cost-received');
                  tr.classList.add('saved-price');
                });
              }
            };

            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.title = 'Price Confirm (Truck)';
            chk.checked = locked;
            chk.disabled = lockedByMgr;
            chk.onchange = async () => {
              const want = chk.checked;

              // âœ… åªæœ‰åœ¨â€œå‹¾é€‰â€æ—¶è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ï¼Œç¡®ä¿ Manager èƒ½çœ‹åˆ°
              if (want) {
                const fields = [
                  'Adjusted Price', 'Carrier', 'Note',
                  'Chassis Price', 'Pre-Pull Price', 'Yard Storage Price', 'Driver Waiting Price',
                  'Over Weight Price', 'Chassis Split Price', 'Toll Price', 'Reefer Fee Price', 'Bond Fee Price'
                ];
                const okSave = await saveFields(quote, fields, 'TRUCK');
                if (!okSave) { chk.checked = false; return; }
                lockRow(quote, 'TRUCK');
              }

              const ok = await setConfirm(quote, 'truckingSalesConfirmed', want);
              if (!ok) chk.checked = !want;

              window.loadInquiries && window.loadInquiries();
            };


            const addBtn = document.createElement('button');
            addBtn.className = 'action-button';
            addBtn.textContent = 'â•';
            addBtn.title = 'Add Truck Option (Sourcing only)';
            addBtn.disabled = true;
            addBtn.style.opacity = '0.3';
            addBtn.style.cursor = 'not-allowed';

            wrap.appendChild(editBtn);
            wrap.appendChild(saveBtn);
            wrap.appendChild(chk);
            wrap.appendChild(addBtn);
            td.appendChild(wrap);
            return td;
          }

          function actionCellWH(item, quote, role) {
            const td = document.createElement('td');
            td.className = 'border px-2 text-center';

            if (roleIsViewOnly(role)) return td;

            const lockedByMgr = isTruthy(item['warehouseManagerConfirmed']);
            const locked = lockedByMgr || isTruthy(item['warehouseSalesConfirmed']);

            const wrap = document.createElement('div');
            wrap.className = 'action-button-row';

            const editBtn = document.createElement('button');
            editBtn.className = 'action-button';
            editBtn.textContent = 'âœï¸';
            editBtn.title = 'Price Edit (Truck)';
            editBtn.disabled = lockedByMgr;

            editBtn.onclick = () => {
              if (chk.checked) {
                alert("Row is confirmed. Please UNCHECK first.");
                return;
              }

              // âœ… ç‚¹å‡» EDITï¼šæ•´è¡Œå˜æˆæè‰²ï¼ˆediting-rowï¼‰
              document.querySelectorAll(`tr.row-wh-val[data-quote="${quote}"]`).forEach(tr => {
                tr.classList.remove('saved-price', 'row-confirmed', 'cost-received');
                tr.classList.add('editing-row');
              });

              unlockRow(quote, 'WH');
            };

            const saveBtn = document.createElement('button');
            saveBtn.className = 'action-button';
            saveBtn.textContent = 'ğŸ’¾';
            saveBtn.title = 'Price Save (Warehouse)';
            saveBtn.onclick = async () => {
              const fields = [
                'Vendor', 'Note',
                'Order Processing Price',     // â† æ”¹é€™è£¡
                'Inbound Price',              // â† æ”¹é€™è£¡
                'Sorting Price',              // â† æ”¹é€™è£¡
                'Palletizing Price',          // â† æ”¹é€™è£¡
                'Pallet Fee Price',           // â† æ”¹é€™è£¡
                'Storage Price',              // â† æ”¹é€™è£¡
                'Outbound Price'              // â† æ”¹é€™è£¡
              ];

              const ok = await saveFields(quote, fields, 'WH');
              if (ok) {
                lockRow(quote, 'WH');

                // âœ… ä¿å­˜æˆåŠŸï¼šé€€å‡º editingï¼ˆé»„ï¼‰ï¼Œè¿›å…¥ savedï¼ˆæ·¡ç°è“ï¼‰
                document.querySelectorAll(`tr.row-wh-val[data-quote="${quote}"]`).forEach(tr => {
                  tr.classList.remove('editing-row', 'row-confirmed', 'cost-received');
                  tr.classList.add('saved-price');
                });
              }
            };

            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.title = 'Price Confirm (Warehouse)';
            chk.checked = locked;
            chk.disabled = lockedByMgr;
            chk.onchange = async () => {
              const want = chk.checked;

              // âœ… å‹¾é€‰æ—¶è‡ªåŠ¨ä¿å­˜ Warehouse Price
              if (want) {
                const fields = [
                  'Vendor', 'Note',
                  'Order Processing Price',
                  'Inbound Price',
                  'Sorting Price',
                  'Palletizing Price',
                  'Pallet Fee Price',
                  'Storage Price',
                  'Outbound Price'
                ];

                const okSave = await saveFields(quote, fields, 'WH');
                if (!okSave) { chk.checked = false; return; }
                lockRow(quote, 'WH');
              }


              const ok = await setConfirm(quote, 'warehouseSalesConfirmed', want);
              if (!ok) { chk.checked = !want; return; }

              // âœ… ä¿å­˜æˆåŠŸï¼šé€€å‡º editing-rowï¼Œè¿›å…¥ saved-priceï¼ˆæ•´è¡Œç°è“ï¼‰
              document.querySelectorAll(`tr.row-wh-val[data-quote="${quote}"]`).forEach(tr => {
                tr.classList.remove('editing-row', 'row-confirmed', 'cost-received');
                tr.classList.add('saved-price');
              });

              window.loadInquiries && window.loadInquiries();
            };

            const addBtn = document.createElement('button');
            addBtn.className = 'action-button';
            addBtn.textContent = 'â•';
            addBtn.title = 'Add Warehouse Option (Sourcing only)';
            addBtn.disabled = true;
            addBtn.style.opacity = '0.3';
            addBtn.style.cursor = 'not-allowed';

            wrap.appendChild(editBtn);
            wrap.appendChild(saveBtn);
            wrap.appendChild(chk);
            wrap.appendChild(addBtn);
            td.appendChild(wrap);
            return td;
          }

          window.renderPage = function renderPageExcel6() {
            const tbody = document.getElementById('summaryBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const role = window.userRole || '';
            const viewOnly = roleIsViewOnly(role);

            // Use existing globals from main script
            const pageSize = window.pageSize || 100;
            const currentPage = window.currentPage || 1;

            const data = window.filteredData || [];
            // âœ… ä¸è¦åœ¨è¿™é‡Œå† sortï¼Œè®© loadInquiries çš„æ’åºç”Ÿæ•ˆ


            // ç¹¼çºŒåŸæœ‰ td å¡«å…¥...

            const start = (currentPage - 1) * pageSize;
            const pageData = data.slice(start, start + pageSize);
            // ===== SUB-LINES (from Sourcing) =====
            const truckSubsByParent = new Map();
            const whSubsByParent = new Map();

            (data || []).forEach(it => {
              const q = String(it['Quotation #'] || '').trim();
              const p = String(it['Parent Quotation #'] || '').trim();
              if (!q || !p) return;

              const t = String(it['Type'] || '').toUpperCase();
              if (t === 'TRUCK') {
                if (!truckSubsByParent.has(p)) truckSubsByParent.set(p, []);
                truckSubsByParent.get(p).push(it);
              } else if (t === 'WAREHOUSE') {
                if (!whSubsByParent.has(p)) whSubsByParent.set(p, []);
                whSubsByParent.get(p).push(it);
              }
            });

            function _truckSubNo(q) {
              const m = String(q || '').match(/-(\d+)$/);
              return m ? parseInt(m[1], 10) : 0;
            }
            function _whSubLetter(q) {
              const m = String(q || '').match(/-([A-Z])$/i);
              return m ? m[1].toUpperCase() : '';
            }
            truckSubsByParent.forEach(arr => arr.sort((a, b) => _truckSubNo(a['Quotation #']) - _truckSubNo(b['Quotation #'])));
            whSubsByParent.forEach(arr => arr.sort((a, b) => _whSubLetter(a['Quotation #']).localeCompare(_whSubLetter(b['Quotation #']))));


            // index by base quote
            const baseIndex = new Map();
            const getBase = (q) => {
              q = (q || '').trim();
              const m = q.match(/^(.+?)\/[TW]\d+$/i);
              return m ? m[1] : q;
            };
            const getIndex = (q) => {
              const b = getBase(q);
              if (!baseIndex.has(b)) baseIndex.set(b, baseIndex.size + 1 + start);
              return baseIndex.get(b);
            };

            function flagIcons(item) {
              const icons = [];
              const haz = String(item['Hazmat'] ?? item['hazmat'] ?? '').toLowerCase() === 'true';
              const ref = String(item['Reefer'] ?? item['reefer'] ?? '').toLowerCase() === 'true';
              const bon = String(item['Bonded'] ?? item['bonded'] ?? '').toLowerCase() === 'true';
              if (haz) icons.push('â˜¢ï¸');
              if (ref) icons.push('â„ï¸');
              if (bon) icons.push('ğŸ”’');
              return icons.length ? ' ' + icons.join(' ') : '';
            }


            function cargoText(item) {
              const commodity = (item['Commodity'] ?? item['commodity'] ?? '').toString().trim();
              const ppc = (item['Packages Per Container'] ?? item['packagesPerContainer'] ?? '').toString().trim();

              const parts = [];
              if (commodity) parts.push(commodity);
              if (ppc) parts.push(`PPC:${ppc}`);

              const base = parts.join(' | ');
              return (base || '') + flagIcons(item);
            }


            function flagIcons(item) {
              const icons = [];
              const haz = String(item['Hazmat'] ?? item['hazmat'] ?? '').toLowerCase() === 'true';
              const ref = String(item['Reefer'] ?? item['reefer'] ?? '').toLowerCase() === 'true';
              const bon = String(item['Bonded'] ?? item['bonded'] ?? '').toLowerCase() === 'true';
              if (haz) icons.push('â˜¢ï¸');
              if (ref) icons.push('â„ï¸');
              if (bon) icons.push('ğŸ”’');
              return icons.join(' ');
            }


            const BASIC_HEADERS = [
              '#', 'Date', 'Customer ID', 'Requested By',
              'Inquiry Type', 'Container Size',
              'Commodity', 'Packages', 'Flags',                // âœ… æ–°å¢
              'Dry Van Type',
              'Legal/Over Weight', 'Gross Weight', 'Live/Drop',
              'From', 'To', 'QTY', 'Quotation #'
            ];

            const BASIC_LEFT_COLS = BASIC_HEADERS.length;
            const BASIC_NOTE_COLSPAN = 25 - BASIC_LEFT_COLS;


            const TRUCK_HEADERS = [
              '', 'Base Rate', 'Price', 'GP', 'Adjusted Price', 'Adjusted GP',
              'Chassis Cost', 'Chassis Price',
              'Pre-Pull Cost', 'Pre-Pull Price',
              'Yard Storage Cost', 'Yard Storage Price',
              'Driver Waiting Cost', 'Driver Waiting Price',
              'Over Weight Cost', 'Over Weight Price',
              'Chassis Split Cost', 'Chassis Split Price',
              'Toll Cost', 'Toll Price',
              'Reefer Fee Cost', 'Reefer Fee Price',
              'Bond Fee Cost', 'Bond Fee Price',
              'Carrier', '', 'Action'
            ];

            const WH_LEFT_HEADERS = [
              '', 'WH Order Proc', 'WH Order Proc Price',
              'WH Inbound', 'WH Inbound Price',
              'WH Sorting', 'WH Sorting Price',
              'WH Palletizing', 'WH Palletizing Price',
              'WH Pallet', 'WH Pallet Price',
              'WH Storage', 'WH Storage Price',
              'WH Outbound', 'WH Outbound Price',
              'Vendor'
            ];


            let displayIndex = 0;

            pageData.forEach(item => {
              const quote = (item['Quotation #'] || '').trim();
              if (!quote) return;


              // âœ… Child sub-lines should NOT render a full 6-row block here.
              // Only render MAIN rows; sub-lines will be inserted under the MAIN block.
              const _parent = String(item['Parent Quotation #'] || '').trim();
              if (_parent) return;
              displayIndex++;



              // 1) BASIC header
              const r1 = document.createElement('tr');
              r1.className = 'row-basic-head';

              // å‰ 17 åˆ—
              const basicHeadFirst17 = [
                '#', 'Date', 'Customer ID', 'Requested By', 'Inquiry Type', 'Container Size',
                'Commodity', 'Packages', 'Flags', 'Dry Van Type', 'Legal/Over Weight', 'Gross Weight', 'Live/Drop',
                'From', 'To', 'QTY', 'Quotation #'
              ];
              basicHeadFirst17.forEach(h => r1.appendChild(tdHeader(h)));

              const row = document.createElement('tr');

              // å­è¡Œè¦–è¦ºå€åˆ†ï¼ˆç¸®é€² + æ¨£å¼ï¼‰
              if (item['Parent Quotation #']) {
                row.classList.add('sub-row');
              }

              // ç¹¼çºŒåŸæœ‰ä»£ç¢¼...

              // 18~25 åˆå¹¶æˆ NOTEï¼ˆ8 åˆ—ï¼‰
              // 18~25 åˆå¹¶æˆ NOTEï¼ˆ8 åˆ—ï¼‰
              const noteHead = tdHeader('NOTE');
              noteHead.colSpan = 8;                 // âœ… 8 æ‰å¯¹
              noteHead.classList.add('text-center'); // ä½ è¦å·¦å¯¹é½å°± text-left
              r1.appendChild(noteHead);

              // âœ… ç¬¬26æ  spacerï¼ˆä¸€å®šè¦æœ‰ï¼Œé¿å… ACTION æŒ¤è¿› NOTEï¼‰
              r1.appendChild(tdHeader('', 'spacer-col'));

              // ç¬¬27æ  ACTION
              const actionHead = tdHeader('ACTION');
              r1.appendChild(actionHead);

              tbody.appendChild(r1);


              // 2) BASIC values
              const r2 = document.createElement('tr');
              r2.className = 'row-basic-val';

              function makeInquiryInput(value, key, allowEdit, alignLeft = false) {
                const input = document.createElement('input');
                input.value = value ?? '';
                input.className = `inq-field cell-fill border text-xs px-1 py-0.5 ${alignLeft ? 'text-left' : 'text-center'}`;
                input.dataset.key = key;                 // âœ… ä¿å­˜æ—¶ç”¨
                input.dataset.allowEdit = allowEdit ? '1' : '0';
                input.disabled = true;                   // âœ… é»˜è®¤é”ä½
                return input;
              }


              const flags = flagIcons(item);

              // å‰ 18 åˆ—å†…å®¹
              const basicValFirst17 = [
                String(displayIndex),
                item['Date'] || '',
                item['Customer ID'] || '',
                item['Requested By'] || item.username || '',
                item['Inquiry Type'] || '',
                item['Container Size'] || '',
                (item['Commodity'] || '').toString().trim(),
                item['Packages Per Container'] || '',
                flags,
                item['Dry Van Type'] || '',
                item['Legal or Over Weight'] || '',
                item['Gross Weight'] || '',
                item['Live or Drop'] || '',
                item['From'] || '',
                composeTo2(item),
                item['QTY'] || '',
                (item['External Quotation #'] || quote)
              ];

              basicValFirst17.forEach((v, i) => {
                const td = document.createElement('td');
                td.className = 'border px-2 text-xs text-center';

                // å…è®¸ Sales ä¿®æ”¹çš„ inquiry å­—æ®µï¼ˆå‰æï¼šSourcing æœªå‡º costï¼‰
                // ä½ è¯´ QUOTATION # ä¹Ÿè¦èƒ½æ”¹ï¼Œæ‰€ä»¥æ”¾è¿›æ¥
                const editableKeysByIndex = {
                  5: 'Container Size',
                  6: 'Commodity',
                  7: 'Packages Per Container',
                  9: 'Dry Van Type',
                  10: 'Legal or Over Weight',
                  11: 'Gross Weight',
                  12: 'Live or Drop',
                  13: 'From',
                  14: 'To',
                  15: 'QTY',
                  16: 'External Quotation #'
                };

                const key = editableKeysByIndex[i];

                if (key) {
                  const alignLeft = (key === 'From' || key === 'To' || key === 'Commodity');
                  const inp = makeInquiryInput(v, key, true, alignLeft);

                  // âœ… ç²˜è´´åœ¨è¿™é‡Œï¼ˆæ›¿æ¢æ‰æ—§çš„ text-input/num-input é€»è¾‘ï¼‰
                  inp.classList.add('cell-fill'); // é»˜è®¤è´´æ»¡æ ¼å­

                  if (key === 'Commodity' || key === 'From' || key === 'To') {
                    inp.classList.remove('cell-fill');
                    inp.classList.add('auto-grow');

                    const setSize = () => {
                      const len = (inp.value || '').length;
                      inp.size = Math.max(6, len + 1);
                    };
                    setSize();
                    inp.addEventListener('input', setSize);
                  }

                  td.classList.remove('text-center');
                  td.classList.add(alignLeft ? 'text-left' : 'text-center');
                  td.appendChild(inp);

                } else {
                  // ä¸å…è®¸æ”¹çš„å­—æ®µä¿æŒæ–‡æœ¬
                  td.textContent = v ?? '';
                  // from/to/commodity ä»¥å¤–ä½ æƒ³å·¦å¯¹é½çš„å¯ä»¥åœ¨è¿™é‡ŒåŠ 
                  if (i === 13 || i === 14) td.classList.add('text-left');
                }

                r2.appendChild(td);
              });


              const company = (item['Customer Company'] || item['Company Name'] || '').toString().trim();
              const contact = (item['Customer Contact'] || item['Contact Name'] || '').toString().trim();
              const email = (item['Customer Email'] || '').toString().trim();
              const phone = (item['Customer Phone'] || '').toString().trim();

              const customerInfoLine = [company, contact, email, phone].filter(Boolean).length
                ? `Customer Info: ${[
                  company ? `Company=${company}` : '',
                  contact ? `Contact=${contact}` : '',
                  email ? `Email=${email}` : '',
                  phone ? `Phone=${phone}` : ''
                ].filter(Boolean).join(' | ')}`
                : '';

              const noteBody = (item['Note'] || '').toString().trim();

              // âœ… æœ€ç»ˆ GENERAL NOTEï¼šå®¢æˆ·ä¿¡æ¯åœ¨ç¬¬ä¸€è¡Œï¼Œä¸‹é¢æ‰æ˜¯åŸ Note
              const fullGeneralNote = [customerInfoLine, noteBody].filter(Boolean).join('\n');
              const previewGeneralNote = fullGeneralNote.replace(/\s+/g, ' ').trim(); // âœ… å‹æ‰æ¢è¡Œ

              const noteVal = tdCell('', 'text-left note-preview');
              noteVal.colSpan = 8;  // âœ… 9 -> 8
              noteVal.dataset.fullNote = fullGeneralNote;
              noteVal.dataset.which = 'GENERAL NOTE';

              const line = document.createElement('div');
              line.className = 'note-line';
              line.textContent = previewGeneralNote;
              noteVal.appendChild(line);

              r2.appendChild(noteVal);

              // âœ… ç¬¬26æ  spacerï¼ˆå¿…é¡»æœ‰ï¼Œä¸ç„¶ ACTION ä¼šæŒ¤è¿› NOTE é€ æˆå³ä¾§é”™ä½ï¼‰
              r2.appendChild(tdCell('', 'spacer-col'));

              // âœ… åŠ è¿™ä¸€è¡Œï¼ˆä¿®å¤ canEditInquiry not definedï¼‰
              const canEditInquiry = !viewOnly && !hasSourcingInput(item);

              // âœ… ç¬¬27æ  ACTIONï¼ˆä½ åŸæœ¬çš„æŒ‰é’® tdï¼Œä¿æŒåŸé€»è¾‘ï¼‰
              // âœ… BASIC r2 ACTION cell (Submit/Edit/Save) â€” unified layout
              const inquiryActionTd = document.createElement('td');
              inquiryActionTd.className = 'border px-2 text-center';

              const wrapBasic = document.createElement('div');
              wrapBasic.className = 'basic-action-row';

              // ğŸ“¤ Submit to Sourcing
              const submitBtn = document.createElement('button');
              submitBtn.type = 'button';
              submitBtn.textContent = 'ğŸ“¤';
              submitBtn.title = 'Submit to Sourcing';
              submitBtn.className = 'btn-submit-sourcing action-button';
              submitBtn.dataset.quote = quote;

              // ğŸ“ Inquiry Edit
              const editBtn = document.createElement('button');
              editBtn.type = 'button';
              editBtn.textContent = 'ğŸ“';
              editBtn.title = 'Inquiry Edit';
              editBtn.className = 'btn-edit-inquiry action-button'; // âœ… å…³é”®ï¼šåŠ  action-button
              editBtn.dataset.quote = quote;

              // ğŸ’¾ Inquiry Save
              const saveBtn = document.createElement('button');
              saveBtn.type = 'button';
              saveBtn.textContent = 'ğŸ’¾';
              saveBtn.title = 'Inquiry Save';
              saveBtn.className = 'btn-save-inquiry action-button'; // âœ… å…³é”®ï¼šç»Ÿä¸€ class
              saveBtn.style.display = 'none';
              saveBtn.dataset.quote = quote;

              // ç»„è£…ï¼ˆæŒ‰ä½ ç°åœ¨é€»è¾‘ï¼šå¤–éƒ¨å•æ‰æœ‰ğŸ“¤ï¼Œå¯ç¼–è¾‘æ‰æœ‰ğŸ“ğŸ’¾ï¼‰
              if (canEditInquiry) {
                // å¤–éƒ¨å•ä¸”æœªæäº¤æ‰æ˜¾ç¤º submitï¼ˆä½ åŸæ¥æ¡ä»¶ç…§æ—§ï¼‰
                if (String(item['Source'] || '') === 'customer_portal' && String(item['Submitted To Sourcing'] || '').toLowerCase() !== 'true') {
                  wrapBasic.appendChild(submitBtn);
                }
                wrapBasic.appendChild(editBtn);
                wrapBasic.appendChild(saveBtn);
              } else {
                inquiryActionTd.textContent = 'ğŸ”’';
              }

              if (wrapBasic.childNodes.length) inquiryActionTd.appendChild(wrapBasic);
              r2.appendChild(inquiryActionTd);

              tbody.appendChild(r2);

              // 3) TRUCK header
              const r3 = document.createElement('tr');
              r3.className = 'row-truck-head';
              TRUCK_HEADERS.forEach((h, i) => {
                if (i === 0) r3.appendChild(tdHeader(quote, 'text-left nowrap-limit'));  // âœ… ç¬¬1æ ¼æ˜¾ç¤ºä¸»å·
                else r3.appendChild(tdHeader(h, (h === 'Carrier' || h === 'Note') ? 'text-left' : 'text-right'));
              });

              tbody.appendChild(r3);

              // 4) TRUCK values (MAIN)
              const r4 = document.createElement('tr');
              r4.className = 'row-truck-val';

              // âœ… è®© lockRow(quote,'TRUCK') æ‰¾å¾—åˆ°ä¸»è¡Œ
              r4.dataset.quote = quote;
              r4.dataset.scope = 'TRUCK';

              if (isTruthy(item['truckingSalesConfirmed'])) {
                r4.classList.add('truck-confirmed');
              }

              const lockedTruck = viewOnly
                || isTruthy(item['Saved'])
                || isTruthy(item['truckingManagerConfirmed'])
                || isTruthy(item['truckingSalesConfirmed']);


              r4.appendChild(tdCell('')); // ç©ºç™½æ¬„

              // Base Rate
              r4.appendChild(tdCell(fmt2(item['Base Rate'])));

              // Priceï¼ˆé¡¯ç¤ºå…©ä½å°æ•¸ï¼‰â€” âœ… FIX: Use frontend fallback when server hasn't persisted
              const { price: calcPrice, gp: calcGP } = getTruckPriceGP(item);
              r4.appendChild(tdCell(calcPrice > 0 ? calcPrice.toFixed(2) : 'â€”'));

              // GPï¼ˆé˜² NaNï¼Œè½‰æˆç™¾åˆ†æ¯”ï¼‰
              const gpPercent = (calcGP !== null && Number.isFinite(calcGP)) ? (calcGP * 100).toFixed(2) + '%' : 'â€”';
              r4.appendChild(tdCell(gpPercent));

              // Adjusted Priceï¼ˆå¯ç·¨è¼¯ï¼‰
              const adjInp = makeInput(item['Adjusted Price'] || '', 'Adjusted Price', quote, lockedTruck, 'TRUCK');
              const tdAdj = document.createElement('td');
              tdAdj.appendChild(adjInp);
              r4.appendChild(tdAdj);

              // Adjusted GPï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰
              const baseRateNum = num(item['Base Rate']);
              const adjPriceNum = num(item['Adjusted Price']);
              let adjGPText = 'â€”';
              if (adjPriceNum > 0 && baseRateNum > 0) {
                const adjGP = ((adjPriceNum - baseRateNum) / adjPriceNum) * 100;
                adjGPText = adjGP.toFixed(2) + '%';
              }
              r4.appendChild(tdCell(adjGPText));

              adjInp.addEventListener('input', () => {
                const ap = num(adjInp.value);
                let newGP = 'â€”';
                if (ap > 0 && baseRateNum > 0) {
                  newGP = (((ap - baseRateNum) / ap) * 100).toFixed(2) + '%';
                }
                r4.children[5].textContent = newGP;   // ç¬¬6å€‹ td æ˜¯ Adjusted GP
              });

              // å¾Œé¢çš„ Chassisã€Pre-Pull... ç­‰æ¬„ä½ä¿æŒåŸæ¨£
              const pairs = [
                ['Chassis', 'Chassis Price'],
                ['Pre-Pull', 'Pre-Pull Price'],
                ['Yard Storage', 'Yard Storage Price'],
                ['Driver Waiting', 'Driver Waiting Price'],
                ['Over Weight', 'Over Weight Price'],
                ['Chassis Split', 'Chassis Split Price'],
                ['Toll', 'Toll Price'],
                ['Reefer Fee', 'Reefer Fee Price'],
                ['Bond Fee', 'Bond Fee Price'],
              ];

              pairs.forEach(([cF, pF]) => {
                r4.appendChild(tdCell(fmt2(item[cF])));
                const pi = makeInput(item[pF] || '', pF, quote, lockedTruck, 'TRUCK');
                const t = document.createElement('td');
                t.appendChild(pi);
                r4.appendChild(t);
              });

              const carrier = makeInput(item['Carrier'] || '', 'Carrier', quote, lockedTruck, 'TRUCK', true);
              const tdCar = document.createElement('td');
              tdCar.appendChild(carrier);
              r4.appendChild(tdCar);

              // âœ… Vendor Note (Column 26) â€” Sales view only (read-only)
              const vendorNoteFull = String(item['Vendor Note'] || item['Carrier Note'] || '').trim();
              const cleanNote = vendorNoteFull.replace(/\s+/g, ' ').trim();
              const vendorNotePreview = cleanNote.length > 20 ? cleanNote.substring(0, 20) + '...' : cleanNote;

              const vNoteTd = tdCell(vendorNotePreview, 'text-left note-preview vendor-note-preview');
              vNoteTd.dataset.fullNote = vendorNoteFull;
              vNoteTd.dataset.which = 'VENDOR NOTE';

              // âŒ Sales ä¸å…è®¸ä¿å­˜ï¼Œæ‰€ä»¥ä¸è¦åŠ  dataset.field / dataset.quote
              r4.appendChild(vNoteTd);

              r4.appendChild(actionCellTruck(item, quote, role));


              const costReceivedTruck = hasSourcingInput(item) || ((truckSubsByParent.get(quote) || []).some(s => hasSourcingInput(s)));
              const savedTruck = isTruthy(item['truckingPriceSaved']);
              const confirmedTruck =
                isTruthy(item['truckingSalesConfirmed']) || isTruthy(item['truckingManagerConfirmed']);

              if (confirmedTruck) r4.classList.add('row-confirmed');
              else if (savedTruck) r4.classList.add('saved-price');
              else if (costReceivedTruck) r4.classList.add('cost-received');

              tbody.appendChild(r4);

              // ===== Insert TRUCK sub-lines under TRUCK main row (Sourcing) =====
              const _truckSubs = truckSubsByParent.get(quote) || [];
              _truckSubs.forEach((sub, i) => {
                const subQuote = String(sub['Quotation #'] || '').trim();
                if (!subQuote) return;

                const r4s = document.createElement('tr');
                r4s.dataset.quote = subQuote;
                r4s.dataset.scope = 'TRUCK';
                r4s.className = 'row-truck-val sub-row';

                const baseExt = (item['External Quotation #'] || quote || '').trim();

                // âœ… æ˜¾ç¤ºç”¨è¿ç»­ç¼–å·ï¼š-1, -2, -3 ...ï¼ˆä¸çœ‹çœŸå® -7/-8ï¼‰
                const displaySuffix = `-${i + 1}`;

                // âœ… åªæ”¹æ˜¾ç¤ºï¼Œä¸æ”¹çœŸå® quoteï¼ˆçœŸå® quote ä»ç”¨äºä¿å­˜/åˆ é™¤/æƒé™ï¼‰
                r4s.appendChild(tdCell((baseExt ? (baseExt + displaySuffix) : (quote + displaySuffix)), 'text-center font-semibold nowrap-limit'));

                // âœ… å­è¡Œç»Ÿä¸€é”å®šçŠ¶æ€ï¼ˆä¸€å®šè¦åœ¨ä»»ä½• makeInput ä¹‹å‰å®šä¹‰ï¼‰

                const lockedSub = viewOnly
                  || isTruthy(sub['truckingPriceSaved'])   // âœ… ç”¨ priceSaved
                  || isTruthy(sub['truckingManagerConfirmed'])
                  || isTruthy(sub['truckingSalesConfirmed']);

                // Base Rate (Cost)
                r4s.appendChild(tdCell(fmt2(sub['Base Rate'])));

                // Price / GP â€” âœ… FIX: Use frontend fallback when server hasn't persisted
                // Sub-line may not have Inquiry Type; inherit from parent
                const subForCalc = Object.assign({}, sub);
                if (!subForCalc['Inquiry Type']) subForCalc['Inquiry Type'] = item['Inquiry Type'];
                const { price: calcPriceSub, gp: calcGPSub } = getTruckPriceGP(subForCalc);
                r4s.appendChild(tdCell(calcPriceSub > 0 ? calcPriceSub.toFixed(2) : 'â€”'));

                const gpPercentSub = (calcGPSub !== null && Number.isFinite(calcGPSub)) ? (calcGPSub * 100).toFixed(2) + '%' : 'â€”';
                r4s.appendChild(tdCell(gpPercentSub));

                // Adjusted Priceï¼ˆinputï¼‰
                const adjInpSub = makeInput(sub['Adjusted Price'] || '', 'Adjusted Price', subQuote, lockedSub, 'TRUCK');
                const tdAdjSub = document.createElement('td');
                tdAdjSub.appendChild(adjInpSub);
                r4s.appendChild(tdAdjSub);

                // Adjusted GPï¼ˆæ˜¾ç¤º + å³æ—¶æ›´æ–°ï¼‰
                const tdAdjGPSub = tdCell(sub['Adjusted GP'] || 'â€”');
                r4s.appendChild(tdAdjGPSub);

                adjInpSub.addEventListener('input', () => {
                  const baseRateNum = Number(String(sub['Base Rate'] || '').replace(/,/g, '')) || 0;
                  const ap = Number(String(adjInpSub.value || '').replace(/,/g, '')) || 0;

                  if (ap > 0 && baseRateNum > 0) {
                    const gp = ((ap - baseRateNum) / ap) * 100;
                    tdAdjGPSub.textContent = gp.toFixed(2) + '%';
                  } else {
                    tdAdjGPSub.textContent = 'â€”';
                  }
                });

                // Cost/Price pairsï¼ˆCost æ–‡æœ¬ + Price inputï¼‰
                const pairsSub = [
                  ['Chassis', 'Chassis Price'],
                  ['Pre-Pull', 'Pre-Pull Price'],
                  ['Yard Storage', 'Yard Storage Price'],
                  ['Driver Waiting', 'Driver Waiting Price'],
                  ['Over Weight', 'Over Weight Price'],
                  ['Chassis Split', 'Chassis Split Price'],
                  ['Toll', 'Toll Price'],
                  ['Reefer Fee', 'Reefer Fee Price'],
                  ['Bond Fee', 'Bond Fee Price'],
                ];

                pairsSub.forEach(([cF, pF]) => {
                  r4s.appendChild(tdCell(fmt2(sub[cF])));

                  const pi = makeInput(sub[pF] || '', pF, subQuote, lockedSub, 'TRUCK');
                  const tdP = document.createElement('td');
                  tdP.appendChild(pi);
                  r4s.appendChild(tdP);
                });

                const carInp = makeInput(sub['Carrier'] || '', 'Carrier', subQuote, true, 'TRUCK', true);

                const tdCar = document.createElement('td');
                tdCar.appendChild(carInp);
                r4s.appendChild(tdCar);

                // âœ… FIX: Show Vendor Note on sub-line (was empty placeholder)
                const subVendorNoteFull = String(sub['Vendor Note'] || sub['Carrier Note'] || '').trim();
                const subCleanNote = subVendorNoteFull.replace(/\s+/g, ' ').trim();
                const subVendorNotePreview = subCleanNote.length > 20 ? subCleanNote.substring(0, 20) + '...' : subCleanNote;

                const subVNoteTd = tdCell(subVendorNotePreview, 'text-left note-preview vendor-note-preview');
                subVNoteTd.dataset.fullNote = subVendorNoteFull;
                subVNoteTd.dataset.which = 'VENDOR NOTE';
                r4s.appendChild(subVNoteTd);

                r4s.appendChild(actionCellTruck(sub, subQuote, role));

                if (isTruthy(sub['truckingSalesConfirmed']) || isTruthy(sub['truckingManagerConfirmed'])) {
                  r4s.classList.add('truck-confirmed');
                }


                // ===== çŠ¶æ€æ§åˆ¶ï¼ˆTRUCK å­è¡Œ r4sï¼‰=====
                const confirmedTruckSub =
                  isTruthy(sub['truckingSalesConfirmed']) ||
                  isTruthy(sub['truckingManagerConfirmed']);

                const savedTruckSub = isTruthy(sub['truckingPriceSaved']);
                const costReceivedTruckSub = hasSourcingInput(sub); // âœ… å­è¡Œä¹Ÿå¯ç”¨åŒå‡½æ•°

                if (confirmedTruckSub) {
                  r4s.classList.add('row-confirmed');
                } else if (savedTruckSub) {
                  r4s.classList.add('saved-price');
                } else if (costReceivedTruckSub) {
                  r4s.classList.add('cost-received');
                }



                tbody.appendChild(r4s);
              });

              // 5) WH header
              const r5 = document.createElement('tr');
              r5.className = 'row-wh-head';
              // WH header row
              WH_LEFT_HEADERS.forEach((h, i) => {
                if (i === 0) r5.appendChild(tdHeader(quote, 'text-left')); // âœ… ç”¨ quote
                else r5.appendChild(tdHeader(h));
              });

              // âœ… NEW column (right after Vendor)
              r5.appendChild(tdHeader('EST GP'));

              // NOTE starts 1 column later, so colspan reduced
              const whNoteHead = tdHeader('NOTE');
              whNoteHead.colSpan = 8;
              whNoteHead.classList.add('text-left'); // ä½ è¦å±…ä¸­å°±æ”¹ text-center
              r5.appendChild(whNoteHead);

              // spacer + actionï¼ˆä¿æŒä½ åŸæœ¬çš„ï¼‰
              r5.appendChild(tdHeader(''));
              r5.appendChild(tdHeader('Action'));


              tbody.appendChild(r5);


              // 6) WH values
              const r6 = document.createElement('tr');
              r6.className = 'row-wh-val';

              // âœ… allow lockRow()/style targeting
              r6.dataset.quote = quote;
              r6.dataset.scope = 'WH';

              if (isTruthy(item['warehouseSalesConfirmed'])) {
                r6.classList.add('wh-confirmed');
              }

              const lockedWH = viewOnly
                || isTruthy(item['Saved'])
                || isTruthy(item['warehouseManagerConfirmed'])
                || isTruthy(item['warehouseSalesConfirmed']);


              r6.appendChild(tdCell('')); // col1 blank

              const whPairs = [
                ['Order Processing', 'Order Processing Price'],
                ['Inbound', 'Inbound Price'],
                ['Sorting', 'Sorting Price'],
                ['Palletizing', 'Palletizing Price'],
                ['Pallet Fee', 'Pallet Fee Price'],       // ä¿®æ­£è¿™é‡Œ
                ['Storage', 'Storage Price'],
                ['Outbound', 'Outbound Price'],
              ];


              const whAuto = (costVal, priceVal) => {
                const c = num(costVal);
                const p = String(priceVal ?? '').trim();
                if (p) return p;
                if (c === null) return '';
                return String(Math.round(c * 1.25));
              };
              whPairs.forEach(([cF, pF]) => {
                r6.appendChild(tdCell(fmt2(item[cF])));
                const pi = makeInput(whAuto(item[cF], item[pF]), pF, quote, lockedWH, 'WH');
                const t = document.createElement('td');
                t.appendChild(pi);
                r6.appendChild(t);
              });


              // ===== Vendorï¼ˆè¿™é‡Œå°±æ˜¯ç¬¬16æ ï¼‰=====
              const vendor = makeInput(item['Vendor'] || '', 'Vendor', quote, lockedWH, 'WH', true);
              const tdVendor = document.createElement('td');
              tdVendor.appendChild(vendor);
              r6.appendChild(tdVendor);

              // ===== ç¬¬17æ ï¼šEST GP =====
              const whCostFields = [
                'Order Processing', 'Inbound', 'Sorting',
                'Palletizing', 'Pallet Fee', 'Storage', 'Outbound'
              ];

              const whPriceFields = [
                'Order Processing Price', 'Inbound Price', 'Sorting Price',
                'Palletizing Price', 'Pallet Fee Price',
                'Storage Price', 'Outbound Price'
              ];

              let sumCost = 0;
              let sumPrice = 0;

              // âœ… FIX: Use whAuto values (includes auto-calculated prices) for GP calculation
              whCostFields.forEach((f, idx) => {
                const n = parseFloat(item[f] || 0);
                if (!isNaN(n)) sumCost += n;
                const autoP = parseFloat(whAuto(item[f], item[whPriceFields[idx]]) || 0);
                if (!isNaN(autoP)) sumPrice += autoP;
              });

              let estGpText = 'â€”';
              if (sumPrice > 0) {
                const gp = (sumPrice - sumCost) / sumPrice;
                estGpText = (gp * 100).toFixed(2) + '%';
              }

              const tdEstGP = document.createElement('td');
              tdEstGP.textContent = estGpText;
              tdEstGP.style.textAlign = 'right';
              r6.appendChild(tdEstGP);

              // ===== è§£æ Warehouse Services å­—ç¬¦ä¸² =====
              const whServicesStr = (item['Warehouse Services'] || '').toString().trim();
              const whServicesList = whServicesStr
                ? whServicesStr.split(';').map(s => s.trim()).filter(Boolean)
                : [];


              // ===== 18-25 => NOTE (Warehouse æ±‡æ€»ï¼Œå  9 åˆ—) =====

              // å›¾æ ‡å‡½æ•°
              const icon = (on, emoji) =>
                (String(on).toLowerCase() === 'true' ? emoji : '');

              const haz = icon(item['Hazmat'], 'â˜£ï¸');
              const ree = icon(item['Reefer'], 'â„ï¸');
              const bon = icon(item['Bonded'], 'ğŸ”’');
              const needWHIcon = icon(item['Need Warehouse Service'], 'ğŸ¬');

              // âœ… åŠ è¿™ä¸€è¡Œ
              const iconLine = [needWHIcon, haz, ree, bon].filter(Boolean).join(' ');


              // Warehouse services (multi-select)
              // âœ… 1) Service Detailï¼ˆä¼˜å…ˆæ˜¾ç¤ºå¸¦ Qty/Unit çš„ç‰ˆæœ¬ï¼‰
              const detail = (item['Warehouse Service Detail'] || '').toString().trim();
              const servicesLine =
                detail ||
                (whServicesList.length ? whServicesList.map(s => `âœ… ${s}`).join(' ') : '');

              // âœ… 2) Estimatedï¼ˆæŠŠä½ åŸæ¥é‚£äº›è¾“å…¥æ˜¾ç¤ºå‡ºæ¥ï¼‰
              const estPallets = (item['Estimated Pallets'] || '').toString().trim();
              const estBoxes = (item['Estimated Boxes'] || '').toString().trim();
              const estSku = (item['Estimated SKU Count'] || '').toString().trim();

              const estLine =
                (estPallets || estBoxes || estSku)
                  ? `Est: Pallets ${estPallets || '-'}, Boxes ${estBoxes || '-'}, SKU ${estSku || '-'}`
                  : '';

              // âœ… 3) Storage Duration
              const dur = (item['Storage Duration'] || '').toString().trim();
              const durUnit = (item['Storage Duration Unit'] || '').toString().trim();

              const storageLine =
                (dur || durUnit)
                  ? `Storage: ${dur || '-'} ${durUnit || ''}`.trim()
                  : '';

              // âœ… 4) Warehouse Note æ–‡æœ¬
              const whNote = (item['Warehouse Note'] || '').toString().trim();
              const whNoteLine = whNote ? `WH Note: ${whNote}` : '';

              // âœ… 5) Sourcing Vendor Note (from WH cost entry)
              // âœ… FIX: Use separate 'WH Vendor Note' field (TRUCK uses 'Vendor Note')
              const whVendorNote = (item['WH Vendor Note'] || '').toString().trim();
              const whVendorNoteLine = whVendorNote ? `Vendor Note: ${whVendorNote}` : '';

              const mergedWhNote = [
                iconLine,
                servicesLine,
                estLine,
                storageLine,
                whNoteLine,
              ].filter(Boolean).join(' | ');


              const whFull = (mergedWhNote || '').toString();
              const whPreview = whFull.replace(/\s+/g, ' ').trim(); // âœ… å‹æ‰æ¢è¡Œ

              const whNoteVal = tdCell('', 'text-left note-preview');
              whNoteVal.colSpan = 8;
              whNoteVal.dataset.fullNote = whFull;
              whNoteVal.dataset.which = 'WAREHOUSE NOTE';

              const line2 = document.createElement('div');
              line2.className = 'note-line';
              line2.textContent = whPreview;           // ä¸€è¡Œé¢„è§ˆ
              whNoteVal.appendChild(line2);

              r6.appendChild(whNoteVal);


              // 26 WH Vendor Note (read-only for Sales, same as TRUCK Vendor Note)
              const whVnPreview = whVendorNote.length > 20 ? whVendorNote.substring(0, 20) + '...' : whVendorNote;
              const whVnTd = tdCell(whVnPreview, 'text-left note-preview vendor-note-preview');
              whVnTd.dataset.fullNote = whVendorNote;
              whVnTd.dataset.which = 'VENDOR NOTE (WH)';
              r6.appendChild(whVnTd);

              // 27 Action
              r6.appendChild(actionCellWH(item, quote, role));

              const costReceivedWH = hasSourcingWHInput(item) || ((whSubsByParent.get(quote) || []).some(s => hasSourcingWHInput(s)));
              const savedWH = isTruthy(item['warehousePriceSaved']);
              const confirmedWH =
                isTruthy(item['warehouseSalesConfirmed']) || isTruthy(item['warehouseManagerConfirmed']);

              if (confirmedWH) r6.classList.add('row-confirmed');
              else if (savedWH) r6.classList.add('saved-price');
              else if (costReceivedWH) r6.classList.add('cost-received');


              tbody.appendChild(r6);


              // ===== Insert WAREHOUSE sub-lines under WH main row (Sourcing) =====
              const _whSubs = whSubsByParent.get(quote) || [];
              _whSubs.forEach((sub, i) => {
                const subQuote = String(sub['Quotation #'] || '').trim();
                if (!subQuote) return;

                const r6s = document.createElement('tr');
                r6s.dataset.quote = subQuote;
                r6s.dataset.scope = 'WH';
                r6s.className = 'row-wh-val sub-row';

                const baseExt = (item['External Quotation #'] || quote || '').trim();

                // âœ… æ˜¾ç¤ºç”¨è¿ç»­å­—æ¯ï¼š-A, -B, -C ...
                const displaySuffix = '-' + String.fromCharCode(65 + i);

                r6s.appendChild(tdCell((baseExt ? (baseExt + displaySuffix) : (quote + displaySuffix)), 'text-center font-semibold nowrap-limit'));

                const whPairsSub = [
                  ['Order Processing', 'Order Processing Price'],
                  ['Inbound', 'Inbound Price'],
                  ['Sorting', 'Sorting Price'],
                  ['Palletizing', 'Palletizing Price'],
                  ['Pallet Fee', 'Pallet Fee Price'],
                  ['Storage', 'Storage Price'],
                  ['Outbound', 'Outbound Price'],
                ];

                whPairsSub.forEach(([cF, pF]) => {
                  // Costï¼šæ–‡æœ¬
                  r6s.appendChild(tdCell(fmt2(sub[cF])));

                  // Priceï¼šinputï¼ˆSales å¡«ä»·ï¼‰â€” âœ… FIX: Use whAuto for auto-suggested price (same as main row)
                  const lockedSub = viewOnly
                    || isTruthy(sub['warehousePriceSaved'])
                    || isTruthy(sub['warehouseManagerConfirmed'])
                    || isTruthy(sub['warehouseSalesConfirmed']);

                  const pi = makeInput(whAuto(sub[cF], sub[pF]), pF, subQuote, lockedSub, 'WH');
                  const tdP = document.createElement('td');
                  tdP.appendChild(pi);
                  r6s.appendChild(tdP);
                });

                const venInp = makeInput(sub['Vendor'] || '', 'Vendor', subQuote, true, 'WH', true);
                const tdVen = document.createElement('td');
                tdVen.appendChild(venInp);
                r6s.appendChild(tdVen);

                // ===== å­è¡Œç¬¬17æ ï¼šEST GPï¼ˆåŠ åœ¨è¿™é‡Œï¼‰=====
                const whCostFieldsSub = [
                  'Order Processing', 'Inbound', 'Sorting',
                  'Palletizing', 'Pallet Fee', 'Storage', 'Outbound'
                ];

                const whPriceFieldsSub = [
                  'Order Processing Price', 'Inbound Price', 'Sorting Price',
                  'Palletizing Price', 'Pallet Fee Price',
                  'Storage Price', 'Outbound Price'
                ];

                let sumCostSub = 0;
                let sumPriceSub = 0;

                // âœ… FIX: Use whAuto values (includes auto-calculated prices) for GP calculation
                whCostFieldsSub.forEach((f, idx) => {
                  const n = parseFloat(sub[f] || 0);
                  if (!isNaN(n)) sumCostSub += n;
                  const autoP = parseFloat(whAuto(sub[f], sub[whPriceFieldsSub[idx]]) || 0);
                  if (!isNaN(autoP)) sumPriceSub += autoP;
                });

                let estGpSubText = 'â€”';
                if (sumPriceSub > 0) {
                  const gp = (sumPriceSub - sumCostSub) / sumPriceSub;
                  estGpSubText = (gp * 100).toFixed(2) + '%';
                }

                const tdEstGPSub = document.createElement('td');
                tdEstGPSub.textContent = estGpSubText;
                tdEstGPSub.style.textAlign = 'right';
                r6s.appendChild(tdEstGPSub);

                // ===== ç„¶åæ‰è¿›å…¥ NOTE =====
                // âœ… FIX: Show full WH note (icons, services, estimates) inherited from parent + sub's own notes
                const subWhNote = (sub['Warehouse Note'] || '').toString().trim();
                const subWhNoteLine = subWhNote ? `WH Note: ${subWhNote}` : '';
                const subWhVendorNote = (sub['WH Vendor Note'] || '').toString().trim();
                // Merge parent WH info + sub's own WH Note (Vendor Note goes to column 26)
                const whFullS = [mergedWhNote, subWhNoteLine].filter(Boolean).join(' | ');

                // âœ… FIX: Use note-line div (same as main row) for single-line truncation + click popup
                const whNoteTdS = tdCell('', 'text-left note-preview');
                whNoteTdS.colSpan = 8;
                whNoteTdS.dataset.fullNote = whFullS;
                whNoteTdS.dataset.which = 'WAREHOUSE NOTE';
                const noteLineS = document.createElement('div');
                noteLineS.className = 'note-line';
                noteLineS.textContent = whFullS.replace(/\s+/g, ' ').trim();
                whNoteTdS.appendChild(noteLineS);
                r6s.appendChild(whNoteTdS);

                // 26 WH Vendor Note (column 26)
                const subWhVnPreview = subWhVendorNote.length > 20 ? subWhVendorNote.substring(0, 20) + '...' : subWhVendorNote;
                const subWhVnTd = tdCell(subWhVnPreview, 'text-left note-preview vendor-note-preview');
                subWhVnTd.dataset.fullNote = subWhVendorNote;
                subWhVnTd.dataset.which = 'VENDOR NOTE (WH)';
                r6s.appendChild(subWhVnTd);

                r6s.appendChild(actionCellWH(sub, subQuote, role));

                // ğŸ”¥ åŠ åœ¨è¿™é‡Œ
                if (isTruthy(sub['warehouseSalesConfirmed']) || isTruthy(sub['warehouseManagerConfirmed'])) {
                  r6s.classList.add('wh-confirmed');
                }

                // ===== çŠ¶æ€æ§åˆ¶ï¼ˆWH å­è¡Œ r6sï¼‰=====

                const confirmedWHSub =
                  isTruthy(sub['warehouseSalesConfirmed']) ||
                  isTruthy(sub['warehouseManagerConfirmed']);

                const savedWHSub = isTruthy(sub['warehousePriceSaved']);            // âœ… å­è¡Œï¼šSaved + Priceæœ‰å€¼
                const costReceivedWHSub = hasSourcingWHInput(sub);      // å­è¡Œç”¨ sub

                if (confirmedWHSub) {
                  r6s.classList.add('row-confirmed');
                } else if (savedWHSub) {
                  r6s.classList.add('saved-price');
                } else if (costReceivedWHSub) {
                  r6s.classList.add('cost-received');
                }

                tbody.appendChild(r6s);
              });

            });

            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) pageInfo.textContent = `Page ${currentPage}`;
          };

          // ================= SEARCH SUPPORT =================
          window.searchTerm = '';

          window.applySearchFilter = function (list, term) {
            const t = String(term || '').trim().toLowerCase();
            if (!t) return list;

            const mains = list.filter(it => !String(it['Parent Quotation #'] || '').trim());

            const hit = (it) => {
              const q = String(it['Quotation #'] || '').toLowerCase();
              const zip = String(it['To ZIP'] || '').toLowerCase();
              const to = String(it['To'] || '').toLowerCase();
              return q.includes(t) || zip.includes(t) || to.includes(t);
            };

            const matchedMains = mains.filter(hit);

            const mainKeys = new Set(
              matchedMains.map(it => String(it['Quotation #'] || '').trim())
            );

            const children = list.filter(it => {
              const p = String(it['Parent Quotation #'] || '').trim();
              return p && mainKeys.has(p);
            });

            const seen = new Set();
            const merged = [];
            [...matchedMains, ...children].forEach(it => {
              const q = String(it['Quotation #'] || '').trim();
              if (!q || seen.has(q)) return;
              seen.add(q);
              merged.push(it);
            });

            return merged;
          };


          // Ensure Warehouse block always bound (in case earlier script stopped)
          try {
            const whChk = document.getElementById('needWarehouseService');
            if (whChk && typeof window.refreshWarehouseBlock === 'function') {
              whChk.addEventListener('change', window.refreshWarehouseBlock);
              window.refreshWarehouseBlock();
            }
          } catch (e) { }

        })();


        // ===============================
        // âœ… Main loader (required for Summary)
        // ===============================
        window.pageSize = 100;
        window.currentPage = 1;
        window.filteredData = [];
        window.currentUser = '';
        window.userRole = '';

        window.getCurrentUser = async function () {
          const res = await fetch('/user');
          if (!res.ok) {
            alert('âŒ Not logged in. Please login again.');
            window.location.href = '/index.html';
            return;
          }
          const userInfo = await res.json();
          window.userRole = userInfo.role;
          window.currentUser = (userInfo.username || '').trim();

          const nameEl = document.getElementById('usernameDisplay');
          if (nameEl) nameEl.textContent = window.currentUser;

          const reqHidden = document.querySelector('[name="requestedBy"]');
          const reqDisplay = document.querySelector('[name="requestedByDisplay"]');
          if (reqHidden) reqHidden.value = window.currentUser;
          if (reqDisplay) reqDisplay.value = window.currentUser;
        };

        window.loadInquiries = async function () {
          try {
            const res = await fetch('/inquiries', { credentials: 'same-origin' });

            const raw = await res.text(); // âœ… å…ˆè¯» textï¼Œé¿å… json() ç›´æ¥ç‚¸
            let data = null;

            try {
              data = JSON.parse(raw);
            } catch (err) {
              console.error('âŒ /inquiries returned NON-JSON:', raw.slice(0, 500));
              alert(`ğŸš¨ Load failed: /inquiries returned non-JSON (status ${res.status}).\n\n` +
                raw.slice(0, 220));
              return;
            }

            if (!res.ok) {
              console.error('âŒ /inquiries not ok:', res.status, data);
              alert(`ğŸš¨ Load failed: /inquiries status ${res.status}\n\n` +
                JSON.stringify(data).slice(0, 220));
              return;
            }

            if (!Array.isArray(data)) {
              console.error('ğŸš¨ Inquiry data invalid (not array):', data);
              alert('ğŸš¨ Inquiry data invalid (not array).');
              return;
            }

            window.filteredData = data;

            // âœ… Search
            window.filteredData = window.applySearchFilter(window.filteredData, window.searchTerm);

            // âœ… Sortï¼ˆä¿æŒä½ åŸæœ‰æ’åºé€»è¾‘å³å¯ï¼‰
            window.filteredData.sort((a, b) => {
              const qa = String(a['Quotation #'] || '');
              const qb = String(b['Quotation #'] || '');

              const aIsChild = String(a['Parent Quotation #'] || '').trim() !== '';
              const bIsChild = String(b['Parent Quotation #'] || '').trim() !== '';

              if (!aIsChild && bIsChild) return -1;
              if (aIsChild && !bIsChild) return 1;

              return qb.localeCompare(qa, undefined, { numeric: true, sensitivity: 'base' });
            });

            if (typeof window.renderPage === 'function') {
              window.renderPage();
            } else {
              console.error('renderPage is not a function');
              alert('âŒ renderPage missing.');
            }
          } catch (e) {
            console.error('Failed to load inquiries:', e);
            alert('ğŸš¨ Load failed: ' + (e.message || e));
          }
        };

        function applyLayoutMode() {
          const isFS = !!document.fullscreenElement;
          document.body.classList.toggle('fullscreen-mode', isFS);

          // âœ… ä½ çš„éœ€æ±‚ï¼šéå…¨å±éšè— Formï¼Œå…¨å±æ˜¾ç¤º Form
          document.body.classList.toggle('summary-only', !isFS);

          // å¦‚æœå…¨å±æ—¶ä½ ä¹Ÿæƒ³é»˜è®¤æ”¶èµ· Formï¼ˆå¯é€‰ï¼‰ï¼Œå°±æŠŠä¸‹é¢æ³¨é‡Šå»æ‰ï¼š
          // if (isFS) document.getElementById('formGroup')?.classList.add('hidden');
        }
        // applyLayoutMode(); // âœ… disabled (kept for reference)
        // document.addEventListener('fullscreenchange', applyLayoutMode); // âœ… disabled
        window.addEventListener('resize', applyLayoutMode);

        window.setMode = function (mode) {
          document.body.classList.remove('mode-inquiry', 'mode-summary');
          document.body.classList.add(mode === 'summary' ? 'mode-summary' : 'mode-inquiry');
        };


        document.addEventListener('DOMContentLoaded', async () => {
          // 1) user
          await window.getCurrentUser();

          // âœ… OPS view-only: hide inquiry form, show badge
          const isOPS = String(window.userRole || '').toLowerCase() === 'ops_view';
          if (isOPS) {
            const formGroup = document.getElementById('formGroup');
            if (formGroup) formGroup.style.display = 'none';
            const nameEl = document.getElementById('usernameDisplay');
            if (nameEl) {
              nameEl.innerHTML = nameEl.textContent + ' <span style="background:#ef4444;color:#fff;font-size:11px;padding:2px 8px;border-radius:10px;margin-left:6px;">View Only</span>';
            }
          }

          // 2) load data + render
          if (typeof window.loadInquiries === 'function') {
            await window.loadInquiries();
          }
          try {
            const socket = io();
            socket.on('inquiryUpdated', async () => {
              // âœ… FIX: Skip reload if this page just saved (prevents clearing unsaved sub-line inputs)
              if (window._selfUpdateUntil && Date.now() < window._selfUpdateUntil) {
                console.log('[socket] skipping reload (self-update window)');
                return;
              }
              if (typeof window.loadInquiries === 'function') {
                await window.loadInquiries();
              }
            });
          } catch (e) {
            console.warn('socket disabled', e);
          }

          window.setMode?.('inquiry');            // âœ… é»˜è®¤éšè— Summary
          document.getElementById('fixed-scroll-wrapper')?.scrollTo(0, 0); // å¯é€‰

          document.body.classList.add('inquiry-only');
          document.body.classList.remove('summary-only');

          // ===== Top buttons hard-bind (debug + fix) =====
          const btnToggle = document.getElementById('toggleInquiry');
          const btnPrev = document.getElementById('prevPage');
          const btnNext = document.getElementById('nextPage');
          const btnExit = document.getElementById('exitBtn');
          const formGroup = document.getElementById('formGroup');

          function setMode(mode) {
            if (mode === 'summary') {
              document.body.classList.remove('mode-inquiry');
              document.body.classList.add('mode-summary');
              // å¯é€‰ï¼šæŒ‰é’®å›¾æ ‡å˜â€œå›åˆ°è¡¨å•â€
              if (btnToggle) btnToggle.textContent = 'ğŸ“';
            } else {
              document.body.classList.remove('mode-summary');
              document.body.classList.add('mode-inquiry');
              // å¯é€‰ï¼šæŒ‰é’®å›¾æ ‡å˜â€œæŸ¥çœ‹Summaryâ€
              if (btnToggle) btnToggle.textContent = 'ğŸ“Š';
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          }

          document.getElementById('toggleInquiry')?.addEventListener('click', () => {
            const isSummary = document.body.classList.contains('mode-summary');
            window.setMode?.(isSummary ? 'inquiry' : 'summary');
          });

          document.addEventListener('fullscreenchange', () => {
            // ç”¨æˆ·æŒ‰ ESC é€€å‡ºå…¨å±ï¼Œä¹Ÿè‡ªåŠ¨å› Inquiry
            if (!document.fullscreenElement) {
              document.body.classList.remove('summary-only');
              document.body.classList.add('inquiry-only');
            }
          });

          btnExit?.addEventListener('click', () => {
            console.log('[TOP] exit clicked');
            window.location.href = '/index.html';
          });

          // 3) warehouse checkbox bind + initial sync
          const whChk = document.getElementById('needWarehouseService');
          if (whChk) whChk.addEventListener('change', window.refreshWarehouseBlock);
          window.refreshWarehouseBlock();
        });

        document.querySelectorAll('input[name="whService"]').forEach(chk => {
          const svc = chk.value;
          const qty = document.querySelector(`input[name="whQty_${svc}"]`);
          const unit = document.querySelector(`input[name="whUnit_${svc}"]`);
          if (!qty || !unit) return;

          const sync = () => {
            const on = chk.checked;
            qty.disabled = !on;
            unit.disabled = !on;
            if (!on) { qty.value = ''; unit.value = ''; }
          };

          chk.addEventListener('change', sync);
          sync();
        });

        document.getElementById('inquiryForm').addEventListener('submit', async function (e) {
          e.preventDefault();

          // âœ… OPS view-only cannot create inquiries
          if (String(window.userRole || '').toLowerCase() === 'ops_view') {
            alert('OPS is view-only and cannot create inquiries.');
            return;
          }

          // 1) å–è¡¨å•æ•°æ®
          const form = this;
          const fd = new FormData(form);
          const entry = Object.fromEntries(fd.entries());

          // 2) å¤šé€‰ Warehouse Services
          const selectedServices = Array.from(form.querySelectorAll('input[name="whService"]:checked')).map(x => x.value);

          // âœ… 2.1) ç»„è£…æ¯ä¸ªæœåŠ¡çš„ Qty/Unit æ–‡æœ¬ï¼ˆå…ˆç®—å‡ºæ¥ï¼‰
          const svcLines = selectedServices.map(svc => {
            const qtyEl = form.querySelector(`input[name="whQty_${svc}"]`);
            const unitEl = form.querySelector(`input[name="whUnit_${svc}"]`);

            const qty = (qtyEl?.value || '').trim();
            const unit = (unitEl?.value || '').trim();

            if (!qty && !unit) return `âœ… ${svc}`;
            return `âœ… ${svc}: ${qty || '-'} ${unit || ''}`.trim();
          }).filter(Boolean);

          const serviceDetail = svcLines.join(' | ');


          // 3) checkbox
          const hazmat = form.querySelector('input[name="hazmat"]')?.checked ? 'true' : 'false';
          const reefer = form.querySelector('input[name="reefer"]')?.checked ? 'true' : 'false';
          const bonded = form.querySelector('input[name="bonded"]')?.checked ? 'true' : 'false';
          const needWH = form.querySelector('input[name="needWarehouseService"]')?.checked ? 'true' : 'false';

          // 4) æ‹¼ To
          const toCity = (entry.toCity || '').trim();
          const toState = (entry.toState || '').trim();
          const toZip = (entry.toZip || '').trim();
          const composedTo = [toCity, [toState, toZip].filter(Boolean).join(' ')].filter(Boolean).join(', ');

          // âœ… 5) å…³é”®ï¼šæŠŠå­—æ®µæ˜ å°„æˆ Summary/ç³»ç»Ÿä½¿ç”¨çš„ keyï¼ˆå¸¦ç©ºæ ¼çš„å¤§å†™ï¼‰
          const newInquiry = {
            'Date': new Date().toLocaleDateString(),

            'Customer ID': entry.customerId || '',
            'Requested By': window.currentUser || '',
            'username': window.currentUser || '',

            'Inquiry Type': entry.inquiryType || '',
            'Container Size': entry.containerSize || '',
            'Dry Van Type': entry.dryVanType || '',
            'Legal or Over Weight': entry.legalOverWeight || '',
            'Gross Weight': entry.grossWeight || '',
            'Live or Drop': entry.liveOrDrop || '',
            'From': entry.from || '',

            'To City': toCity,
            'To State': toState,
            'To ZIP': toZip,
            'To': composedTo,

            'QTY': entry.qty || '',
            'Quotation #': entry.quotationId || '',

            // Cargo
            'Commodity': entry.commodity || '',
            'Package Type': entry.packageType || '',
            'Packages Per Container': entry.packagesPerContainer || '',
            'Hazmat': hazmat,
            'Reefer': reefer,
            'Bonded': bonded,

            // Warehouse block
            'Need Warehouse Service': needWH,
            'Warehouse Services': selectedServices.join('; '),
            'Warehouse Service Detail': serviceDetail,   // âœ… åŠ è¿™ä¸€è¡Œ
            'Estimated Pallets': entry.estimatedPallets || '',
            'Estimated Boxes': entry.estimatedBoxes || '',
            'Estimated SKU Count': entry.estimatedSkuCount || '',
            'Storage Duration': entry.storageDuration || '',
            'Storage Duration Unit': entry.storageDurationUnit || '',
            'Warehouse Note': entry.warehouseNote || '',

            // General note
            'Note': entry.note || '',

            // default flags
            'Saved': 'false',
            'truckingPriceSaved': 'false',
            'warehousePriceSaved': 'false',
            'truckingSalesConfirmed': 'false',
            'truckingManagerConfirmed': 'false',
            'warehouseSalesConfirmed': 'false',
            'warehouseManagerConfirmed': 'false'
          };

          try {
            const res = await fetch('/inquiries', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(newInquiry)
            });

            const result = await res.json();
            if (result.success) {
              alert('âœ… Inquiry submitted successfully!');
              form.reset();
              window.refreshWarehouseBlock?.();
              await window.loadInquiries?.();
            } else {
              alert('âŒ Submit failed: ' + (result.message || 'Unknown error'));
            }
          } catch (err) {
            console.error(err);
            alert('âŒ Network error: ' + err.message);
          }
        });

        (function setupNoteViewerModal() {
          const modal = document.getElementById('noteModal');
          const input = document.getElementById('noteModalInput');
          const saveBtn = document.getElementById('noteModalSave');
          const titleEl = modal?.querySelector('h2');

          if (!modal || !input) return;

          // Salesç«¯ï¼šåªè¯»æŸ¥çœ‹
          if (saveBtn) saveBtn.style.display = 'none';
          input.setAttribute('readonly', 'readonly');

          function openModal(text, which) {
            if (titleEl) titleEl.textContent = which || 'NOTE';
            input.value = text || '';
            modal.classList.remove('hidden');
            document.body.classList.add('no-body-scroll');
          }
          function closeModal() {
            modal.classList.add('hidden');
            input.value = '';
            document.body.classList.remove('no-body-scroll');
          }

          modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
          });

          document.addEventListener('click', (e) => {
            const td = e.target.closest('#summaryTable td.note-preview');
            if (!td) return;
            openModal(td.dataset.fullNote || td.textContent || '', td.dataset.which || 'NOTE');
          });
        })();

        // ===== Inquiry Edit/Save handlers =====
        // ===== Inquiry Edit/Save handlers =====

        // âœ… æ”¾åœ¨å¤–é¢ï¼šåªå®šä¹‰ä¸€æ¬¡ï¼ˆä¸è¦æ¯æ¬¡ click éƒ½é‡æ–°å®šä¹‰ï¼‰
        function setWorking(btn, on) {
          if (!btn) return;
          btn.classList.toggle('working', !!on);
        }
        function flashDone(btn) {
          if (!btn) return;
          btn.classList.add('done');
          setTimeout(() => btn.classList.remove('done'), 700);
        }

        document.addEventListener('click', async (e) => {
          const editBtn = e.target.closest('button.btn-edit-inquiry');
          const saveBtn = e.target.closest('button.btn-save-inquiry');
          const submitSourcingBtn = e.target.closest('button.btn-submit-sourcing');

          if (!editBtn && !saveBtn && !submitSourcingBtn) return;

          // âœ… ç”¨å“ªä¸ªæŒ‰é’®ç‚¹çš„ï¼Œå°±ç”¨å“ªä¸ªæŒ‰é’®æ‰¾ quote
          const activeBtn = editBtn || saveBtn || submitSourcingBtn;
          const quote = activeBtn?.dataset?.quote;
          if (!quote) return;

          // âœ… å…³é”®ä¿®å¤ï¼šsubmit ä¹Ÿèƒ½æ­£ç¡®æ‰¾åˆ° tr
          const tr = activeBtn.closest('tr');
          if (!tr) return;

          const fields = tr.querySelectorAll('.inq-field');

          // --- ç‚¹å‡» SUBMIT TO SOURCING (customer portal only) ---
          if (submitSourcingBtn) {
            const external = prompt('Please enter External Quotation # (required before submitting to sourcing):');
            if (!external || !external.trim()) {
              alert('External Quotation # is required.');
              return;
            }

            const payload = {
              'Quotation #': quote,
              'Saved': 'true',
              'External Quotation #': external.trim(),
              'Submitted To Sourcing': 'true',
              'Submitted To Sourcing At': new Date().toISOString()
            };

            setWorking(submitSourcingBtn, true);
            try {
              const res = await fetch('/inquiries/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              const text = await res.text();
              if (!res.ok) {
                alert('âŒ Submit to Sourcing failed: ' + text);
                return;
              }

              // âœ… æˆåŠŸåé¦ˆï¼šé—ªç»¿ + éšè—ğŸ“¤
              flashDone(submitSourcingBtn);
              submitSourcingBtn.style.display = 'none';

              await window.loadInquiries?.();
            } catch (err) {
              console.error(err);
              alert('âŒ Network error: ' + err.message);
            } finally {
              setWorking(submitSourcingBtn, false);
            }
            return;
          }

          // --- ç‚¹å‡» EDIT ---
          if (editBtn) {
            fields.forEach(inp => {
              if (inp.dataset.allowEdit === '1') inp.disabled = false;
            });

            // æŒ‰é’®åˆ‡æ¢ï¼šéšè—ğŸ“ï¼Œæ˜¾ç¤ºğŸ’¾
            editBtn.style.display = 'none';
            const s = tr.querySelector('button.btn-save-inquiry');
            if (s) s.style.display = 'inline-flex';
            return;
          }

          // --- ç‚¹å‡» SAVE ---
          if (saveBtn) {
            const payload = { 'Quotation #': quote, 'Saved': 'true' };
            fields.forEach(inp => {
              if (inp.dataset.allowEdit === '1') {
                payload[inp.dataset.key] = inp.value;
              }
            });

            setWorking(saveBtn, true);
            try {
              const res = await fetch('/inquiries/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              const text = await res.text();
              if (!res.ok) {
                alert('âŒ Save failed: ' + text);
                return;
              }

              // âœ… æˆåŠŸåé¦ˆï¼šé—ªç»¿
              flashDone(saveBtn);

              // ä¿å­˜æˆåŠŸï¼šé”å›å»
              fields.forEach(inp => {
                if (inp.dataset.allowEdit === '1') inp.disabled = true;
              });

              // æŒ‰é’®åˆ‡å›ï¼šéšè—ğŸ’¾ï¼Œæ˜¾ç¤ºğŸ“
              saveBtn.style.display = 'none';
              const ed = tr.querySelector('button.btn-edit-inquiry');
              if (ed) ed.style.display = 'inline-flex';

            } catch (err) {
              console.error('Save inquiry failed:', err);
              alert('Save inquiry failed: ' + err.message);
            } finally {
              setWorking(saveBtn, false);
            }
          }
        });

        document.getElementById('searchBtn')?.addEventListener('click', async () => {
          window.searchTerm = document.getElementById('searchBox')?.value || '';
          await window.loadInquiries();
        });

        document.getElementById('clearSearchBtn')?.addEventListener('click', async () => {
          const box = document.getElementById('searchBox');
          if (box) box.value = '';
          window.searchTerm = '';
          await window.loadInquiries();
        });



      </script>
</body>

</html>