<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sourcing Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    table,
    tbody,
    tr {
      background-color: white !important;
      transition: background-color 0.3s;
    }

    body {
      font-family: "PingFang SC", "Helvetica Neue", Helvetica, "Segoe UI", Roboto, Arial, sans-serif;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: auto;
      overflow-y: scroll;
    }

    #inquiryForm {
      font-size: 1rem;
      line-height: 1.5rem;
    }

    #inquiryForm input,
    #inquiryForm select,
    #inquiryForm textarea {
      font-size: 1rem;
      line-height: 1.5rem;
      padding: 0.5rem 0.75rem;

    }

    /* ğŸ¯ é¼ æ ‡æ‚¬åœæ—¶è¾“å…¥æ¡†èƒŒæ™¯å˜åŒ– */
    #inquiryForm input:hover,
    #inquiryForm select:hover,
    #inquiryForm textarea:hover {
      background-color: #f0f9ff;
      transition: background-color 0.2s ease;
    }

    /* ğŸ¯ é¼ æ ‡ç‚¹å‡»æ—¶è¾¹æ¡†æµ®ç°åŠ¨æ„Ÿ */
    #inquiryForm input:focus,
    #inquiryForm select:focus,
    #inquiryForm textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px #bfdbfe;
      background-color: #fff;
    }

    /* ğŸ¯ æ‰€æœ‰æ ¼å­æœ‰å¹³æ»‘åŠ¨ç”» */
    #inquiryForm input,
    #inquiryForm select,
    #inquiryForm textarea {
      transition: all 0.2s ease-in-out;
    }

    /* ğŸ¯ Submit æŒ‰é’®åŠ¨æ•ˆ */
    #inquiryForm button[type="submit"] {
      transition: all 0.2s ease-in-out;
      transform: scale(1);
    }

    #inquiryForm button[type="submit"]:hover {
      background-color: #2563eb;
      transform: scale(1.03);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }


    .row-basic-head td,
    .row-truck-head td,
    .row-wh-head td {
      font-size: 11px;
      letter-spacing: 0.2px;
    }


    /* BASIC åˆå¹¶ NOTE å…è®¸æ¢è¡Œï¼ˆå·²åœç”¨ï¼šæ”¹æˆä¸€è¡Œé¢„è§ˆ + ç‚¹å‡»å¼¹çª—ï¼‰
.row-basic-val td[colspan="8"] {
  white-space: normal !important;
  word-break: break-word;
  line-height: 1.4;
}
*/

    /* è¡¨å¤´è¡Œï¼ˆæ¯ç¥¨é‡å¤çš„é‚£ä¸‰æ¡ headerï¼‰ */
    .row-basic-head td,
    .row-truck-head td,
    .row-wh-head td {
      font-weight: 700;
      white-space: nowrap;
      background: #f3f4f6;
      /* æµ…ç° */
      border-top: 2px solid #9ca3af;
      /* æ¯ä¸ªåŒºå—ä¸Šæ–¹ç²—çº¿ */
    }

    /* BASIC å€¼è¡Œ */
    .row-basic-val td {
      background: #ffffff;
    }

    /* TRUCK åŒºå—ï¼šæ·¡è“ */
    .row-truck-head td {
      background: #f0f9ff;
    }

    /* header æ›´è“ */
    .row-truck-val td {
      background: #f0f9ff;
    }

    /* value æ›´æ·¡ */

    /* WH åŒºå—ï¼šæ·¡é»„ */
    .row-wh-head td {
      background: #fcf9e0;
    }

    .row-wh-val td {
      background: #fcf9e0;
    }


    /* æ¯ç¥¨ä¹‹é—´çš„åˆ†éš” */
    .row-sep td {
      border: none !important;
      height: 14px;
      background: transparent;
    }


    #fixed-scroll-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 350px);
      width: 100%;
      padding-bottom: 1rem;
      margin: 1rem;
      border: 1px solid #d1d5db;
    }


    .saved-row .saved-row .action-button,
    .saved-row .checkbox-wrapper {
      opacity: 0.5;
      pointer-events: none;
    }

    .action-button-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0.25rem;
    }

    .action-button {
      height: 1.5rem;
      width: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      background-color: #f1f5f9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.15s ease-in-out;
      transform: scale(1);
      font-size: 1rem;
    }

    .action-button:hover {
      transform: none;
      background-color: #e2e8f0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 0.8rem;
      width: 0.8rem;
    }

    .nowrap-limit {
      white-space: nowrap;
      max-width: 25ch;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .saved-input {
      background-color: #dbeafe !important;
      /* locked input blue */
      border-color: #bfdbfe !important;
      color: #374151 !important;
    }

    .low-gp {
      color: red !important;
    }

    #scroll-inner {
      width: fit-content;
      min-width: 100%;
      overflow-x: auto;
      overflow-y: visible;
    }

    #main-content {
      padding: 0.125rem;
      position: relative;
      z-index: 1000;
    }

    .header-section {
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 0.25rem;
    }

    select,
    input,
    textarea,
    button {
      margin-right: 0.5rem;
      padding: 0.25rem;
    }

    .main-button {
      color: white;
      background: linear-gradient(to bottom right, #3b82f6, #2563eb);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      font-weight: 700;
      min-width: 6rem;
      text-align: center;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .main-button:hover {
      background: linear-gradient(to bottom right, #2563eb, #1d4ed8);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .price-input {
      width: 3rem;
      height: 1rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.4rem;
      text-align: right;
    }

    .form-group {
      max-height: 75vh;
      overflow-y: auto;
      overflow-x: hidden;
      transition: max-height 0.4s ease;
    }


    .toggle-inquiry {
      position: fixed;
      top: 80px;
      right: 20px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 0.4rem 1rem;
      font-size: 0.75rem;
      cursor: pointer;
      z-index: 100;
    }

    tr.highlighted {
      background-color: #dbeafe !important;
    }

    tr.highlighted-sourcing {
      background-color: #dbeafe !important;
    }


    tr.highlighted-sourcing td {
      background-color: #dbeafe !important;
    }

    tr.highlighted td {
      border: 1px solid #d1d5db;
    }

    tr.highlighted td {
      background-color: #dbeafe !important;
    }


    #inquiryForm input:not([type='checkbox']),
    #inquiryForm select,
    #inquiryForm textarea {
      text-align: left !important;
    }

    input[type='text'],
    input[type='number'] {
      padding-right: 0.4rem;
    }

    input.price-input {
      text-align: right !important;
    }

    td[data-field='GP'],
    td[data-field='Adjusted GP'] {
      font-size: 0.875rem;
      height: 2.25rem;
      vertical-align: middle;
      padding: 0.25rem 0.5rem;
      text-align: right;
    }

    tr.bg-blue-100 td {
      border: 1px solid #d1d5db;
    }

    td[data-field="Note"] {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 30ch;
      text-align: left !important;
      padding: 0.25rem;
    }

    #noteModalInput {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
      line-height: 1.5;
      width: 100%;
      max-width: 100%;
    }


    tr {
      transition: background-color 0.3s;
    }

    table {
      background-color: white;
    }

    th {
      background-color: lightgray;
    }

    body.no-body-scroll {
      overflow: hidden;
    }

    /* V2 Warehouse Requirement block */
    .section-title {
      font-weight: 700;
      color: #111827;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .tiny-note {
      font-size: 0.75rem;
      color: #6b7280;
    }

    /* å›ºå®šæ¯ä¸€è¡Œçš„åŸºç¤é«˜åº¦ï¼ˆä½ å¯æ”¹ 44/48ï¼‰ */
    #summaryBody tr {
      height: 26px;
    }


    /* ===== FINAL: Auto width by content + adjustable NOTE ===== */
    :root {
      --noteWidth: 300px;
    }


    /* ===== Status colors (Sourcing) ===== */

    /* 0) Default value rows: white */
    #summaryTable tr.row-truck-val td,
    #summaryTable tr.row-wh-val td,
    #summaryTable tr.row-basic-val td {
      background: #ffffff !important;
    }

    /* 1) NEW inquiry: whole row light yellow */
    #summaryTable tr.new-inquiry td {
      background: #fff7d6 !important;
    }

    /* 2) COST saved (but not sent): input cells blue (row stays white) */
    #summaryTable tr.cost-saved td input {
      background: #dbeafe !important;
      border-color: #bfdbfe !important;
    }


    /* 3) COST sent by Sourcing: whole row light blue */
    #summaryTable tr.row-sent td {
      background: #e0f2fe !important;
    }

    /* 4) Confirmed by Sales or Manager: whole row deeper blue */
    #summaryTable tr.row-confirmed td {
      background: #cfe8ff !important;
    }

    /* 5) Freeze # and ACTION always gray (override any row state) */
    #summaryTable td:first-child,
    #summaryTable th:first-child,
    #summaryTable td:last-child,
    #summaryTable th:last-child {
      background: #e5e7eb !important;
    }

    /* å¼ºåˆ¶ Note Modal æ°¸è¿œå±…ä¸­ä¸”è¦†ç›–å…¨å± */
    #noteModal {
      position: fixed !important;
      inset: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 99999 !important;
    }

    /* éšè—çŠ¶æ€ä»ç„¶ hidden */
    #noteModal.hidden {
      display: none !important;
    }

    /* å¼¹çª—ç›’å­é™åˆ¶å¤§å°å¹¶å±…ä¸­ */
    #noteModal>div {
      max-width: min(720px, 92vw) !important;
      max-height: 80vh !important;
      overflow: auto !important;
    }

    .header-section {
      position: relative;
      z-index: 9999;
    }

    /* ç»Ÿä¸€è¡¨æ ¼è¡Œé«˜åº¦ */
    #summaryTable td,
    #summaryTable th {
      padding-top: 6px !important;
      padding-bottom: 6px !important;
      line-height: 1.2 !important;
    }


    /* ä»…ç”¨äº Commodity / From / Toï¼šæ ¹æ®å†…å®¹è‡ªåŠ¨å˜å®½ï¼ˆä¼šæ’‘åˆ—ï¼‰ */
    #summaryTable input.auto-grow {
      width: auto !important;
      /* å…³é”®ï¼šä¸è¦ 100% */
      min-width: 6ch !important;
      /* èµ·æ­¥å®½åº¦ */
      box-sizing: content-box !important;
    }

    /* input è´´æ»¡æ ¼å­ï¼Œä½†ä¸æŠŠåˆ—æ’‘å®½ */
    #summaryTable input {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    /* Commodity / From / To å…è®¸è‡ªåŠ¨æ’‘åˆ— */
    #summaryTable input.auto-grow {
      width: auto !important;
      max-width: none !important;
      min-width: 6ch !important;
      box-sizing: content-box !important;
    }

    /* ===== Alignment Reset (final override) ===== */

    /* 1) æ‰€æœ‰è¡¨å¤´å†…å®¹å±…ä¸­ */
    #summaryTable th,
    #summaryTable .row-basic-head td,
    #summaryTable .row-truck-head td,
    #summaryTable .row-wh-head td {
      text-align: center !important;
    }

    /* 2) æ‰€æœ‰å¡«å†™å†…å®¹é»˜è®¤å±…ä¸­ï¼ˆæ–‡å­—ä¸è¾“å…¥æ¡†ï¼‰ */
    #summaryTable td {
      text-align: center !important;
    }

    #summaryTable input,
    #summaryTable textarea,
    #summaryTable select {
      text-align: center !important;
    }

    /* 3) FROM & TO å¡«å†™å†…å®¹é å³ï¼ˆä»… BASIC ç¬¬äºŒè¡Œçš„ inq-fieldï¼‰ */
    #summaryTable input.inq-field[data-key="From"],
    #summaryTable input.inq-field[data-key="To"] {
      text-align: right !important;
    }

    /* 4) NOTE å†…å®¹å±…å·¦ï¼ˆå« GENERAL NOTE / WAREHOUSE NOTE å±•ç¤ºæ ¼ï¼‰ */
    #summaryTable td.note-preview,
    #summaryTable td.note-block {
      text-align: left !important;
    }

    /* 5) æ‰€æœ‰ COST & PRICE åŠ GP é å³ */
    /* 5.1 æ‰€æœ‰å¸¦ data-field çš„è¾“å…¥æ¡†ï¼šCost/Price/GP ç»Ÿä¸€é å³ */
    #summaryTable input[data-field*="Cost"],
    #summaryTable input[data-field*="Price"],
    #summaryTable input[data-field*="GP"] {
      text-align: right !important;
    }

    /* 5.2 TRUCK/WH æ•°å­—å±•ç¤ºå•å…ƒæ ¼ï¼ˆé input çš„çº¯æ•°å­—ï¼‰ä¹Ÿé å³ */
    #summaryTable tr.row-truck-val td,
    #summaryTable tr.row-wh-val td {
      text-align: right !important;
    }

    /* ä½†ï¼šTRUCK/WH é‡Œ NOTE ä»è¦é å·¦ã€Action ä»å±…ä¸­ã€Carrier/Vendor ä»å±…ä¸­ */
    #summaryTable tr.row-truck-val td.note-preview,
    #summaryTable tr.row-wh-val td.note-preview,
    #summaryTable tr.row-truck-val td.note-block,
    #summaryTable tr.row-wh-val td.note-block {
      text-align: left !important;
    }

    #summaryTable tr.row-truck-val td:last-child,
    #summaryTable tr.row-wh-val td:last-child {
      text-align: center !important;
    }

    #summaryTable input[data-field="Carrier"],
    #summaryTable input[data-field="Vendor"] {
      text-align: center !important;
    }

    /* BASIC ç¬¬äºŒè¡Œ input é»˜è®¤å®Œå…¨é€æ˜ */
    #summaryTable tr.row-basic-val input.inq-field {
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }

    /* è®©æ–‡å­—å¯¹é½ä¸€è‡´ */
    #summaryTable tr.row-basic-val input.inq-field:disabled {
      color: inherit !important;
      cursor: default;
    }

    /* å½“è§£é”ç¼–è¾‘æ—¶æ‰æ˜¾ç¤ºè¾¹æ¡† */
    #summaryTable tr.row-basic-val input.inq-field:not(:disabled) {
      border: 0.5px solid #60a5fa !important;
      background: #ffffff !important;
    }

    /* ===== BASIC ç¬¬äºŒè¡Œå¯¹é½è§„åˆ™ ===== */

    /* é»˜è®¤ï¼šå…¨éƒ¨å±…ä¸­ */
    #summaryTable tr.row-basic-val td {
      text-align: center !important;
    }

    /* Commodityï¼šå†…å®¹å±…ä¸­ */
    #summaryTable tr.row-basic-val td[data-field="Commodity"] {
      text-align: center !important;
    }

    #summaryTable tr.row-basic-val td[data-field="Commodity"] input {
      text-align: center !important;
    }

    /* From / Toï¼šå†…å®¹é å³ */
    #summaryTable tr.row-basic-val td[data-field="From"],
    #summaryTable tr.row-basic-val td[data-field="To"] {
      text-align: right !important;
    }

    #summaryTable tr.row-basic-val td[data-field="From"] input,
    #summaryTable tr.row-basic-val td[data-field="To"] input {
      text-align: right !important;
    }

    /* ===== Freeze # (left) and ACTION (right) ===== */
    #summaryTable th:first-child,
    #summaryTable td:first-child {
      position: sticky !important;
      left: 0 !important;
      z-index: 20 !important;
      background: #d1d5db !important;
      /* æ·±ç°åº• */
    }

    #summaryTable th:last-child,
    #summaryTable td:last-child {
      position: sticky !important;
      right: 0 !important;
      z-index: 20 !important;
      background: #e5e7eb;
      /* æ·±ç°åº• */
      box-shadow: -6px 0 6px rgba(0, 0, 0, 0.08) !important;
    }

    /* è®©è¡¨å¤´åœ¨å†»ç»“åˆ—ä¸Šæ–¹æ›´ç¨³ */
    #summaryTable .row-basic-head td:first-child,
    #summaryTable .row-truck-head td:first-child,
    #summaryTable .row-wh-head td:first-child,
    #summaryTable .row-basic-head td:last-child,
    #summaryTable .row-truck-head td:last-child,
    #summaryTable .row-wh-head td:last-child {
      z-index: 30 !important;
    }

    /* åªæœ‰é”å®šï¼ˆsaved-inputï¼‰æ‰ç»™é¢œè‰²ï¼›è§£é”ç¼–è¾‘å°±ç™½åº• */
    #summaryTable tr.row-wh-val input.saved-input {
      background: #dbeafe !important;
      border-color: #bfdbfe !important;
    }

    #summaryTable tr.row-wh-val input:not(.saved-input) {
      background: #ffffff !important;
    }


    #summaryTable td.note-preview {
      cursor: pointer;
    }

    .row-basic-head td {
      border-top: 5px solid #afb5bd !important;
    }

    #summaryTable td {
      border-right: 1px solid #f3f4f6;
    }

    /* ===== Final polish (light + clean) ===== */


    /* 2) å†»ç»“åˆ—ç°è‰²æ›´æŸ”å’Œ */
    #summaryTable th:first-child,
    #summaryTable td:first-child,
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      background: #e5e7eb !important;
    }

    /* 3) hover æ›´è½»ï¼ˆä¸æŠ¢è‰²å—ï¼‰ */
    #summaryTable tr:hover td {
      background-color: #f8fafc !important;
    }

    /* 4) æ¯ä¸ª inquiry å—ä¹‹é—´æ›´æœ‰å‘¼å¸æ„Ÿ */
    .row-sep td {
      height: 14px !important;
    }

    /* ===== Sourcing simplification ===== */
    #toggleInquiry {
      display: none !important;
    }

    /* Sourcing no top form -> table taller */
    #fixed-scroll-wrapper {
      max-height: calc(100vh - 120px) !important;
    }

    /* è®“ ACTION æ¬„æœ‰ç©ºé–“ï¼Œä¸è¢«å³é‚Šæ“ å£“ */
    td.action-cell,
    th.action-header {
      padding-right: 16px !important;
      /* å¾€å·¦æ‹‰å‡ºç©ºé–“ */
      min-width: 140px;
      /* ç¢ºä¿æ¬„å¯¬å¤ ç”¨ */
      text-align: right;
      /* æŒ‰éˆ•é å³å°é½Šï¼Œçœ‹èµ·ä¾†æ›´èˆ’æœ */
    }

    /* è®“ CHECK éµï¼ˆå‹¾é¸æ¡†ï¼‰æœ‰è¶³å¤ é‚Šè· */
    td.action-cell input[type="checkbox"] {
      margin-right: 8px;
    }

    /* å¦‚æœæœ‰ç·¨è¼¯/è¤‡è£½/åˆªé™¤æŒ‰éˆ•ï¼Œå†åŠ ä¸€é»é–“è· */
    td.action-cell button {
      margin-left: 4px;
      margin-right: 4px;
    }

    #summaryTable td.action {
      padding-right: 20px !important;
    }

    /* å­è¡Œç¸®é€² + ç¾åŒ– */
    .sub-row td:first-child {
      padding-left: 30px !important;
      /* Quotation # æ¬„ç¸®é€² */
      font-style: italic !important;
      color: #555 !important;
      /* ç°è‰²æ–‡å­— */
    }

    /* å¯é¸ï¼šè®“æ•´è¡ŒèƒŒæ™¯ç•¥æ·¡æˆ–é‚Šæ¡†å€åˆ† */
    .sub-row {
      background-color: #f9f9f9 !important;
      border-top: 1px dashed #ddd;
    }

    .sub-row {
      background-color: #f8f9fa !important;
      font-style: italic;
      color: #555;
    }

    .sub-row td:first-child {
      padding-left: 40px !important;
      /* Quotation # æ¬„ç¸®é€² */
    }

    /* ===== Match SALES: compact rows ===== */
    #summaryTable td,
    #summaryTable th {
      padding-top: 6px !important;
      padding-bottom: 6px !important;
      line-height: 1.2 !important;
    }

    /* Left # column fixed width + centered */
    #summaryTable th:first-child,
    #summaryTable td:first-child {
      width: 10ch !important;
      min-width: 10ch !important;
      max-width: 10ch !important;
      text-align: center !important;
    }

    /* Action column roomy but not tall */
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      min-width: 140px !important;
      text-align: center !important;
    }


    #summaryTable .row-basic-head td:first-child,
    #summaryTable .row-truck-head td:first-child,
    #summaryTable .row-wh-head td:first-child,
    #summaryTable .row-basic-head td:last-child,
    #summaryTable .row-truck-head td:last-child,
    #summaryTable .row-wh-head td:last-child {
      z-index: 1000 !important;
    }

    /* Action buttons (match SALES) */
    .action-button-row {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      justify-content: center;
    }

    .action-button {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      box-shadow: none;
      font-size: 1rem;
    }

    .action-button:hover {
      background: #e2e8f0;
    }

    /* Sub-row Quotation # cell: centered (match SALES) */
    #summaryTable tr.row-truck-val.sub-row td:first-child,
    #summaryTable tr.row-wh-val.sub-row td:first-child {
      text-align: center !important;
      padding-left: 0 !important;
      font-style: italic;
      color: #555;
    }

    /* =========================
   FIX: Status colors should NOT affect header rows
   ========================= */

    /* 1) å¼ºåˆ¶æ‰€æœ‰ header è¡Œæ°¸è¿œæ˜¯æµ…ç°ï¼Œä¸åƒä»»ä½•çŠ¶æ€è‰² */
    #summaryTable tr.row-basic-head td,
    #summaryTable tr.row-truck-head td,
    #summaryTable tr.row-wh-head td {
      background: #f3f4f6 !important;
      font-weight: 700 !important;
    }

    /* 2) æŠŠâ€œçŠ¶æ€è‰²â€é™åˆ¶åœ¨ value è¡Œï¼ˆåªå¯¹ row-*-val ç”Ÿæ•ˆï¼‰ */
    #summaryTable tr.new-inquiry.row-truck-val td,
    #summaryTable tr.new-inquiry.row-wh-val td {
      background: #fff7d6 !important;
    }

    #summaryTable tr.new-inquiry.row-truck-val td input,
    #summaryTable tr.new-inquiry.row-wh-val td input {
      background: #fff7d6 !important;
      border-color: #f1d6a8 !important;
    }

    #summaryTable tr.row-sent.row-truck-val td,
    #summaryTable tr.row-sent.row-wh-val td {
      background: #eaf4ff !important;
    }

    #summaryTable tr.row-sent.row-truck-val td input,
    #summaryTable tr.row-sent.row-wh-val td input {
      background: #eaf4ff !important;
      border-color: #cfe3ff !important;
    }

    #summaryTable tr.row-confirmed.row-truck-val td,
    #summaryTable tr.row-confirmed.row-wh-val td {
      background: #cfe8ff !important;
    }

    #summaryTable tr.row-confirmed.row-truck-val td input,
    #summaryTable tr.row-confirmed.row-wh-val td input {
      background: #cfe8ff !important;
      border-color: #b6dcff !important;
    }

    /* âœ… ç¼–è¾‘ä¸­ï¼šå¼ºåˆ¶ç™½åº•ï¼ˆè¦†ç›– cost-saved / row-sent ç­‰çŠ¶æ€è‰²ï¼‰ */
    #summaryTable tr.row-editing td input {
      background: #ffffff !important;
      border-color: #d1d5db !important;
    }


    /* 3) å†»ç»“åˆ—ï¼ˆ# / ACTIONï¼‰æ°¸è¿œç°è‰²ï¼ˆåªé™åˆ¶åœ¨ value è¡Œï¼‰ */
    #summaryTable tr.new-inquiry.row-truck-val td:first-child,
    #summaryTable tr.new-inquiry.row-truck-val td:last-child,
    #summaryTable tr.new-inquiry.row-wh-val td:first-child,
    #summaryTable tr.new-inquiry.row-wh-val td:last-child,
    #summaryTable tr.row-sent.row-truck-val td:first-child,
    #summaryTable tr.row-sent.row-truck-val td:last-child,
    #summaryTable tr.row-sent.row-wh-val td:first-child,
    #summaryTable tr.row-sent.row-wh-val td:last-child,
    #summaryTable tr.row-confirmed.row-truck-val td:first-child,
    #summaryTable tr.row-confirmed.row-truck-val td:last-child,
    #summaryTable tr.row-confirmed.row-wh-val td:first-child,
    #summaryTable tr.row-confirmed.row-wh-val td:last-child {
      background: #e5e7eb !important;
    }

    /* NOTE å›ºå®šå®½åº¦ + ä¸€è¡Œçœç•¥ */
    #summaryTable td.note-preview,
    #summaryTable td.note-block {
      width: var(--noteWidth) !important;
      min-width: var(--noteWidth) !important;
      max-width: var(--noteWidth) !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

    #summaryTable td.note-preview {
      cursor: pointer;
      padding-left: 8px !important;
    }

    /* 
#summaryTable th:nth-child(26),
#summaryTable td:nth-child(26) {
  width: 10px !important;
  min-width: 10px !important;
  max-width: 10px !important;
  padding: 0 !important;
}
*/

    /* =========================
   SOURCING: ONE TRUE STICKY STYLE (keep only this)
   ========================= */
    :root {
      --sticky-gray: #e5e7eb;
      --sticky-divider: #cfd6dd;
      --sticky-shadow: rgba(0, 0, 0, .18);
    }

    /* both sides always same */
    #summaryTable th:first-child,
    #summaryTable td:first-child,
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      background: var(--sticky-gray) !important;
      background-image: none !important;
    }

    /* left # */
    #summaryTable th:first-child,
    #summaryTable td:first-child {
      position: sticky !important;
      left: 0 !important;
      z-index: 9999 !important;
      width: 10ch !important;
      min-width: 10ch !important;
      max-width: 10ch !important;
      text-align: center !important;
      box-shadow:
        inset -2px 0 0 var(--sticky-divider),
        8px 0 14px -12px var(--sticky-shadow) !important;
    }

    /* right ACTION */
    #summaryTable th:last-child,
    #summaryTable td:last-child {
      position: sticky !important;
      right: 0 !important;
      z-index: 9999 !important;
      width: 140px !important;
      min-width: 140px !important;
      max-width: 140px !important;
      text-align: center !important;
      padding-left: 6px !important;
      padding-right: 6px !important;
      box-shadow:
        inset 2px 0 0 var(--sticky-divider),
        -8px 0 14px -12px var(--sticky-shadow) !important;
    }

    /* no state can repaint them */
    #summaryTable tr:hover td:first-child,
    #summaryTable tr:hover td:last-child,
    #summaryTable tr.new-inquiry td:first-child,
    #summaryTable tr.new-inquiry td:last-child,
    #summaryTable tr.cost-saved td:first-child,
    #summaryTable tr.cost-saved td:last-child,
    #summaryTable tr.row-sent td:first-child,
    #summaryTable tr.row-sent td:last-child,
    #summaryTable tr.row-confirmed td:first-child,
    #summaryTable tr.row-confirmed td:last-child,
    #summaryTable tr.sub-row td:first-child,
    #summaryTable tr.sub-row td:last-child,
    #summaryTable tr.row-sep td:first-child,
    #summaryTable tr.row-sep td:last-child {
      background: var(--sticky-gray) !important;
      background-image: none !important;
    }

    #summaryTable td.note-preview {
      text-align: left !important;
      vertical-align: middle !important;
      max-width: 600px;
    }

    /* ===== FORCE GENERAL NOTE LEFT (BASIC ROW) ===== */
    #summaryTable tr.row-basic-val td.note-preview {
      text-align: left !important;
    }

    #summaryTable tr.row-basic-val td.note-preview .note-line {
      text-align: left !important;
    }

    /* âœ… Vendor Note column: override global note-preview width */
    #summaryTable td.note-preview.vendor-note-preview {
      width: 180px !important;
      min-width: 180px !important;
      max-width: 180px !important;

      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;

      text-align: left !important;
    }
  </style>
</head>

<body class="bg-gray-50 text-sm">
  <div id="main-content">
    <div class="header-section flex justify-between items-center w-full px-4 mt-2">
      <h1 class="text-2xl font-bold text-gray-800">Welcome, <span id="usernameDisplay">Sourcing</span></h1>
      <div class="flex items-center gap-2">
        <button id="prevPage" class="main-button">Previous</button>
        <span id="pageInfo" class="text-gray-800 text-sm font-semibold">Page 1</span>
        <button id="nextPage" class="main-button">Next</button>
        <button id="exitBtn" class="main-button">Exit</button>

        <input id="searchBox" class="border px-3 py-2 rounded-full text-sm w-64"
          placeholder="Search Quotation # or ZIP..." />
        <button id="searchBtn" class="main-button">Search</button>
        <button id="clearSearchBtn" class="main-button">Clear</button>
      </div>
    </div>
  </div>

  <div id="fixed-scroll-wrapper" class="scroll-container">
    <div style="width: 100%;">
      <table class="bg-white border text-xs" id="summaryTable">
        <thead class="bg-gray-200" style="background-color:#e0f2fe; position: sticky; top: 0; z-index: 10;">
          <tr>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
            <th class="border px-2"></th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>

      <div id="noteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-96 p-4">
          <h2 class="text-lg font-semibold mb-2">NOTE</h2>

          <textarea id="noteModalInput" wrap="soft" class="w-full border p-2 h-40 resize-none"></textarea>

          <div class="mt-3 flex gap-2 justify-end">
            <button id="noteModalSave" class="bg-green-600 text-white px-4 py-1 rounded">Save</button>
            <button id="noteModalClose" class="bg-blue-500 text-white px-4 py-1 rounded">Close</button>
          </div>
        </div>
      </div>


      <script>
        // ===============================
        // Sourcing Dashboard (Clean)
        // ===============================

        const pageSize = 100;
        let currentPage = 1;
        let filteredData = [];
        let currentUser = '';
        let userRole = '';

        // ===== Draft Cache (é˜²æ­¢å¤šè¡ŒæœªSAVEè¢«æ¸…ç©º) =====
        const draftCache = {};
        // key: ${quote}__${scope}__${field}

        function draftKey(quote, scope, field) {
          return `${String(quote || '').trim()}__${String(scope || '').trim()}__${String(field || '').trim()}`;
        }

        let searchTerm = '';

        function hasAnyPriceFilled(item, scope) {
          const fields = scope === 'WH'
            ? [
              'Order Processing Price', 'Inbound Price', 'Sorting Price', 'Palletizing Price',
              'Pallet Fee Price', 'Storage Price', 'Outbound Price', 'Vendor', 'Price'
            ]
            : [
              'Adjusted Price', 'Chassis Price', 'Pre-Pull Price', 'Yard Storage Price', 'Driver Waiting Price',
              'Over Weight Price', 'Chassis Split Price', 'Toll Price', 'Reefer Fee Price', 'Bond Fee Price',
              'Carrier', 'Price'
            ];
          return fields.some(k => String((item && item[k]) ?? '').trim() !== '');
        }

        function applySearchFilter(list, term) {
          const t = String(term || '').trim().toLowerCase();
          if (!t) return list;

          const mains = (list || []).filter(it => !String(it['Parent Quotation #'] || '').trim());

          const hit = (it) => {
            const q = String(it['Quotation #'] || '').toLowerCase();
            const ext = String(it['External Quotation #'] || '').toLowerCase();      // âœ… external
            const zip = String(it['To ZIP'] || '').toLowerCase();
            const to = String(it['To'] || '').toLowerCase();
            return q.includes(t) || ext.includes(t) || zip.includes(t) || to.includes(t);
          };

          const matchedMains = mains.filter(hit);
          const mainKeys = new Set(matchedMains.map(it => String(it['Quotation #'] || '').trim()).filter(Boolean));

          const children = (list || []).filter(it => {
            const p = String(it['Parent Quotation #'] || '').trim();
            return p && mainKeys.has(p);
          });

          const seen = new Set();
          const merged = [];
          [...matchedMains, ...children].forEach(it => {
            const q = String(it['Quotation #'] || '').trim();
            if (!q || seen.has(q)) return;
            seen.add(q);
            merged.push(it);
          });
          return merged;
        }
        function isTruthy(v) {
          if (v === true) return true;
          const s = String(v || '').toLowerCase().trim();
          return s === 'true' || s === '1' || s === 'yes' || s === 'y';
        }

        function num(v) {
          const n = parseFloat(String(v ?? '').replace(/,/g, '').trim());
          return Number.isFinite(n) ? n : null;
        }

        function fmt2(v) {
          const n = num(v);
          return n === null ? '' : n.toFixed(2);
        }

        function composeTo2(item) {
          const t = (item['To'] || '').trim();
          if (t) return t;
          const city = (item['To City'] || '').trim();
          const state = (item['To State'] || '').trim();
          const zip = (item['To ZIP'] || '').trim();
          return [city, [state, zip].filter(Boolean).join(' ')].filter(Boolean).join(', ');
        }

        function tdCell(text = '', cls = '') {
          const td = document.createElement('td');
          td.className = `border px-2 text-xs ${cls}`;
          td.textContent = text ?? '';
          return td;
        }

        function tdHeader(text = '', cls = '') {
          return tdCell(text, `font-bold bg-gray-100 text-center ${cls}`);
        }

        function makeInput(value, field, quote, locked, scope, alignLeft = false) {
          const input = document.createElement('input');

          const qTrim = String(quote || '').trim();
          const fTrim = String(field || '').trim();
          const sTrim = String(scope || '').trim();

          const k = draftKey(qTrim, sTrim, fTrim);
          const cached = Object.prototype.hasOwnProperty.call(draftCache, k) ? draftCache[k] : null;

          const serverVal = (value ?? '');
          // âœ… only non-empty cache overrides server (prevents "blank cache" from hiding Mongo values after reload)
          input.value = (cached !== null && String(cached).trim() !== '') ? cached : serverVal;

          input.className = `w-full border text-xs px-1 py-0.5 ${alignLeft ? 'text-left' : 'text-right'}`;
          input.setAttribute('data-quote', qTrim);
          input.setAttribute('data-field', fTrim);
          input.setAttribute('data-scope', sTrim);

          input.disabled = !!locked;
          if (locked) input.classList.add('saved-input');

          // âœ… draft cache only (no server write here)
          input.addEventListener('input', () => {
            draftCache[k] = input.value;
          });

          return input;
        }


        function anyConfirmed(item) {
          return isTruthy(item['truckingManagerConfirmed']) || isTruthy(item['truckingSalesConfirmed']) ||
            isTruthy(item['warehouseManagerConfirmed']) || isTruthy(item['warehouseSalesConfirmed']);
        }

        // âœ… Scope-specific confirm (prevents TRUCK confirm from locking WH, and vice versa)
        function scopeConfirmed(item, scope) {
          if (scope === 'TRUCK') {
            return isTruthy(item['truckingManagerConfirmed']) || isTruthy(item['truckingSalesConfirmed']);
          }
          if (scope === 'WH') {
            return isTruthy(item['warehouseManagerConfirmed']) || isTruthy(item['warehouseSalesConfirmed']);
          }
          return anyConfirmed(item);
        }

        function lockState(item, scope) {
          // Sourcing row is locked if Sales/Manager confirmed OR if this cost scope has been saved/sent.
          const costSentField = scope === 'TRUCK' ? 'truckingCostSent' : 'warehouseCostSent';
          const costSavedField = scope === 'TRUCK' ? 'truckingCostSaved' : 'warehouseCostSaved';
          return scopeConfirmed(item, scope) || isTruthy(item[costSentField]) || isTruthy(item[costSavedField]);
        }

        async function postUpdate(payload) {
          const res = await fetch('/inquiries/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          if (!res.ok) {
            console.error('Update failed:', text);
            return { ok: false, text };
          }
          return { ok: true, text };
        }

        async function saveFields(quote, fields, scope) {
          const qTrim = String(quote || '').trim();
          const sTrim = String(scope || '').trim();

          const payload = {
            'Quotation #': qTrim,
            'Saved': 'true',
            ...(sTrim === 'TRUCK' ? { truckingCostSaved: true } : { warehouseCostSaved: true })
          };
          // (Removed) Do not send 'Inquiry Type' from Sourcing to avoid backend permission blocking.

          const inputs = Array.from(document.querySelectorAll(`input[data-scope="${sTrim}"]`))
            .filter(el => String(el.getAttribute('data-quote') || '').trim() === qTrim);

          if (!inputs.length) {
            const msg = `âŒ SAVE failed: cannot find inputs for quote=${qTrim}, scope=${sTrim}`;
            console.error(msg);
            alert(msg);
            return false;
          }

          // Build allowlist from fields (plus safety: sometimes Carrier/Vendor live here)
          const allow = new Set((fields || []).map(x => String(x || '').trim()).filter(Boolean));

          for (const el of inputs) {
            const f = String(el.getAttribute('data-field') || '').trim();
            if (!f) continue;

            // Respect allowlist if provided
            if (allow.size && !allow.has(f)) continue;

            if (el.type === 'checkbox') {
              payload[f] = !!el.checked;
              continue;
            }

            const v = String(el.value ?? '').trim();
            // âœ… do not send empty strings (avoid overwriting)
            if (v === '') continue;
            payload[f] = v;
          }

          console.log('[SAVE payload]', payload);

          const r = await postUpdate(payload);
          if (!r.ok) alert('âŒ Save failed: ' + (r.text || ''));
          return r.ok;
        }


        async function autosaveScopeIfHasAnyValue(quote, scope) {
          const qTrim = String(quote || '').trim();
          const sTrim = String(scope || '').trim();

          const inputs = Array.from(document.querySelectorAll(`input[data-scope="${sTrim}"]`))
            .filter(el => String(el.getAttribute('data-quote') || '').trim() === qTrim);

          const hasValue = inputs.some(el => String(el.value || '').trim() !== '');
          if (!hasValue) return true;

          const fields = sTrim === 'TRUCK'
            ? ['Base Rate', 'Chassis', 'Pre-Pull', 'Yard Storage', 'Driver Waiting', 'Over Weight', 'Chassis Split', 'Toll', 'Reefer Fee', 'Bond Fee', 'Carrier']
            : ['Order Processing', 'Inbound', 'Sorting', 'Palletizing', 'Pallet Fee', 'Storage', 'Outbound', 'Vendor'];

          return await saveFields(qTrim, fields, sTrim);
        }

        async function setFlags(quote, updates) {
          const qTrim = String(quote || '').trim();
          const payload = { 'Quotation #': qTrim, 'Saved': 'true', ...updates };
          const r = await postUpdate(payload);
          if (!r.ok) alert('âŒ Update failed: ' + (r.text || ''));
          return r.ok;
        }

        function unlockRow(quote, scope) {
          // âœ… ç»™è¯¥ scope è¡ŒåŠ  editing classï¼ˆè®©è¾“å…¥æ¡†å˜ç™½ï¼‰
          const rowSel = scope === 'TRUCK' ? 'tr.row-truck-val' : 'tr.row-wh-val';
          document.querySelectorAll(rowSel).forEach(r => {
            const qCell = r.querySelector('td:first-child');
            // å­è¡Œ td:first-child æ˜¯ quoteï¼›ä¸»è¡Œæ˜¯ç©ºï¼Œæ‰€ä»¥ç”¨ data-quote çš„ input æ¥åˆ¤æ–­æ›´ç¨³
            const hit = Array.from(r.querySelectorAll(`input[data-scope="${scope}"]`))
              .some(el => el.getAttribute('data-quote') === quote);
            if (hit) r.classList.add('row-editing');
          });

          document.querySelectorAll(`input[data-scope="${scope}"]`).forEach(el => {
            if (el.getAttribute('data-quote') === quote) {
              el.disabled = false;
              el.classList.remove('saved-input');
            }
          });
        }


        function lockRow(quote, scope) {
          const rowSel = scope === 'TRUCK' ? 'tr.row-truck-val' : 'tr.row-wh-val';
          document.querySelectorAll(rowSel).forEach(r => {
            const hit = Array.from(r.querySelectorAll(`input[data-scope="${scope}"]`))
              .some(el => el.getAttribute('data-quote') === quote);
            if (hit) r.classList.remove('row-editing');
          });

          document.querySelectorAll(`input[data-scope="${scope}"]`).forEach(el => {
            if (el.getAttribute('data-quote') === quote) {
              el.disabled = true;
              el.classList.add('saved-input');
            }
          });
        }

        function findRowByQuoteScope(quote, scope) {
          const rowSel = scope === 'TRUCK' ? 'tr.row-truck-val' : 'tr.row-wh-val';
          const rows = Array.from(document.querySelectorAll(rowSel));
          const q = String(quote || '').trim();

          return rows.find(r => {
            const inputs = Array.from(r.querySelectorAll(`input[data-scope="${scope}"]`));
            return inputs.some(el => String(el.getAttribute('data-quote') || '').trim() === q);
          }) || null;
        }

        function markRowSaved(quote, scope) {
          const row = findRowByQuoteScope(quote, scope);
          if (!row) return;

          // è¿›å…¥â€œå·²ä¿å­˜ä½†æœªé€å‡ºâ€çš„çŠ¶æ€
          row.classList.add('cost-saved');
          row.classList.remove('new-inquiry');
          row.classList.remove('row-sent');
          row.classList.remove('row-confirmed');

          // é”å®šï¼ˆä½ åŸæœ¬å·²ç»ä¼š lockRowï¼Œè¿™é‡Œä¿é™©ï¼‰
          lockRow(quote, scope);
        }


        // ===============================
        // Helpers for ADD / DELETE sub-lines
        // ===============================

        // æ‹‰å…¨é‡ inquiriesï¼ˆç”¨äºç®—ä¸‹ä¸€ä¸ªç¼–å·ï¼‰
        async function fetchAllInquiries() {
          const res = await fetch('/inquiries', { credentials: 'include' });
          const data = await res.json();
          return Array.isArray(data) ? data : [];
        }

        function getParentQuote(item, quote) {
          const q = String(quote || '').trim();
          const parent = String(item['Parent Quotation #'] || '').trim();

          // å¦‚æœæœ‰ Parent Quotation #ï¼Œç›´æ¥ç”¨å®ƒ
          if (parent) return parent;

          // æ²¡æœ‰ Parent çš„æƒ…å†µï¼š
          // å¦‚æœæ˜¯ TRUCK å­è¡Œï¼ˆ-æ•°å­—ï¼‰ï¼Œå»æ‰æœ€åä¸€ä¸ª -æ•°å­—
          if (/-\d+$/.test(q)) {
            return q.replace(/-\d+$/, '');
          }

          // å¦‚æœæ˜¯ WH å­è¡Œï¼ˆ-å­—æ¯ï¼‰ï¼Œå»æ‰æœ€åä¸€ä¸ª -å­—æ¯
          if (/-[A-Z]$/i.test(q)) {
            return q.replace(/-[A-Z]$/i, '');
          }

          // å¦åˆ™å°±æ˜¯ä¸»å·
          return q;
        }

        // TRUCKï¼šä¸»å·-1, -2, -3...
        function nextTruckQuote(parent, all) {
          let p = String(parent || '').trim();

          // âœ… åªæŠŠ TRUCK å­è¡Œåç¼€ (-1/-2/-3...) å‰¥æ‰ï¼›
          // ä¸»å·çš„ -0001 å±äºä¸»å·æœ¬èº«ï¼Œä¸èƒ½å‰¥ã€‚
          const m = p.match(/-(\d+)$/);
          if (m && m[1].length <= 2) {   // å­è¡Œç¼–å·é€šå¸¸ 1~2 ä½æ•°
            p = p.replace(/-\d+$/, '');
          }

          const nums = all
            .filter(x => {
              const qx = String(x['Quotation #'] || '').trim();
              const px = String(x['Parent Quotation #'] || '').trim();
              const inferred = (!px && /-\d+$/.test(qx)) ? qx.replace(/-\d+$/, '') : px;
              return inferred === p && /-\d+$/.test(qx);
            })
            .map(x => {
              const m = String(x['Quotation #'] || '').trim().match(/-(\d+)$/);
              return m ? parseInt(m[1], 10) : 0;
            })
            .filter(n => Number.isFinite(n));

          const next = (nums.length ? Math.max(...nums) : 0) + 1;
          return `${p}-${next}`;
        }

        // WAREHOUSEï¼šä¸»å·-A, -B, -C...
        function nextWhQuote(parent, all) {
          let p = String(parent || '').trim();

          // âœ… åªå‰¥ WH å­è¡Œå­—æ¯åç¼€
          p = p.replace(/-[A-Z]$/i, '');


          const used = new Set(
            all
              .filter(x => {
                const qx = String(x['Quotation #'] || '').trim();
                const px = String(x['Parent Quotation #'] || '').trim();
                const inferred = (!px && /-[A-Z]$/i.test(qx)) ? qx.replace(/-[A-Z]$/i, '') : px;
                return inferred === p && /-[A-Z]$/i.test(qx);
              })
              .map(x => {
                const m = String(x['Quotation #'] || '').trim().match(/-([A-Z])$/i);
                return m ? m[1].toUpperCase() : null;
              })
              .filter(Boolean)
          );

          for (let i = 0; i < 26; i++) {
            const L = String.fromCharCode(65 + i);
            if (!used.has(L)) return `${p}-${L}`;
          }
          return `${p}-Z`;
        }

        function actionCellTruck(item, quote, mainKey) {
          const td = document.createElement('td');
          td.className = 'border px-2 text-center';

          const costSentField = 'truckingCostSent';
          const costSavedField = 'truckingCostSaved';

          const hardLocked = scopeConfirmed(item, 'TRUCK') || isTruthy(item[costSentField]);

          const wrap = document.createElement('div');
          wrap.className = 'action-button-row';

          // âœï¸ EDIT
          const editBtn = document.createElement('button');
          editBtn.className = 'action-button';
          editBtn.textContent = 'âœï¸';
          editBtn.title = 'ç·¨è¼¯æˆæœ¬';
          editBtn.disabled = hardLocked;
          editBtn.onclick = () => unlockRow(quote, 'TRUCK');
          wrap.appendChild(editBtn);

          // ğŸ’¾ SAVE
          const saveBtn = document.createElement('button');
          saveBtn.className = 'action-button';
          saveBtn.textContent = 'ğŸ’¾';
          saveBtn.title = 'å„²å­˜æˆæœ¬';
          saveBtn.disabled = hardLocked;
          saveBtn.onclick = async () => {
            const fields = [
              'Base Rate', 'Chassis', 'Pre-Pull', 'Yard Storage', 'Driver Waiting',
              'Over Weight', 'Chassis Split', 'Toll', 'Reefer Fee', 'Bond Fee', 'Carrier'
            ];

            const ok = await saveFields(quote, fields, 'TRUCK');
            if (!ok) return;

            await setFlags(quote, { [costSavedField]: 'true' });
            lockRow(quote, 'TRUCK');

            fields.forEach(f => delete draftCache[draftKey(quote, 'TRUCK', f)]);
            markRowSaved(quote, 'TRUCK');
          };
          wrap.appendChild(saveBtn);

          // âœ… CHECK (Cost Sent)
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.title = 'æˆæœ¬å·²é€å‡º';
          chk.checked = isTruthy(item[costSentField]);
          chk.disabled = scopeConfirmed(item, 'TRUCK');
          chk.className = 'w-5 h-5 accent-blue-600 cursor-pointer';

          chk.onchange = async () => {
            const want = chk.checked;
            chk.disabled = true;

            try {
              if (want) {
                const okSave = await autosaveScopeIfHasAnyValue(quote, 'TRUCK');
                if (!okSave) { chk.checked = false; return; }

                const okFlag1 = await setFlags(quote, { [costSavedField]: 'true' });
                if (!okFlag1) { chk.checked = false; return; }
              }

              const okFlag2 = await setFlags(quote, { [costSentField]: want ? 'true' : 'false' });
              if (!okFlag2) { chk.checked = !want; return; }

              // âœ… ä¸ reloadï¼Œä¸ loadInquiries
              lockRow(quote, 'TRUCK');

              const row = findRowByQuoteScope(quote, 'TRUCK');
              if (row) {
                row.classList.remove('new-inquiry', 'row-confirmed');
                row.classList.toggle('row-sent', want);
                if (!want) row.classList.add('cost-saved');
                else row.classList.remove('cost-saved');
              }

              ['Base Rate', 'Chassis', 'Pre-Pull', 'Yard Storage', 'Driver Waiting', 'Over Weight', 'Chassis Split', 'Toll', 'Reefer Fee', 'Bond Fee', 'Carrier']
                .forEach(f => delete draftCache[draftKey(quote, 'TRUCK', f)]);

              // âœ… After checking Cost Sent, immediately lock/unlock delete button (no reload)
              if (typeof delBtn !== 'undefined') {
                if (want) {
                  delBtn.disabled = true;
                  delBtn.style.opacity = '0.25';
                  delBtn.style.pointerEvents = 'none';
                } else {
                  delBtn.disabled = !canDelete;
                  delBtn.style.opacity = canDelete ? '1' : '0.25';
                  delBtn.style.pointerEvents = canDelete ? 'auto' : 'none';
                }
              }

            } finally {
              chk.disabled = false;
            }
          };
          wrap.appendChild(chk);

          // â• ADD (åªæ–°å¢ TRUCK å­è¡Œ)
          const addBtn = document.createElement('button');
          addBtn.className = 'action-button';
          addBtn.textContent = 'â•';
          addBtn.title = 'æ–°å¢ TRUCK å­è¡Œ';
          addBtn.disabled = scopeConfirmed(item, 'TRUCK');
          addBtn.onclick = async () => {
            if (!confirm('ç¢ºå®šæ–°å¢ä¸€æ¢ TRUCK å­è¡Œï¼Ÿ')) return;

            const okAuto = await autosaveScopeIfHasAnyValue(String(quote || '').trim(), 'TRUCK');
            if (!okAuto) {
              alert('âŒ å…ˆä¿å­˜å½“å‰ TRUCK COST å¤±è´¥ï¼Œæ‰€ä»¥ä¸ä¼šæ–°å¢å­è¡Œï¼ˆé¿å…æ•°æ®ä¸¢å¤±ï¼‰ã€‚');
              return;
            }


            const parent = String(mainKey || '').trim();
            const all = await fetchAllInquiries();
            const newQuote = nextTruckQuote(parent, all);

            const newItem = {
              'Quotation #': newQuote,
              'Parent Quotation #': parent,
              'Type': 'TRUCK',
              'Date': new Date().toLocaleDateString(),
              'Customer ID': item['Customer ID'] || '',
              'Requested By': item['Requested By'] || '',
              'Inquiry Type': item['Inquiry Type'] || '',
              'Commodity': item['Commodity'] || '',
              'Selected': 'false'
            };

            const resp = await fetch('/inquiries', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(newItem)
            });

            if (!resp.ok) {
              const t = await resp.text();
              alert('âŒ æ–°å¢ TRUCK å­è¡Œå¤±è´¥ï¼š' + t);
              return;
            }

            await loadInquiries(); // ADD åéœ€è¦åˆ·æ–°åˆ—è¡¨
          };
          wrap.appendChild(addBtn);

          // ğŸ—‘ï¸ DELETE (åªåˆ é™¤ TRUCK å­è¡Œ)
          const delBtn = document.createElement('button');
          delBtn.className = 'action-button';
          delBtn.textContent = 'ğŸ—‘ï¸';
          delBtn.title = 'åˆ é™¤ TRUCK å­è¡Œ';

          const qDel = String(quote || '').trim();
          const parentDel = String(mainKey || '').trim();
          const isTruckSubDel = (qDel !== parentDel) && /-\d+$/.test(qDel);

          const canDelete = isTruckSubDel && !hardLocked;
          delBtn.disabled = !canDelete;
          delBtn.style.opacity = canDelete ? '1' : '0.25';
          delBtn.style.pointerEvents = canDelete ? 'auto' : 'none';
          delBtn.title = canDelete ? 'åˆ é™¤ TRUCK å­è¡Œ' : 'Cannot delete: locked';

          delBtn.onclick = async () => {
            if (!canDelete) {
              alert('âŒ TRUCK åªèƒ½åˆ é™¤å­è¡Œï¼ˆä¾‹å¦‚ ä¸»å·-1 / ä¸»å·-2...ï¼‰ï¼Œä¸»è¡Œä¸èƒ½åˆ ï¼š\n' + qDel);
              return;
            }

            if (!confirm(`ç¡®å®šåˆ é™¤è¿™æ¡ TRUCK å­è¡Œï¼Ÿ\n${qDel}`)) return;

            // âœ… æ’åœ¨è¿™é‡Œ
            const okFlush = await flushAllDrafts();
            if (!okFlush) {
              alert('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œå·²å–æ¶ˆåˆ é™¤ï¼ˆé¿å…æ•°æ®ä¸¢å¤±ï¼‰ã€‚');
              return;
            }

            const resp = await fetch('/delete_inquiry', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ quoteId: qDel })
            });

            const raw = await resp.text();
            let j = {};
            try { j = JSON.parse(raw); } catch { }

            if (!resp.ok || j.success === false) {
              alert('âŒ åˆ é™¤å¤±è´¥ï¼š\n' + (j.message || raw || resp.statusText));
              return;
            }

            await loadInquiries();
          };
          wrap.appendChild(delBtn);

          td.appendChild(wrap);
          return td;
        }

        function actionCellWH(item, quote, mainKey) {
          const td = document.createElement('td');
          td.className = 'border px-2 text-center';

          const costSentField = 'warehouseCostSent';
          const costSavedField = 'warehouseCostSaved';

          const hardLocked = scopeConfirmed(item, 'WH') || isTruthy(item[costSentField]);

          const wrap = document.createElement('div');
          wrap.className = 'action-button-row';

          // âœï¸ EDIT
          const editBtn = document.createElement('button');
          editBtn.className = 'action-button';
          editBtn.textContent = 'âœï¸';
          editBtn.title = 'ç·¨è¼¯æˆæœ¬';
          editBtn.disabled = hardLocked;
          editBtn.onclick = () => unlockRow(quote, 'WH');
          wrap.appendChild(editBtn);

          // ğŸ’¾ SAVE (Sourcing ä¿å­˜ Cost)
          const saveBtn = document.createElement('button');
          saveBtn.className = 'action-button';
          saveBtn.textContent = 'ğŸ’¾';
          saveBtn.title = 'å„²å­˜æˆæœ¬';
          saveBtn.disabled = hardLocked;
          saveBtn.onclick = async () => {
            const fields = [
              'Order Processing', 'Inbound', 'Sorting', 'Palletizing',
              'Pallet Fee', 'Storage', 'Outbound', 'Vendor'
            ];
            const ok = await saveFields(quote, fields, 'WH');
            if (!ok) return;

            await setFlags(quote, { [costSavedField]: 'true' });
            lockRow(quote, 'WH');

            [
              'Order Processing', 'Inbound', 'Sorting', 'Palletizing',
              'Pallet Fee', 'Storage', 'Outbound', 'Vendor'
            ].forEach(f => delete draftCache[draftKey(quote, 'WH', f)]);

            await autosaveScopeIfHasAnyValue(String(quote || '').trim(), 'WH');

            markRowSaved(quote, 'WH');

          };
          wrap.appendChild(saveBtn);

          // âœ… CHECK
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.title = 'æˆæœ¬å·²é€å‡º';
          chk.checked = isTruthy(item[costSentField]);
          chk.disabled = scopeConfirmed(item, 'WH');
          chk.className = 'w-5 h-5 accent-blue-600 cursor-pointer';
          chk.onchange = async () => {
            const want = chk.checked;
            chk.disabled = true;

            try {
              if (want) {
                const okSave = await autosaveScopeIfHasAnyValue(quote, 'WH');
                if (!okSave) { chk.checked = false; return; }
                const okFlag1 = await setFlags(quote, { [costSavedField]: 'true' });
                if (!okFlag1) { chk.checked = false; return; }
              }

              const okFlag2 = await setFlags(quote, { [costSentField]: want ? 'true' : 'false' });
              if (!okFlag2) { chk.checked = !want; return; }

              lockRow(quote, 'WH');

              const row = findRowByQuoteScope(quote, 'WH');
              if (row) {
                row.classList.remove('new-inquiry', 'row-confirmed');
                row.classList.toggle('row-sent', want);
                if (!want) row.classList.add('cost-saved');
              }

              ['Order Processing', 'Inbound', 'Sorting', 'Palletizing', 'Pallet Fee', 'Storage', 'Outbound', 'Vendor']
                .forEach(f => delete draftCache[draftKey(quote, 'WH', f)]);

              // âœ… After checking Cost Sent, immediately lock/unlock delete button (no reload)
              if (typeof delBtn !== 'undefined') {
                if (want) {
                  delBtn.disabled = true;
                  delBtn.style.opacity = '0.25';
                  delBtn.style.pointerEvents = 'none';
                } else {
                  delBtn.disabled = !canDelete;
                  delBtn.style.opacity = canDelete ? '1' : '0.25';
                  delBtn.style.pointerEvents = canDelete ? 'auto' : 'none';
                }
              }

            } finally {
              chk.disabled = false;
            }
          };
          wrap.appendChild(chk);

          td.appendChild(wrap);

          // â• ADD (åªæ–°å¢ WH å­è¡Œ)

          const addBtn = document.createElement('button');
          addBtn.className = 'action-button';
          addBtn.textContent = 'â•';
          addBtn.title = 'æ–°å¢ WAREHOUSE å­è¡Œ';
          addBtn.disabled = scopeConfirmed(item, 'WH'); // âœ… checked(æˆæœ¬å·²é€å‡º) ä»å…è®¸æ–°å¢å­è¡Œï¼›ä»…åœ¨ Sales/Manager Confirm åé”æ­»
          addBtn.onclick = async () => {
            if (!confirm('ç¢ºå®šæ–°å¢ä¸€æ¢ TRUCK å­è¡Œï¼Ÿ')) return;

            const okFlush = await flushAllDrafts();
            if (!okFlush) { alert('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œå·²å–æ¶ˆæ–°å¢ï¼ˆé¿å…æ•°æ®ä¸¢å¤±ï¼‰ã€‚'); return; }

            const okAuto = await autosaveScopeIfHasAnyValue(String(quote || '').trim(), 'TRUCK');
            if (!okAuto) {
              alert('âŒ å…ˆä¿å­˜å½“å‰ TRUCK COST å¤±è´¥ï¼Œæ‰€ä»¥ä¸ä¼šæ–°å¢å­è¡Œï¼ˆé¿å…æ•°æ®ä¸¢å¤±ï¼‰ã€‚');
              return;
            }

            const parent = String(mainKey || '').trim();
            const all = await fetchAllInquiries();
            const newQuote = nextWhQuote(parent, all);

            const newItem = {
              'Quotation #': newQuote,
              'Parent Quotation #': parent,
              'Type': 'WAREHOUSE',
              'Date': new Date().toLocaleDateString(),
              'Customer ID': item['Customer ID'] || '',
              'Requested By': item['Requested By'] || '',
              'Inquiry Type': item['Inquiry Type'] || '',
              'Commodity': item['Commodity'] || '',
              'Selected': 'false'
            };

            const resp = await fetch('/inquiries', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(newItem)
            });

            const raw = await resp.text();
            if (!resp.ok) {
              alert('âŒ æ–°å¢ WAREHOUSE å­è¡Œå¤±è´¥ï¼š\n' + raw);
              return;
            }
            await loadInquiries();

          };
          wrap.appendChild(addBtn);

          // ğŸ—‘ï¸ DELETE (åªåˆ é™¤ WAREHOUSE å­è¡Œ)
          const delBtn = document.createElement('button');
          delBtn.className = 'action-button';
          delBtn.textContent = 'ğŸ—‘ï¸';
          delBtn.title = 'åˆ é™¤ WAREHOUSE å­è¡Œ';

          const qDel = String(quote || '').trim();
          const parentDel = String(mainKey || '').trim();
          const isWhSubDel = (qDel !== parentDel) && /-[A-Z]$/i.test(qDel);

          const canDelete = isWhSubDel && !hardLocked && !hasAnyPriceFilled(item, 'WH');
          delBtn.disabled = !canDelete;
          delBtn.style.opacity = canDelete ? '1' : '0.25';
          delBtn.style.pointerEvents = canDelete ? 'auto' : 'none';
          delBtn.title = canDelete ? 'åˆ é™¤ WAREHOUSE å­è¡Œ' : 'Cannot delete: price entered or locked';

          delBtn.onclick = async () => {
            if (!canDelete) {
              alert('âŒ WAREHOUSE åªèƒ½åˆ é™¤å­è¡Œï¼ˆä¾‹å¦‚ ä¸»å·-A / ä¸»å·-B...ï¼‰ï¼Œä¸»è¡Œä¸èƒ½åˆ ï¼š\n' + qDel);
              return;
            }

            if (!confirm(`ç¡®å®šåˆ é™¤è¿™æ¡ WAREHOUSE å­è¡Œï¼Ÿ\n${qDel}`)) return;

            const resp = await fetch('/delete_inquiry', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ quoteId: qDel })
            });

            const raw = await resp.text();
            let j = {};
            try { j = JSON.parse(raw); } catch { }

            if (!resp.ok || j.success === false) {
              alert('âŒ åˆ é™¤å¤±è´¥ï¼š\n' + (j.message || raw || resp.statusText));
              return;
            }

            await loadInquiries();
          };

          wrap.appendChild(delBtn);


          td.appendChild(wrap);

          return td;
        }

        function naturalQuotationSort(a, b) {
          const qa = String(a['Quotation #'] || '').trim();
          const qb = String(b['Quotation #'] || '').trim();

          return qb.localeCompare(qa, undefined, {
            numeric: true,
            sensitivity: 'base'
          });
        }

        function flagIcons(item) {
          const icons = [];
          const haz = String(item['Hazmat'] ?? item['hazmat'] ?? '').toLowerCase() === 'true';
          const ref = String(item['Reefer'] ?? item['reefer'] ?? '').toLowerCase() === 'true';
          const bon = String(item['Bonded'] ?? item['bonded'] ?? '').toLowerCase() === 'true';
          if (haz) icons.push('â˜¢ï¸');
          if (ref) icons.push('â„ï¸');
          if (bon) icons.push('ğŸ”’');
          return icons.join(' ');
        }

        function renderPage() {
          const tbody = document.getElementById('summaryBody');
          if (!tbody) return;
          tbody.innerHTML = '';

          const TOTAL_COLS = 27;
          const BASIC_HEAD = ['#', 'Date', 'Customer ID', 'Requested By', 'Inquiry Type', 'Container Size', 'Commodity', 'Packages', 'Flags', 'Dry Van Type', 'Legal/Over Weight', 'Gross Weight', 'Live/Drop', 'From', 'To', 'QTY', 'Quotation #'];

          const TRUCK_HEADERS = ['', 'Base Rate', 'Price', 'GP', 'Adjusted Price', 'Adjusted GP',
            'Chassis Cost', 'Chassis Price', 'Pre-Pull Cost', 'Pre-Pull Price', 'Yard Storage Cost', 'Yard Storage Price',
            'Driver Waiting Cost', 'Driver Waiting Price', 'Over Weight Cost', 'Over Weight Price', 'Chassis Split Cost', 'Chassis Split Price',
            'Toll Cost', 'Toll Price', 'Reefer Fee Cost', 'Reefer Fee Price', 'Bond Fee Cost', 'Bond Fee Price', 'Carrier', '', 'Action'];

          const WH_LEFT_HEADERS = ['', 'WH Order Proc', 'WH Order Proc Price', 'WH Inbound', 'WH Inbound Price', 'WH Sorting', 'WH Sorting Price',
            'WH Palletizing', 'WH Palletizing Price', 'WH Pallet', 'WH Pallet Price', 'WH Storage', 'WH Storage Price', 'WH Outbound', 'WH Outbound Price', 'Vendor'];

          // âœ… å…¨é‡æ’åºï¼ˆä¸è¦å…ˆ sliceï¼‰
          const data = (filteredData || []).slice().sort(naturalQuotationSort);

          // âœ… 1) å…ˆç”¨â€œå…¨é‡ dataâ€å»º groupMapï¼ˆæŒ‰ä¸»å·ï¼‰
          const groupMap = new Map();
          function normalizeParentKey(it) {
            const q = String(it['Quotation #'] || '').trim();
            const p = String(it['Parent Quotation #'] || '').trim();
            return p || q;
          }

          data.forEach(it => {
            const key = normalizeParentKey(it);
            if (!key) return;
            if (!groupMap.has(key)) groupMap.set(key, []);
            groupMap.get(key).push(it);
          });

          // âœ… 2) ä¸»å· keysï¼ˆæŒ‰ä¸»å·æ’åºï¼‰
          const allKeys = Array.from(groupMap.keys()).sort((a, b) =>
            naturalQuotationSort({ 'Quotation #': a }, { 'Quotation #': b })
          );

          // âœ… 3) æŒ‰â€œä¸»å·æ•°é‡â€åˆ†é¡µï¼ˆè¿™ä¸€æ­¥æ˜¯ä¿®å¤ä½  ADD åçœ‹èµ·æ¥æ¸…é›¶çš„æ ¸å¿ƒï¼‰
          const maxPage = Math.ceil(allKeys.length / pageSize) || 1;
          if (currentPage > maxPage) currentPage = maxPage;
          if (currentPage < 1) currentPage = 1;

          const startKey = (currentPage - 1) * pageSize;
          const pageKeys = allKeys.slice(startKey, startKey + pageSize);

          // âœ… index #ï¼ˆæŒ‰ä¸»å·è®¡æ•°ï¼‰
          const getIndex = (idxInPage) => startKey + idxInPage + 1;

          // âœ… 4) æ¸²æŸ“å½“å‰é¡µæ¯ä¸ªä¸»å· blockï¼ˆæ•´ç»„æ¸²æŸ“ï¼šä¸»è¡Œ + å­è¡Œï¼‰
          pageKeys.forEach((key, idxInPage) => {
            const group = (groupMap.get(key) || []).slice();
            if (!group.length) return;

            // group å†…éƒ¨æ’åºï¼Œç¡®ä¿ä¸»è¡Œ/å­è¡Œç¨³å®šæ’åˆ—
            group.sort(naturalQuotationSort);

            const idx = String(getIndex(idxInPage));

            // é€‰ mainï¼šä¼˜å…ˆ Quotation# == keyï¼Œå¦åˆ™ fallback group[0]
            const main = group.find(it => String(it['Quotation #'] || '').trim() === key) || group[0];

            // å­è¡Œç­›é€‰ï¼ˆä½ åŸæœ¬é€»è¾‘ä¿æŒï¼‰
            const truckSubs = group.filter(it => {
              const q = String(it['Quotation #'] || '').trim();
              return q !== key && /-\d+$/.test(q);
            });

            const whSubs = group.filter(it => {
              const q = String(it['Quotation #'] || '').trim();
              return q !== key && /-[A-Z]$/i.test(q);
            });

            // ========= BASIC header =========
            const r1 = document.createElement('tr');
            r1.className = 'row-basic-head';
            BASIC_HEAD.forEach(h => r1.appendChild(tdHeader(h)));

            const noteHead = tdHeader('NOTE');
            noteHead.colSpan = 8;          // âœ… 18~25
            noteHead.classList.add('text-left');
            r1.appendChild(noteHead);

            r1.appendChild(tdHeader(''));          // âœ… ç¬¬26ç©ºç™½
            r1.appendChild(tdHeader('ACTION'));    // âœ… ç¬¬27
            tbody.appendChild(r1);

            // ========= BASIC values =========
            const r2 = document.createElement('tr');
            r2.className = 'row-basic-val';

            const vals = [
              idx,
              main['Date'] || '',
              main['Customer ID'] || '',
              main['Requested By'] || main.username || '',
              main['Inquiry Type'] || '',
              main['Container Size'] || '',
              (main['Commodity'] || '').toString().trim(),
              main['Packages Per Container'] || '',
              flagIcons(main),
              main['Dry Van Type'] || '',
              main['Legal or Over Weight'] || '',
              main['Gross Weight'] || '',
              main['Live or Drop'] || '',
              main['From'] || '',
              composeTo2(main),
              main['QTY'] || '',
              (main['External Quotation #'] || key)
            ];
            vals.forEach(v => r2.appendChild(tdCell(v, 'text-center')));

            const company = String(main['Customer Company'] || main['Company Name'] || '').trim();
            const contact = String(main['Customer Contact'] || main['Contact Name'] || '').trim();
            const email = String(main['Customer Email'] || '').trim();
            const phone = String(main['Customer Phone'] || '').trim();

            const customerInfoLine = (company || contact || email || phone)
              ? `Customer Info: ${[
                company ? `Company=${company}` : '',
                contact ? `Contact=${contact}` : '',
                email ? `Email=${email}` : '',
                phone ? `Phone=${phone}` : ''
              ].filter(Boolean).join(' | ')}`
              : '';

            const noteBody = String(main['Note'] || '').trim();
            const fullGeneralNote = [customerInfoLine, noteBody].filter(Boolean).join('\n');
            const previewGeneralNote = fullGeneralNote.replace(/\s+/g, ' ').trim();

            const noteTd = tdCell('', 'note-preview');
            noteTd.colSpan = 8;
            noteTd.dataset.fullNote = fullGeneralNote;
            noteTd.dataset.which = 'GENERAL NOTE';
            noteTd.style.textAlign = 'left';

            const line = document.createElement('div');
            line.className = 'note-line';
            line.textContent = previewGeneralNote;
            noteTd.appendChild(line);

            r2.appendChild(noteTd);

            r2.appendChild(tdCell(''));                  // âœ… ç¬¬26ç©ºç™½
            r2.appendChild(tdCell('ğŸ”’', 'text-center'));  // âœ… ç¬¬27
            tbody.appendChild(r2);

            // ========= TRUCK header =========
            const r3 = document.createElement('tr');
            r3.className = 'row-truck-head';
            TRUCK_HEADERS.forEach((h, i) => {
              if (i === 0) r3.appendChild(tdHeader(key, 'text-left'));
              else r3.appendChild(tdHeader(h));
            });
            tbody.appendChild(r3);

            // TRUCK main + subsï¼ˆä½ åŸæœ¬å‡½æ•°ä¿æŒï¼‰
            tbody.appendChild(renderTruckRow(main, key, false, key));
            truckSubs.forEach(sub => tbody.appendChild(renderTruckRow(sub, sub['Quotation #'], true, key)));

            // ========= WH header =========
            const r5 = document.createElement('tr');
            r5.className = 'row-wh-head';

            WH_LEFT_HEADERS.forEach((h, i) => {
              if (i === 0) r5.appendChild(tdHeader(key, 'text-left'));
              else r5.appendChild(tdHeader(h));
            });

            r5.appendChild(tdHeader('')); // ç¬¬17ç•™ç©º
            const whNoteHead = tdHeader('NOTE');
            whNoteHead.colSpan = 8;
            whNoteHead.classList.add('text-left');
            r5.appendChild(whNoteHead);

            r5.appendChild(tdHeader('', 'spacer-col')); // ç¬¬26
            r5.appendChild(tdHeader('Action'));         // ç¬¬27
            tbody.appendChild(r5);

            // WH main + subsï¼ˆä½ åŸæœ¬å‡½æ•°ä¿æŒï¼‰
            tbody.appendChild(renderWhRow(main, key, false, key));
            whSubs.forEach(sub => tbody.appendChild(renderWhRow(sub, sub['Quotation #'], true, key)));

            // åˆ†éš”è¡Œ
            const sep = document.createElement('tr');
            sep.className = 'row-sep';
            const tdSep = document.createElement('td');
            tdSep.colSpan = TOTAL_COLS;
            sep.appendChild(tdSep);
            tbody.appendChild(sep);
          });

          const pageInfo = document.getElementById('pageInfo');
          if (pageInfo) pageInfo.textContent = `Page ${currentPage}`;
        }

        function renderTruckRow(item, quote, isSub, mainKey) {
          const q = String(quote || '').trim();

          const parentDoc = (filteredData || []).find(x => String(x['Quotation #'] || '').trim() === String(mainKey || '').trim());
          const baseExt = String(parentDoc?.['External Quotation #'] || '').trim();
          const suffix = String(quote || '').match(/-\d+$/)?.[0] || '';
          const displayQ = (isSub && baseExt) ? (baseExt + suffix) : q;
          const r4 = document.createElement('tr');
          r4.className = 'row-truck-val';
          if (isSub) r4.classList.add('sub-row');

          // ===== Status (match SALES) =====
          const confirmed = scopeConfirmed(item, 'TRUCK');
          const costSent = isTruthy(item['truckingCostSent']);   // âœ… åªçœ‹ TRUCK
          const costSaved = isTruthy(item['truckingCostSaved']);
          const hasAnyCost = ['Base Rate', 'Chassis', 'Pre-Pull', 'Yard Storage', 'Driver Waiting', 'Over Weight', 'Chassis Split', 'Toll', 'Reefer Fee', 'Bond Fee']
            .some(k => (num(item[k]) || 0) > 0 || String(item[k] || '').trim() !== '');
          const isNew = !confirmed && !costSent && !costSaved && !hasAnyCost;

          if (confirmed) r4.classList.add('row-confirmed');
          else if (costSent) r4.classList.add('row-sent');
          else if (isNew) r4.classList.add('new-inquiry');

          if (costSaved && !costSent && !confirmed) r4.classList.add('cost-saved');

          const lockedTruck = lockState(item, 'TRUCK');


          r4.appendChild(tdCell(displayQ, 'text-left font-semibold'));


          const brInp = makeInput(item['Base Rate'] || '', 'Base Rate', quote, lockedTruck, 'TRUCK');
          const tdBr = document.createElement('td'); tdBr.appendChild(brInp); r4.appendChild(tdBr);

          r4.appendChild(tdCell('â€”')); r4.appendChild(tdCell('â€”')); r4.appendChild(tdCell('â€”')); r4.appendChild(tdCell('â€”'));

          ['Chassis', 'Pre-Pull', 'Yard Storage', 'Driver Waiting', 'Over Weight', 'Chassis Split', 'Toll', 'Reefer Fee', 'Bond Fee'].forEach(cF => {
            const ci = makeInput(item[cF] ?? '', cF, quote, lockedTruck, 'TRUCK');
            const tc = document.createElement('td'); tc.appendChild(ci); r4.appendChild(tc);
            r4.appendChild(tdCell('â€”'));
          });

          const carrierInp = makeInput(item['Carrier'] || '', 'Carrier', quote, lockedTruck, 'TRUCK', true);
          const tdCar = document.createElement('td'); tdCar.appendChild(carrierInp); r4.appendChild(tdCar);

          // âœ… Vendor Note (Column 26) â€” only Sourcing can edit/save
          const vendorNoteFull = String(item['Vendor Note'] || item['Carrier Note'] || '').trim();
          const cleanNote = vendorNoteFull.replace(/\s+/g, ' ').trim();
          const vendorNotePreview = cleanNote.length > 20
            ? cleanNote.substring(0, 20) + '...'
            : cleanNote;

          const tNote = tdCell(vendorNotePreview, 'text-left note-preview vendor-note-preview');
          tNote.dataset.fullNote = vendorNoteFull;
          tNote.dataset.which = 'VENDOR NOTE';

          // âœ… allow modal to save Vendor Note (server already restricts to sourcing)
          tNote.dataset.quote = quote;
          tNote.dataset.field = 'Vendor Note';

          r4.appendChild(tNote);

          r4.appendChild(actionCellTruck(item, quote, mainKey));
          return r4;
        }

        function renderWhRow(item, quote, isSub, mainKey) {
          const q = String(quote || '').trim();
          const parentDoc = (filteredData || []).find(x => String(x['Quotation #'] || '').trim() === String(mainKey || '').trim());
          const baseExt = String(parentDoc?.['External Quotation #'] || '').trim();
          const suffix = String(quote || '').match(/-[A-Z]$/i)?.[0] || '';
          const displayQ = (isSub && baseExt) ? (baseExt + suffix) : (isSub ? q : '');

          const r6 = document.createElement('tr');
          r6.className = 'row-wh-val';
          if (isSub) r6.classList.add('sub-row');

          // ===== Status (match SALES) =====
          const confirmed = scopeConfirmed(item, 'WH');
          const costSent = isTruthy(item['warehouseCostSent']);  // âœ… åªçœ‹ WH
          const costSaved = isTruthy(item['warehouseCostSaved']);
          const hasAnyCost = ['Order Processing', 'Inbound', 'Sorting', 'Palletizing', 'Pallet Fee', 'Storage', 'Outbound']
            .some(k => (num(item[k]) || 0) > 0 || String(item[k] || '').trim() !== '');
          const isNew = !confirmed && !costSent && !costSaved && !hasAnyCost;

          if (confirmed) r6.classList.add('row-confirmed');
          else if (costSent) r6.classList.add('row-sent');
          else if (isNew) r6.classList.add('new-inquiry');

          if (costSaved && !costSent && !confirmed) r6.classList.add('cost-saved');

          const lockedWH = lockState(item, 'WH');

          r6.appendChild(tdCell(displayQ, 'text-left font-semibold'));

          // 7ä¸ªCost + æ¯ä¸ªåé¢ä¸€ä¸ª â€œâ€”â€ Price å ä½ï¼ˆä½ åŸé€»è¾‘ï¼‰
          ['Order Processing', 'Inbound', 'Sorting', 'Palletizing', 'Pallet Fee', 'Storage', 'Outbound'].forEach(cF => {
            const ci = makeInput(item[cF] ?? '', cF, quote, lockedWH, 'WH');
            const tc = document.createElement('td');
            tc.appendChild(ci);
            r6.appendChild(tc);
            r6.appendChild(tdCell('â€”'));
          });

          // âœ… (WH) Column 16: Vendor (æ¢å¤è¿™ä¸€æ ¼)
          const vendorInp = makeInput(item['Vendor'] || '', 'Vendor', quote, lockedWH, 'WH', true);
          const tdVen = document.createElement('td');
          tdVen.appendChild(vendorInp);
          r6.appendChild(tdVen);

          // âœ… (WH) Column 17: blank placeholder (ä¿æŒç•™ç™½)
          r6.appendChild(tdCell(''));

          // ===== Warehouse Requirement summary (from Inquiry form fields) =====
          const needWH = String(item['Need Warehouse Service'] || '').toLowerCase().trim() === 'true';

          const whServices = String(item['Warehouse Services'] || '').trim();
          const whDetail = String(item['Warehouse Service Detail'] || '').trim();
          const estPallets = String(item['Estimated Pallets'] || '').trim();
          const estBoxes = String(item['Estimated Boxes / Cartons'] || item['Estimated Boxes'] || '').trim();
          const estSku = String(item['Estimated SKU Count'] || '').trim();
          const dur = String(item['Storage Duration'] || '').trim();
          const durUnit = String(item['Storage Duration Unit'] || item['Duration Unit'] || '').trim();

          const warehouseNote = String(item['Warehouse Note'] || '').trim();
          const salesNote = String(item['Note'] || '').trim();

          const lines = [];

          // ===== Icons (same as Sales/Manager) =====
          const icon = (on, emoji) => (String(on || '').toLowerCase().trim() === 'true' ? emoji : '');
          const needWHIcon = icon(item['Need Warehouse Service'], 'ğŸ¬');
          const haz = icon(item['Hazmat'], 'â˜¢ï¸');
          const ree = icon(item['Reefer'], 'â„ï¸');
          const bon = icon(item['Bonded'], 'ğŸ”’');

          const iconLine = [needWHIcon, haz, ree, bon].filter(Boolean).join(' ');
          if (iconLine) lines.push(iconLine);

          // ===== Services line (prefer detail with qty/unit) =====
          if (needWH) {
            if (whDetail) lines.push(whDetail);
            else if (whServices) {
              const list = whServices
                .split(';')
                .map(s => s.trim())
                .filter(Boolean);
              if (list.length) lines.push(list.map(s => `âœ… ${s}`).join(' '));
            }

            // Estimated
            const estParts = [];
            if (estPallets) estParts.push(`Pallets ${estPallets}`);
            if (estBoxes) estParts.push(`Boxes ${estBoxes}`);
            if (estSku) estParts.push(`SKU ${estSku}`);
            if (estParts.length) lines.push('Est: ' + estParts.join(', '));

            // Duration
            if (dur || durUnit) lines.push('Storage: ' + [dur, durUnit].filter(Boolean).join(' '));
          }

          // Warehouse Note (Inquiry)
          if (warehouseNote) lines.push(`WH Note: ${warehouseNote}`);

          // Sales Note (General Note)
          if (salesNote) lines.push(`Sales Note: ${salesNote}`);

          const whFull = lines.filter(Boolean).join('\n');
          const whPreview = whFull.replace(/\s+/g, ' ').trim();

          const whNoteTd = tdCell('', 'text-left note-preview');
          whNoteTd.colSpan = 8;            // âœ… 18~25
          whNoteTd.dataset.fullNote = whFull;
          whNoteTd.dataset.which = 'WAREHOUSE NOTE';
          whNoteTd.dataset.quote = String(quote || '').trim();  // å½“å‰è¡Œ quoteï¼ˆä¸»è¡Œ/å­è¡Œéƒ½èƒ½å­˜ï¼‰
          whNoteTd.dataset.field = 'Warehouse Note';

          const line2 = document.createElement('div');
          line2.className = 'note-line';
          line2.textContent = whPreview;
          whNoteTd.appendChild(line2);

          r6.appendChild(whNoteTd);
          // âœ… Vendor Note (Column 26) â€” only Sourcing can edit/save
          const vendorNoteFull = String(item['Vendor Note'] || item['Carrier Note'] || '').trim();
          const cleanNote = vendorNoteFull.replace(/\s+/g, ' ').trim();
          const vendorNotePreview = cleanNote.length > 20 ? cleanNote.substring(0, 20) + '...' : cleanNote;

          const vNoteTd = tdCell(vendorNotePreview, 'text-left note-preview vendor-note-preview');
          vNoteTd.dataset.fullNote = vendorNoteFull;
          vNoteTd.dataset.which = 'VENDOR NOTE';

          vNoteTd.dataset.quote = quote;
          vNoteTd.dataset.field = 'Vendor Note';

          r6.appendChild(vNoteTd);
          r6.appendChild(actionCellWH(item, quote, mainKey)); // ç¬¬27æ  Action
          return r6;
        }   // âœ… è¿™ä¸€è¡Œä½ å¿…é¡»åŠ 

        async function addSubLine(parentQuote, scope) {
          if (!confirm(`ç¢ºå®šæ–°å¢ä¸€æ¢ ${scope} å­æˆæœ¬è¡Œï¼Ÿ`)) return;

          // è¨ˆç®—æ–°ç·¨è™Ÿå¾Œç¶´
          const currentSubs = await loadInquiries();
          const subLines = currentSubs.filter(i => i['Parent Quotation #'] === parentQuote && i.Type === scope);
          let suffix;
          if (scope === 'TRUCK') {
            suffix = '-' + (subLines.length + 1);
          } else {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            suffix = '-' + letters[subLines.length];
          }
          const newQuote = parentQuote + suffix;

          // åªæ–°å¢æˆæœ¬ç›¸é—œæ¬„ä½ï¼ˆä¸å¸¶åŸºæœ¬è³‡è¨Šï¼‰
          const newItem = {
            "Quotation #": newQuote,
            "Parent Quotation #": parentQuote,
            "Type": scope,
            // æˆæœ¬æ¬„ä½é è¨­ç©ºï¼ˆä½¿ç”¨è€…å¡«ï¼‰
            "Chassis": "",
            "Pre-Pull": "",
            "Yard Storage": "",
            "Driver Waiting": "",
            "Over Weight": "",
            "Chassis Split": "",
            "Toll": "",
            "Reefer Fee": "",
            "Bond Fee": "",
            "Carrier": "",
            "Order Processing": "",
            "Inbound": "",
            "Sorting": "",
            "Palletizing": "",
            "Pallet Fee": "",
            "Storage": "",
            "Outbound": "",
            "Vendor": "",
            "Note": "",
            "Selected": "false"
          };

          try {
            const response = await fetch('/inquiries', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(newItem)
            });

            if (response.ok) {
              alert(`æ–°å¢æˆåŠŸï¼š${newQuote}`);
              await loadInquiries(); // é‡æ–°è¼‰å…¥è¡¨æ ¼
            } else {
              alert('æ–°å¢å¤±æ•—');
            }
          } catch (err) {
            console.error('æ–°å¢éŒ¯èª¤:', err);
            alert('ç¶²è·¯éŒ¯èª¤');
          }
        }

        (function setupNoteViewerModal() {
          const modal = document.getElementById('noteModal');
          const input = document.getElementById('noteModalInput');
          const closeBtn = document.getElementById('noteModalClose');
          const saveBtn = document.getElementById('noteModalSave');
          const titleEl = modal?.querySelector('h2');
          if (!modal || !input) return;

          let activeTd = null;
          let activeQuote = '';
          let activeField = '';

          function openModal(td) {
            const which = td.dataset.which || 'NOTE';
            const text = td.dataset.fullNote || td.textContent || '';
            activeTd = td;
            activeQuote = String(td.dataset.quote || '').trim();
            activeField = String(td.dataset.field || '').trim();

            if (titleEl) titleEl.textContent = which;
            input.value = text;

            modal.classList.remove('hidden');
            document.body.classList.add('no-body-scroll');

            // æ²¡æœ‰ field çš„ NOTE åªå…è®¸çœ‹ï¼Œä¸å…è®¸å­˜
            if (!activeQuote || !activeField) {
              input.readOnly = true;
              saveBtn && (saveBtn.style.display = 'none');
            } else {
              input.readOnly = false;
              saveBtn && (saveBtn.style.display = 'inline-block');
            }
          }

          function closeModal() {
            modal.classList.add('hidden');
            document.body.classList.remove('no-body-scroll');
            input.value = '';
            activeTd = null;
            activeQuote = '';
            activeField = '';
          }

          async function saveModal() {
            if (!activeQuote || !activeField) return;

            const payload = {
              'Quotation #': activeQuote,
              'Saved': 'true',
              [activeField]: input.value || ''
            };

            const r = await postUpdate(payload);
            if (!r.ok) {
              alert('âŒ Save note failed: ' + (r.text || ''));
              return;
            }

            // âœ… æ›´æ–°å½“å‰æ ¼ï¼šä¸€è¡Œé¢„è§ˆ + fullNote
            if (activeTd) {
              const newText = input.value || '';
              activeTd.dataset.fullNote = newText;
              const preview = newText.replace(/\s+/g, ' ').trim();
              // noteTd å†…éƒ¨ä½ ç”¨äº† note-line div
              const line = activeTd.querySelector('.note-line');
              if (line) line.textContent = preview;
              else activeTd.textContent = preview;
            }

            closeModal();
          }

          closeBtn?.addEventListener('click', closeModal);
          saveBtn?.addEventListener('click', saveModal);

          modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
          });

          document.addEventListener('click', (e) => {
            const td = e.target.closest('#summaryTable td.note-preview');
            if (!td) return;
            openModal(td);
          });
        })();

        async function getCurrentUser() {
          const res = await fetch('/user');
          if (!res.ok) {
            alert('âŒ Not logged in. Please login again.');
            window.location.href = '/index.html';
            return;
          }
          const userInfo = await res.json();
          userRole = (userInfo.role || '').toLowerCase();
          currentUser = (userInfo.username || '').trim();

          if (userRole !== 'sourcing') {
            alert('âŒ Sourcing only.');
            window.location.href = '/index.html';
            return;
          }
          const nameEl = document.getElementById('usernameDisplay');
          if (nameEl) nameEl.textContent = currentUser;
        }

        async function loadInquiries() {
          try {
            const res = await fetch('/inquiries', { credentials: 'include' });
            const data = await res.json();
            if (!Array.isArray(data)) {
              console.error('Server did not return array:', data);
              alert('ğŸš¨ Inquiry data invalid.');
              return;
            }
            filteredData = data;

            filteredData = applySearchFilter(filteredData, searchTerm);
            renderPage();
          } catch (e) {
            console.error('Failed to load inquiries:', e);
            alert('ğŸš¨ Load failed.');
          }
        }

        document.addEventListener('DOMContentLoaded', async () => {
          await getCurrentUser();
          await loadInquiries();

          document.getElementById('prevPage')?.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderPage(); }
          });
          document.getElementById('nextPage')?.addEventListener('click', () => {
            const maxPage = Math.ceil((filteredData.length || 0) / pageSize) || 1;
            if (currentPage < maxPage) { currentPage++; renderPage(); }
          });
          document.getElementById('exitBtn')?.addEventListener('click', () => {
            window.location.href = '/logout';
          });

          document.getElementById('searchBtn')?.addEventListener('click', async () => {
            searchTerm = document.getElementById('searchBox')?.value || '';
            currentPage = 1;
            await loadInquiries();
          });

          document.getElementById('clearSearchBtn')?.addEventListener('click', async () => {
            const box = document.getElementById('searchBox');
            if (box) box.value = '';
            searchTerm = '';
            currentPage = 1;
            await loadInquiries();
          });
        });</script>
    </div>
  </div>
</body>

</html>